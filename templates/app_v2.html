<!DOCTYPE html>
<!-- TDS_VERSION:20241214_0521_FULLSAFE_REWRITE1 -->
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart TDS Pro</title>

    <script>
        (function () {
            window.onerror = function (msg, url, line) {
                try {
                    if (msg && String(msg).indexOf('ResizeObserver') >= 0) return;
                    var loading = document.querySelector('.global-loader');
                    if (loading) {
                        loading.innerHTML = '<div class="text-danger p-4" style="text-align:center">'
                            + '<h3>⚠️ 资源加载失败</h3>'
                            + '<p>建议刷新重试。<br><small>' + String(msg || '') + '</small></p>'
                            + '<button class="btn btn-primary" onclick="location.reload()">刷新</button>'
                            + '</div>';
                    }
                } catch (e) { }
            };
        })();
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='https://cdn.staticfile.org/bootstrap/5.3.0/css/bootstrap.min.css'">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='https://cdn.staticfile.org/sweetalert2/11.7.12/sweetalert2.min.css'">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css" rel="stylesheet"
        onerror="this.onerror=null;this.href='https://cdn.staticfile.org/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css'">

    <style>
        :root {
            --bg-body: #f4f6f9;
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-header: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --hover-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --brand-primary: #0d6efd;
            --brand-primary-2: #2563eb;
            --brand-gradient: linear-gradient(135deg, #2563eb, #7c3aed);
            --brand-soft: rgba(37, 99, 235, 0.12);
            --shadow-xs: 0 1px 2px rgba(16, 24, 40, .06);
            --shadow-sm: 0 6px 18px rgba(16, 24, 40, .08);
            --shadow-md: 0 18px 50px rgba(16, 24, 40, .14);
            --radius-sm: 12px;
            --radius-md: 16px;
            --sidebar-width: 260px;
            --placeholder-color: #6c757d;
            --fs-base: 15px;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-sidebar: #1e1e1e;
            --bg-card: #1e1e1e;
            --bg-header: #252525;
            --text-main: #e0e0e0;
            --text-muted: #adb5bd;
            --border-color: #333333;
            --hover-bg: #2d2d2d;
            --input-bg: #252525;
            --input-border: #495057;
            --brand-primary: #6ea8fe;
            --brand-primary-2: #93c5fd;
            --brand-gradient: linear-gradient(135deg, #60a5fa, #a78bfa);
            --brand-soft: rgba(110, 168, 254, 0.16);
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, .35);
            --shadow-sm: 0 10px 24px rgba(0, 0, 0, .25);
            --shadow-md: 0 28px 70px rgba(0, 0, 0, .35);
            --invert: 1;
            --placeholder-color: #888888;
        }

        body {
            background:
                radial-gradient(1200px circle at 12% 8%, rgba(37, 99, 235, .10), transparent 55%),
                radial-gradient(900px circle at 88% 18%, rgba(124, 58, 237, .10), transparent 55%),
                radial-gradient(900px circle at 50% 95%, rgba(16, 185, 129, .08), transparent 55%),
                var(--bg-body);
            color: var(--text-main);
            font-family: system-ui, -apple-system, sans-serif;
            font-size: var(--fs-base);
            transition: background 0.4s ease, color 0.4s ease;
            overflow-x: hidden;
        }

        [data-theme="dark"] body {
            background:
                radial-gradient(1200px circle at 12% 8%, rgba(96, 165, 250, .16), transparent 55%),
                radial-gradient(900px circle at 88% 18%, rgba(167, 139, 250, .14), transparent 55%),
                radial-gradient(900px circle at 50% 95%, rgba(34, 197, 94, .10), transparent 55%),
                var(--bg-body);
        }

        /* 禁止侧边栏打开时body滚动 */
        body.sidebar-locked {
            overflow: hidden;
        }

        /* 侧边栏样式 */
        .sidebar {
            height: 100vh;
            background: linear-gradient(180deg, rgba(255, 255, 255, .94), rgba(255, 255, 255, .88));
            border-right: 1px solid var(--border-color);
            width: var(--sidebar-width);
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            transition: transform 0.24s cubic-bezier(.22, 1, .36, 1);
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
            will-change: transform;
        }

        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, rgba(30, 30, 30, .92), rgba(30, 30, 30, .86));
        }

        /* 遮罩层 */
        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1090;
            display: none;
            backdrop-filter: blur(2px);
        }

        .sidebar-backdrop.show {
            display: block;
        }

        .nav-link {
            color: var(--text-muted);
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 4px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            transition: background-color .18s ease, color .18s ease, transform .18s ease;
        }

        .nav-link i {
            font-size: 1.2rem;
            margin-right: 12px;
        }

        .nav-link:hover {
            background-color: var(--hover-bg);
            color: var(--brand-primary);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background: var(--brand-soft);
            color: var(--brand-primary);
            font-weight: 650;
            box-shadow: var(--shadow-xs);
        }

        /* 主内容区域 */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            min-height: 100vh;
            width: auto;
            transition: margin-left 0.3s ease;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-xs);
            color: var(--text-main);
            margin-bottom: 1rem;
        }

        .card-header {
            background-color: var(--bg-header);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            font-weight: 600;
        }

        /* 表格样式 */
        .custom-table {
            background: var(--bg-card);
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .table {
            --bs-table-color: var(--text-main);
            --bs-table-bg: var(--bg-card);
            --bs-table-border-color: var(--border-color);
            --bs-table-hover-bg: var(--hover-bg);
            margin-bottom: 0;
            white-space: nowrap;
            /* 默认不换行，保持整洁 */
        }

        .table th,
        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .table th {
            background-color: var(--bg-header);
            font-weight: 600;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        /* 表单控件 */
        .form-control,
        .form-select {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-main) !important;
            border-radius: 12px;
            box-shadow: none;
            transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
        }

        .form-control::placeholder {
            color: var(--placeholder-color) !important;
            opacity: 1;
        }

        .form-control:disabled,
        .form-control[readonly],
        .form-select:disabled,
        .form-select[readonly] {
            opacity: 1;
            color: var(--text-muted) !important;
            background-color: var(--hover-bg) !important;
        }

        .form-control:focus {
            border-color: var(--brand-primary) !important;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.18);
        }

        .input-group-text {
            background-color: var(--hover-bg);
            border-color: var(--input-border);
            color: var(--text-main);
        }

        .view-btn {
            cursor: pointer;
            padding: 8px 14px;
            border-radius: 10px;
            color: var(--text-muted);
            border: 1px solid transparent;
        }

        .view-btn:hover {
            background: var(--hover-bg);
        }

        .view-btn.active {
            background: var(--bg-card);
            color: var(--brand-primary);
            border-color: var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .modal-content {
            background-color: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .modal-header,
        .modal-footer {
            border-color: var(--border-color);
        }

        .btn-close {
            filter: invert(var(--invert, 0));
        }

        .link-modal .modal-header h5 {
            font-weight: 750;
            margin-bottom: 0;
        }

        .link-modal .section-title {
            font-weight: 750;
            margin-bottom: .75rem;
        }

        .link-modal .form-label {
            font-size: 12px;
            font-weight: 650;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .link-modal label {
            font-size: 12px;
            font-weight: 650;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .link-modal .modal-body {
            padding-bottom: 86px;
        }

        .link-modal .modal-footer {
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: var(--bg-card);
            z-index: 5;
            box-shadow: 0 -10px 24px rgba(16, 24, 40, .08);
        }

        [data-theme="dark"] .link-modal .modal-footer {
            box-shadow: 0 -16px 34px rgba(0, 0, 0, .28);
        }

        .link-modal details {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 12px;
            background: var(--bg-card);
        }

        .link-modal details+details {
            margin-top: 10px;
        }

        .link-modal summary {
            list-style: none;
            outline: none;
        }

        .link-modal summary::-webkit-details-marker {
            display: none;
        }

        .link-modal .link-details-summary {
            cursor: pointer;
            user-select: none;
        }

        .link-modal .link-details-summary .chev {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .link-modal details[open] .link-details-summary .chev {
            transform: rotate(90deg);
            transition: transform .16s ease;
        }

        @media (max-width: 576px) {
            .link-modal .modal-footer .btn {
                flex: 1 1 0;
            }
        }

        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(1200px circle at 12% 8%, rgba(96, 165, 250, .12), transparent 55%),
                radial-gradient(900px circle at 88% 18%, rgba(124, 58, 237, .10), transparent 55%),
                radial-gradient(900px circle at 50% 95%, rgba(16, 185, 129, .08), transparent 55%),
                var(--bg-body);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(6px);
            opacity: 1;
            transition: opacity .25s ease;
            will-change: opacity;
        }

        .global-loader .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: .35rem;
        }

        .btn.btn-primary {
            background: var(--brand-gradient);
            border: 0;
            box-shadow: 0 12px 26px rgba(37, 99, 235, .22);
            border-radius: 14px;
            transition: transform .2s cubic-bezier(.22, 1, .36, 1), filter .2s ease, box-shadow .2s ease;
            will-change: transform, box-shadow, filter;
        }

        .btn.btn-primary:hover {
            filter: brightness(1.02);
            transform: translateY(-1px);
            box-shadow: 0 16px 34px rgba(37, 99, 235, .26);
        }

        .btn.btn-primary:active {
            transform: translateY(0px) scale(.995);
        }

        .btn.btn-outline-secondary,
        .btn.btn-outline-danger,
        .btn.btn-outline-primary {
            border-radius: 12px;
        }

        .btn-icon-only {
            width: 34px;
            height: 34px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .btn-icon-text {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn-icon-text i {
            line-height: 1;
        }

        .btn.btn-outline-secondary:hover,
        .btn.btn-outline-primary:hover,
        .btn.btn-outline-danger:hover {
            background: var(--hover-bg);
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.18);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

        .keyboard-hint {
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: ui-monospace, monospace;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        .list-enter-active {
            animation: fadeInUp 0.32s cubic-bezier(.22, 1, .36, 1);
        }

        .list-leave-active {
            animation: fadeOutDown 0.26s cubic-bezier(.22, 1, .36, 1);
        }

        .card.link-item {
            animation: fadeInUp 0.32s cubic-bezier(.22, 1, .36, 1);
            animation-fill-mode: both;
            transition: transform 0.22s cubic-bezier(.22, 1, .36, 1), box-shadow 0.22s ease;
        }

        .card.link-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(16, 24, 40, .12);
        }

        [data-theme="dark"] .card.link-item:hover {
            box-shadow: 0 16px 40px rgba(0, 0, 0, .35);
        }

        .card.link-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .card.link-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .card.link-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .card.link-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .card.link-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .card.link-item:nth-child(6) {
            animation-delay: 0.3s;
        }

        .card.link-item.deleting {
            animation: slideOutLeft 0.3s ease-out forwards;
        }

        .page-transition-enter-active,
        .page-transition-leave-active {
            transition: opacity 0.22s cubic-bezier(.22, 1, .36, 1);
        }

        .page-transition-enter-from,
        .page-transition-leave-to {
            opacity: 0;
        }

        .swipe-container {
            position: relative;
            overflow: hidden;
        }

        .swipe-content {
            position: relative;
            transition: transform 0.22s cubic-bezier(.22, 1, .36, 1);
            background: var(--card-bg);
            z-index: 2;
            will-change: transform;
        }

        .swipe-content.swiping {
            transition: none;
        }

        .swipe-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            z-index: 1;
        }

        .swipe-action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .swipe-action-btn.delete {
            background: #ef4444;
        }

        .swipe-action-btn.edit {
            background: #3b82f6;
        }

        @media (min-width: 992px) {
            .swipe-container {
                overflow: visible;
            }

            .swipe-actions {
                display: none;
            }
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 10px;
        }

        [data-theme="dark"] .skeleton {
            background: rgba(255, 255, 255, 0.08);
        }

        .skeleton::after {
            content: '';
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.30), transparent);
            animation: shimmer 1.15s infinite;
        }

        [data-theme="dark"] .skeleton::after {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.14), transparent);
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .sk-line {
            height: 12px;
        }

        .sk-line.sm {
            height: 10px;
        }

        .sk-pill {
            height: 26px;
            border-radius: 999px;
        }

        .table-skeleton {
            padding: 12px 16px;
        }

        .table-skeleton-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: 12px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .table-skeleton-row:last-child {
            border-bottom: none;
        }

        .glass-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .86), rgba(255, 255, 255, .78));
            backdrop-filter: blur(12px);
        }

        [data-theme="dark"] .glass-card {
            background: linear-gradient(180deg, rgba(24, 24, 27, .86), rgba(24, 24, 27, .78));
        }

        .loading-rail {
            position: relative;
            height: 4px;
            width: 100%;
            overflow: hidden;
            background: var(--hover-bg);
            border-radius: 999px;
            margin-bottom: 10px;
        }

        .loading-bar {
            position: absolute;
            left: -30%;
            top: 0;
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, rgba(59, 130, 246, .1), rgba(59, 130, 246, .65), rgba(124, 58, 237, .7));
            animation: loadingBar 1s infinite;
        }

        @keyframes loadingBar {
            0% {
                left: -30%;
            }

            100% {
                left: 100%;
            }
        }

        .user-card {
            overflow: hidden;
        }

        .user-loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, rgba(14, 165, 233, .12), rgba(124, 58, 237, .10), rgba(34, 197, 94, .10));
            z-index: 2;
        }

        .glow-dot {
            width: 12px;
            height: 12px;
            margin: 0 auto;
            border-radius: 50%;
            background: radial-gradient(circle, #22d3ee 0%, #0ea5e9 60%, rgba(14, 165, 233, 0) 70%);
            box-shadow: 0 0 18px rgba(34, 211, 238, .8), 0 0 30px rgba(124, 58, 237, .5);
            animation: pulseGlow 1.4s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0% {
                transform: scale(.9);
                opacity: .8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(.9);
                opacity: .8;
            }
        }

        .advanced-filter-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .filter-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-col {
            flex: 1;
            min-width: 180px;
        }

        .filter-col label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            display: block;
        }

        .filter-preset-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid var(--border-color);
            background: var(--hover-bg);
            cursor: pointer;
            transition: transform .18s ease, background-color .18s ease, color .18s ease, border-color .18s ease;
            will-change: transform;
        }

        .filter-preset-chip:hover {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
            transform: translateY(-1px);
        }

        .filter-preset-chip.active {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
        }

        .auth-wrap {
            background:
                radial-gradient(1000px circle at 20% 15%, rgba(96, 165, 250, .14), transparent 55%),
                radial-gradient(800px circle at 82% 10%, rgba(167, 139, 250, .12), transparent 55%),
                radial-gradient(1100px circle at 40% 90%, rgba(34, 197, 94, .10), transparent 60%),
                var(--bg-body);
        }

        .auth-card {
            border-radius: var(--radius-md) !important;
            background: linear-gradient(180deg, rgba(255, 255, 255, .92), rgba(255, 255, 255, .86)) !important;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-md) !important;
        }

        [data-theme="dark"] .auth-card {
            background: linear-gradient(180deg, rgba(30, 30, 30, .92), rgba(30, 30, 30, .86)) !important;
        }

        .auth-brand {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--brand-gradient);
            box-shadow: 0 18px 40px rgba(37, 99, 235, .22);
            color: #fff;
        }

        .auth-brand i {
            color: #fff !important;
        }

        .copy-btn {
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s, transform 0.2s;
            margin-left: 8px;
        }

        .copy-btn:hover {
            color: var(--brand-primary);
            transform: scale(1.15);
        }

        .copy-btn.copied {
            color: #22c55e;
            animation: copySuccess 0.4s ease;
        }

        @keyframes copySuccess {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Enhanced stat badges */
        .stat-badge-pv {
            background: linear-gradient(135deg, rgba(59, 130, 246, .15), rgba(37, 99, 235, .08));
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, .25);
        }

        .stat-badge-uv {
            background: linear-gradient(135deg, rgba(34, 197, 94, .15), rgba(22, 163, 74, .08));
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, .25);
        }

        [data-theme="dark"] .stat-badge-pv {
            background: linear-gradient(135deg, rgba(96, 165, 250, .2), rgba(59, 130, 246, .1));
            color: #93c5fd;
        }

        [data-theme="dark"] .stat-badge-uv {
            background: linear-gradient(135deg, rgba(74, 222, 128, .2), rgba(34, 197, 94, .1));
            color: #86efac;
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background-color: #198754;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        [v-cloak] {
            display: none;
        }

        .jump-settings {
            background-color: #f0f4ff;
            border: 1px solid #d0d7de;
        }

        [data-theme="dark"] .jump-settings {
            background-color: #2a2a2a !important;
            border-color: #444 !important;
        }

        /* 通用文本截断 */
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            white-space: normal;
        }

        .stats-card-bg {
            background:
                linear-gradient(135deg, rgba(13, 110, 253, .10), rgba(124, 58, 237, .08));
            border: 1px solid rgba(0, 0, 0, .06);
            box-shadow: 0 10px 28px rgba(16, 24, 40, .08);
        }

        [data-theme="dark"] .stats-card-bg {
            background:
                linear-gradient(135deg, rgba(110, 168, 254, .16), rgba(167, 139, 250, .10));
            border: 1px solid rgba(255, 255, 255, .08);
            box-shadow: 0 18px 50px rgba(0, 0, 0, .32);
        }

        [data-theme="dark"] .modal-content {
            background: linear-gradient(180deg, rgba(30, 30, 30, .92), rgba(30, 30, 30, .86));
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .table tr {
            box-shadow: 0 10px 24px rgba(0, 0, 0, .28);
        }

        [data-theme="dark"] .swal2-popup {
            background: linear-gradient(180deg, rgba(30, 30, 30, .92), rgba(30, 30, 30, .86)) !important;
            color: var(--text-main) !important;
            border: 1px solid rgba(255, 255, 255, .10) !important;
            box-shadow: var(--shadow-md) !important;
        }

        [data-theme="dark"] .swal2-title,
        [data-theme="dark"] .swal2-html-container {
            color: var(--text-main) !important;
        }

        [data-theme="dark"] .swal2-input,
        [data-theme="dark"] .swal2-textarea,
        [data-theme="dark"] .swal2-select {
            background: var(--input-bg) !important;
            color: var(--text-main) !important;
            border-color: var(--input-border) !important;
        }

        .ui-state {
            padding: 2.2rem 1.25rem;
            text-align: center;
            color: var(--text-muted);
        }

        .ui-state .ui-state-icon {
            font-size: 2.2rem;
            opacity: .65;
            margin-bottom: .5rem;
        }

        .ui-state .ui-state-title {
            color: var(--text-main);
            font-weight: 750;
            margin-bottom: .35rem;
        }

        .ui-state .ui-state-desc {
            font-size: 13px;
        }

        /* ----- 响应式核心 CSS ----- */

        /* 1. 适配 992px 以下 (平板/手机) */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                /* 默认隐藏 */
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                transform: translateX(0);
                /* 激活时显示 */
            }

            .main-content {
                margin-left: 0;
                /* 内容占满全屏 */
                padding: 1rem;
            }

            .navbar-toggler {
                display: block;
            }
        }

        /* 2. 适配 576px 以下 (手机) */
        @media (max-width: 576px) {

            /* 顶部工具栏换行 */
            .toolbar-container {
                flex-direction: column;
                align-items: stretch !important;
            }

            .toolbar-search {
                width: 100% !important;
                margin: 0 !important;
            }

            .toolbar-actions {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .toolbar-actions .form-check {
                width: 100%;
            }

            .toolbar-actions .form-select {
                width: 100% !important;
            }

            .toolbar-actions .d-flex.gap-2 {
                width: 100%;
                justify-content: space-between;
            }

            /* 表格变卡片模式 */
            .table thead {
                display: none;
            }

            .table,
            .table tbody,
            .table tr,
            .table td {
                display: block;
                width: 100%;
            }

            .table tr {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            .table td {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                /* 对齐顶部 */
                gap: 12px;
                padding: 8px 0;
                border-bottom: 1px solid var(--hover-bg);
                text-align: right;
                white-space: normal;
                /* 允许换行 */
                word-break: break-all;
                /* 强制长单词换行 */
            }

            .table td:last-child {
                border-bottom: 0;
            }

            .table td::before {
                content: attr(data-label);
                font-weight: 650;
                font-size: 12px;
                color: var(--text-muted);
                opacity: .85;
                margin-right: 12px;
                flex: 0 0 auto;
                /* 标签不缩放 */
                text-align: left;
                white-space: nowrap;
            }

            /* 图表高度自适应 */
            .chart-container-lg {
                height: 300px !important;
            }

            .chart-container-sm {
                height: 200px !important;
            }

            /* 模态框全屏 */
            .modal-dialog {
                margin: 0.5rem;
            }

            .table-actions {
                justify-content: flex-end;
                flex-wrap: wrap;
                gap: 8px;
            }
        }
    </style>

    <script>
        (function () {
            function showLoaderError(msg) {
                try {
                    var loading = document.querySelector('.global-loader');
                    if (loading) {
                        loading.innerHTML = '<div class="text-danger p-4" style="text-align:center"><h3>⚠️ 资源加载失败</h3><p>建议刷新重试。<br><small>' + String(msg || '') + '</small></p><button class="btn btn-primary" onclick="location.reload()">刷新</button></div>';
                    }
                } catch (e) { }
            }

            function loadScript(url) {
                return new Promise(function (resolve, reject) {
                    var s = document.createElement('script');
                    s.src = url;
                    s.async = false;
                    s.onload = function () { resolve(); };
                    s.onerror = function () { reject(new Error('Load failed: ' + url)); };
                    document.head.appendChild(s);
                });
            }

            async function loadWithFallback(name, testFn, urls) {
                try { if (testFn()) return; } catch (e) { }
                for (var i = 0; i < urls.length; i++) {
                    try {
                        await loadScript(urls[i]);
                        if (testFn()) return;
                    } catch (e) {
                        if (i === urls.length - 1) throw e;
                    }
                }
                throw new Error('Failed to load ' + name);
            }

            async function main() {
                try {
                    var ASSET_VER = Date.now();
                    await loadWithFallback('Vue', function () { return window.Vue && window.Vue.createApp; }, [
                        '/static/vendor/vue.global.prod.js?_v=' + ASSET_VER,
                        'https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js',
                        'https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js',
                        'https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js'
                    ]);
                    await loadWithFallback('Axios', function () { return window.axios; }, [
                        '/static/vendor/axios.min.js?_v=' + ASSET_VER,
                        'https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js',
                        'https://unpkg.com/axios@1.4.0/dist/axios.min.js',
                        'https://cdn.staticfile.org/axios/1.4.0/axios.min.js'
                    ]);
                    await loadWithFallback('ECharts', function () { return window.echarts; }, [
                        '/static/vendor/echarts.min.js?_v=' + ASSET_VER,
                        'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',
                        'https://unpkg.com/echarts@5.4.3/dist/echarts.min.js',
                        'https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js'
                    ]);
                    await loadWithFallback('ECharts World Map', function () {
                        try { return window.echarts && window.echarts.getMap && window.echarts.getMap('world'); } catch (e) { return false; }
                    }, [
                        '/static/vendor/world.js?_v=' + ASSET_VER,
                        'https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js',
                        'https://unpkg.com/echarts@4.9.0/map/js/world.js',
                        'https://cdn.staticfile.org/echarts/4.9.0/map/js/world.js'
                    ]);
                    await loadWithFallback('SweetAlert2', function () { return window.Swal && window.Swal.fire; }, [
                        '/static/vendor/sweetalert2.all.min.js?_v=' + ASSET_VER,
                        'https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js',
                        'https://unpkg.com/sweetalert2@11/dist/sweetalert2.all.min.js',
                        'https://cdn.staticfile.org/sweetalert2/11.7.12/sweetalert2.all.min.js'
                    ]);

                    window.__LIBS_READY__ = true;
                    try { window.dispatchEvent(new Event('libs-ready')); } catch (e) { }
                } catch (e) {
                    showLoaderError((e && e.message) ? e.message : e);
                }
            }

            setTimeout(function () {
                if (!window.__LIBS_READY__) {
                    showLoaderError('CDN 加载超时（Vue/Axios 等资源未能下载）');
                }
            }, 12000);

            main();
        })();
    </script>
</head>

<body>

    <div id="static-loader" class="global-loader">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3 text-muted small">正在连接系统...</div>
    </div>

    <div id="app" v-cloak>
        <!-- 侧边栏遮罩 -->
        <div class="sidebar-backdrop" :class="{show: sidebarOpen}" @click="sidebarOpen=false"></div>

        <div v-if="initLoading" class="container d-flex justify-content-center align-items-center vh-100 p-3 auth-wrap">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-3 text-muted small">正在加载...</div>
            </div>
        </div>

        <!-- 登录/注册页 -->
        <div v-if="!initLoading && !user"
            class="container d-flex justify-content-center align-items-center vh-100 p-3 auth-wrap">
            <!-- 修改点：添加 max-width 和 width-100 -->
            <div class="card p-4 p-md-5 shadow-lg border-0 auth-card" style="max-width: 420px; width: 100%;">
                <div class="text-center mb-4">
                    <span class="auth-brand"><i class="bi bi-rocket-takeoff-fill display-6"></i></span>
                    <h3 class="fw-bold mt-2">Smart TDS</h3>
                </div>
                <ul class="nav nav-pills nav-fill mb-4 p-1 rounded" style="background:var(--hover-bg)">
                    <li class="nav-item"><button type="button" class="nav-link" :class="{active: authMode==='login'}"
                            @click.stop.prevent="setAuthMode('login')">登录</button></li>
                    <li class="nav-item"><button type="button" class="nav-link" :class="{active: authMode==='register'}"
                            @click.stop.prevent="setAuthMode('register')">注册</button></li>
                </ul>
                <form @submit.prevent="handleAuth">
                    <input v-model="authForm.username" class="form-control mb-3 py-2" placeholder="用户名"
                        autocomplete="username" required>
                    <input v-model="authForm.password" type="password" class="form-control mb-3 py-2" placeholder="密码"
                        autocomplete="current-password" required>
                    <input v-if="authMode==='register'" v-model="authForm.invite" class="form-control mb-3 py-2"
                        placeholder="邀请码">
                    <div class="input-group mb-2">
                        <span class="input-group-text fw-bold" style="cursor:pointer" @click="refreshCaptcha">{{
                            captchaQ }}</span>
                        <input v-model="authForm.captcha" class="form-control" placeholder="验证码答案" required>
                        <button class="btn btn-outline-secondary" type="button" @click="refreshCaptcha">刷新</button>
                    </div>
                    <div class="text-muted small mb-3">验证码为简单算术题：例如显示 "3 + 7 = ?"，这里填写 "10"。</div>
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold"
                        :disabled="authLoading">{{authMode==='login'?'登 录':'注 册'}}</button>
                </form>
            </div>
        </div>

        <!-- 二维码弹窗 -->
        <div class="modal fade" id="qrModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="mb-0">二维码</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center">
                            <div class="mb-2 text-muted small">手机扫码打开短链</div>
                            <div class="d-inline-block p-2 bg-white rounded-3 position-relative"
                                style="max-width: 280px;">
                                <div v-if="qrLoading"
                                    class="d-flex align-items-center justify-content-center position-absolute top-0 start-0"
                                    style="width: 260px; height: 260px;">
                                    <div class="spinner-border text-secondary" role="status"
                                        style="width:2rem;height:2rem;"></div>
                                </div>
                                <div v-if="qrError"
                                    class="d-flex align-items-center justify-content-center text-danger small position-absolute top-0 start-0"
                                    style="width: 260px; height: 260px; padding: 12px;">
                                    {{ qrError }}
                                </div>
                                <img :src="qrImgSrc" alt="QR" @load="onQrLoad" @error="onQrError"
                                    v-show="!!qrImgSrc && !qrError"
                                    style="width: 260px; height: 260px; object-fit: contain;" />
                            </div>
                            <div class="mt-3">
                                <div class="small text-muted text-break">{{ qrUrl }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">关闭</button>
                        <button class="btn btn-primary" type="button" @click="copyText(qrUrl)">复制链接</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主界面 -->
        <div v-if="user">
            <!-- 侧边栏 -->
            <div class="sidebar d-flex flex-column p-3" :class="{open: sidebarOpen}">
                <div class="fs-4 mb-4 px-3 mt-2 fw-bold d-flex justify-content-between align-items-center"
                    style="color:var(--brand-primary)">
                    <span><i class="bi bi-speedometer2 me-2"></i>TDS Pro</span>
                    <!-- 手机端关闭按钮 -->
                    <button class="btn btn-sm btn-link d-lg-none text-muted" @click="sidebarOpen=false"><i
                            class="bi bi-x-lg"></i></button>
                </div>
                <ul class="nav nav-pills flex-column mb-auto gap-1">
                    <li class="nav-item"><a href="#" class="nav-link" :class="{active: currentTab==='links'}"
                            @click="currentTab='links'; sidebarOpen=false;"><i class="bi bi-link-45deg"></i>短链管理</a>
                    </li>
                    <li class="nav-item"><a href="#" class="nav-link" :class="{active: currentTab==='profile'}"
                            @click="currentTab='profile'; sidebarOpen=false;"><i class="bi bi-person-gear"></i>账号设置</a>
                    </li>

                    <li v-if="safeUser.role==='admin' && simpleMode" class="nav-item">
                        <a href="#" class="nav-link" :class="{'active': adminMenuOpen}"
                            @click.prevent="adminMenuOpen=!adminMenuOpen">
                            <i class="bi" :class="adminMenuOpen ? 'bi-caret-down-fill' : 'bi-caret-right-fill'"></i>
                            更多（管理员）
                        </a>
                    </li>

                    <li v-if="safeUser.role==='admin' && (!simpleMode || adminMenuOpen)"><a href="#" class="nav-link"
                            :class="{active: currentTab==='all_links', 'ps-4': simpleMode}"
                            @click="currentTab='all_links'; sidebarOpen=false;"><i class="bi bi-collection"></i>全站短链</a>
                    </li>
                    <li v-if="safeUser.role==='admin' && (!simpleMode || adminMenuOpen)"><a href="#" class="nav-link"
                            :class="{active: currentTab==='domains', 'ps-4': simpleMode}"
                            @click="currentTab='domains'; sidebarOpen=false;"><i class="bi bi-globe"></i>域名管理</a></li>
                    <li v-if="safeUser.role==='admin' && (!simpleMode || adminMenuOpen)"><a href="#" class="nav-link"
                            :class="{active: currentTab==='invites', 'ps-4': simpleMode}"
                            @click="currentTab='invites'; sidebarOpen=false;"><i
                                class="bi bi-ticket-perforated"></i>邀请码</a></li>
                    <li v-if="safeUser.role==='admin' && (!simpleMode || adminMenuOpen)"><a href="#" class="nav-link"
                            :class="{active: currentTab==='users', 'ps-4': simpleMode}"
                            @click="currentTab='users'; sidebarOpen=false;"><i class="bi bi-people"></i>用户管理</a></li>
                    <li v-if="safeUser.role==='admin' && (!simpleMode || adminMenuOpen)"><a href="#" class="nav-link"
                            :class="{active: currentTab==='system', 'ps-4': simpleMode}"
                            @click="currentTab='system'; sidebarOpen=false;"><i class="bi bi-hdd-stack"></i>系统维护</a>
                    </li>
                </ul>
                <div class="mt-auto border-top pt-3 px-2">
                    <div class="mb-3">
                        <button class="btn btn-sm w-100 py-2 d-flex align-items-center justify-content-center"
                            style="background:var(--hover-bg);color:var(--text-main);border:1px solid var(--border-color)"
                            @click="toggleTheme">
                            <i class="bi me-2"
                                :class="isDark ? 'bi-sun-fill text-warning' : 'bi-moon-fill text-primary'"></i> {{
                            isDark ? '亮色模式' : '深色模式' }}
                        </button>
                        <button v-if="!autoTheme" class="btn btn-sm w-100 mt-2 py-1 text-muted"
                            style="background:transparent;border:1px dashed var(--border-color);font-size:0.75rem;"
                            @click="enableAutoTheme">
                            <i class="bi bi-clock me-1"></i>自动切换
                        </button>
                        <div v-else class="text-center mt-2 small text-muted">
                            <i class="bi bi-check-circle text-success me-1"></i>自动模式
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-2 small text-truncate"><strong>{{ (safeUser &&
                            safeUser.username) || '' }}</strong><span class="badge bg-secondary">{{ (links &&
                            links.length) || 0 }}/{{ (safeUser && safeUser.link_limit) || 0 }}</span></div>
                    <button class="btn btn-outline-danger w-100 btn-sm btn-icon-text" @click="logout"><i
                            class="bi bi-box-arrow-left me-1"></i>退出登录</button>
                </div>
            </div>

            <div class="main-content">
                <!-- 顶部导航栏 -->
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2 toolbar-container">
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-secondary d-lg-none me-1"
                            @click.stop="sidebarOpen = !sidebarOpen">
                            <i class="bi bi-list"></i>
                        </button>
                        <h4 class="fw-bold mb-0 text-truncate">{{ currentTabName }}
                            <span v-if="currentTab==='links' || currentTab==='all_links'"
                                class="badge bg-success bg-opacity-10 text-success ms-2 border border-success fw-normal"
                                style="font-size: 0.75rem;">
                                <span class="live-indicator"></span><span class="d-none d-sm-inline">实时</span>
                            </span>
                        </h4>
                    </div>

                    <div class="d-flex gap-2 align-items-center flex-wrap toolbar-actions"
                        v-if="currentTab==='links' || currentTab==='all_links'">
                        <div class="form-check form-switch mb-0" style="padding-left: 2.5em;">
                            <input class="form-check-input" type="checkbox" v-model="simpleMode" id="simpleModeSwitch">
                            <label class="form-check-label small text-muted" for="simpleModeSwitch">简易模式</label>
                        </div>
                        <div class="input-group shadow-sm toolbar-search" style="width: 250px;">
                            <span class="input-group-text border-end-0"><i class="bi bi-search"></i></span>
                            <input v-model="searchQuery" @input="debounceSearch" class="form-control border-start-0"
                                placeholder="搜索...">
                        </div>
                        <select v-model="filterType" class="form-select shadow-sm" style="width: 140px;">
                            <option value="all">全部类型</option>
                            <option value="jump">营销页</option>
                            <option value="direct">直连</option>
                        </select>
                        <select v-model="sortBy" class="form-select shadow-sm" style="width: 160px;">
                            <option value="created_desc">创建时间(新→旧)</option>
                            <option value="created_asc">创建时间(旧→新)</option>
                            <option value="pv_desc">PV(高→低)</option>
                            <option value="uv_desc">UV(高→低)</option>
                            <option value="slug_asc">Slug(A→Z)</option>
                        </select>
                        <button class="btn btn-outline-secondary shadow-sm btn-icon-text"
                            @click="advancedFilterOpen = !advancedFilterOpen"
                            :class="{active: hasActiveAdvancedFilters}">
                            <i class="bi bi-funnel me-1"></i><span class="d-none d-sm-inline">高级筛选</span>
                            <span v-if="hasActiveAdvancedFilters" class="badge bg-primary rounded-pill ms-1"
                                style="font-size:0.7rem;">{{ activeFilterCount }}</span>
                        </button>
                        <div class="d-flex gap-2">
                            <div class="p-1 rounded d-flex"
                                style="background:var(--hover-bg);border:1px solid var(--border-color)">
                                <div class="view-btn" :class="{active: viewMode==='grid'}" @click="switchView('grid')">
                                    <i class="bi bi-grid-fill"></i>
                                </div>
                                <div class="view-btn" :class="{active: viewMode==='list'}" @click="switchView('list')">
                                    <i class="bi bi-list-ul"></i>
                                </div>
                            </div>
                            <button class="btn btn-primary shadow-sm text-nowrap btn-icon-text" @click="openLinkModal()"
                                v-if="currentTab==='links'">
                                <i class="bi bi-plus-lg me-1"></i><span class="d-none d-sm-inline">新建</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div v-if="(currentTab==='links' || currentTab==='all_links') && loadingLinks && !isAutoRefreshing"
                    class="loading-rail">
                    <div class="loading-bar"></div>
                </div>

                <!-- 落地页设置 -->
                <div v-if="currentTab==='landing'" class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                            <div>
                                <div class="fw-bold">{{ (landingLink && (landingLink.domain||domain)) || domain }}/{{
                                    (landingLink && landingLink.slug) || '' }}</div>
                                <div class="text-muted small text-truncate" style="max-width: 720px;">{{ (landingLink &&
                                    landingLink.targets && landingLink.targets[0]) || '' }}</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-icon-text" type="button"
                                    @click="backFromLanding"><i class="bi bi-arrow-left me-1"></i>返回</button>
                                <button class="btn btn-outline-primary btn-icon-text" type="button"
                                    @click="previewLanding" :disabled="!landingLink"><i
                                        class="bi bi-box-arrow-up-right me-1"></i>预览</button>
                                <button class="btn btn-primary btn-icon-text" type="button" @click="saveLandingSettings"
                                    :disabled="saveLoading"><i class="bi bi-save2 me-1"></i>{{ saveLoading ? '保存中...' :
                                    '保存' }}</button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">更多</button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <button class="dropdown-item" type="button" @click="saveAndPreviewLanding"
                                                :disabled="!landingLink || saveLoading">保存并预览</button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" type="button"
                                                :class="{disabled: !landingLink}"
                                                @click="landingLink && openQr((landingLink && landingLink.slug) || linkForm.slug, (landingLink && landingLink.domain) || null)">二维码</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" v-model="linkForm.use_jump_page"
                                        id="landingJumpSwitch">
                                    <label class="form-check-label fw-bold" for="landingJumpSwitch">启用落地页（营销中间页）</label>
                                </div>
                            </div>

                            <div v-if="simpleMode && linkForm.use_jump_page" class="col-12">
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                    <div class="text-muted small">高级项（自定义问题 / TikTok）默认隐藏</div>
                                    <button class="btn btn-sm btn-outline-secondary" type="button"
                                        @click="landingAdvancedOpen=!landingAdvancedOpen">
                                        {{ landingAdvancedOpen ? '收起高级设置' : '展开高级设置' }}
                                    </button>
                                </div>
                            </div>

                            <div v-if="!linkForm.use_jump_page" class="col-12">
                                <div class="alert alert-secondary mb-0">
                                    已关闭落地页。开启后才会显示“落地页模式 / 页面内容 / 自定义问题 / TikTok”等配置。
                                </div>
                            </div>

                            <div class="col-12 col-lg-7" v-if="linkForm.use_jump_page">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="fw-bold mb-2">页面展示</div>
                                        <div class="row g-2">
                                            <div class="col-12">
                                                <label class="small text-muted">展示内容</label>
                                                <select v-model="linkForm.landing_mode" class="form-select">
                                                    <option value="both">合并页（媒体 + 问题）</option>
                                                    <option value="media">仅媒体页（只显示图片/视频）</option>
                                                    <option value="questions">仅问卷页（只显示问题）</option>
                                                </select>
                                                <div class="text-muted small mt-2">可把“上传图片”和“问问题”拆成两种中间页，也可合并显示。</div>
                                            </div>

                                            <template v-if="linkForm.landing_mode!=='questions'">
                                                <div class="col-12 col-md-6"><label
                                                        class="small text-muted">页面标题</label><input
                                                        v-model="linkForm.page_title" class="form-control"
                                                        placeholder="可留空"></div>
                                                <div class="col-12 col-md-6"><label
                                                        class="small text-muted">按钮文案</label><input
                                                        v-model="linkForm.btn_text" class="form-control"
                                                        placeholder="立即打开"></div>
                                                <div class="col-12"><label class="small text-muted">媒体素材
                                                        URL</label><input v-model="linkForm.media_url"
                                                        class="form-control" placeholder="https://...jpg/mp4"></div>
                                                <div class="col-12">
                                                    <details class="mt-1">
                                                        <summary class="small text-muted"
                                                            style="cursor:pointer;user-select:none">更多文案</summary>
                                                        <div class="mt-2">
                                                            <label class="small text-muted">页面描述</label>
                                                            <textarea v-model="linkForm.page_desc" class="form-control"
                                                                rows="2" placeholder="可留空"></textarea>
                                                        </div>
                                                    </details>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-lg-5" v-if="linkForm.use_jump_page">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="fw-bold mb-2">跳转与安全</div>
                                        <div class="row g-2">
                                            <div class="col-12"><label class="small text-muted">安全页
                                                    URL（Cloaking）</label><input v-model="linkForm.safe_url"
                                                    class="form-control" placeholder="https://wikipedia.org/... "></div>
                                            <div class="col-12"><label class="small text-muted">自动跳转（秒）</label>
                                                <select v-model="linkForm.auto_jump" class="form-select">
                                                    <option :value="0">关闭</option>
                                                    <option :value="3">3秒</option>
                                                    <option :value="5">5秒（推荐）</option>
                                                    <option :value="7">7秒</option>
                                                    <option :value="10">10秒</option>
                                                </select>
                                            </div>
                                            <div class="col-12">
                                                <details class="mt-1">
                                                    <summary class="small text-muted"
                                                        style="cursor:pointer;user-select:none">更多设置</summary>
                                                    <div class="mt-2 border rounded-3 p-3"
                                                        style="background:var(--hover-bg);border-color:var(--border-color) !important;">
                                                        <div class="small fw-bold mb-2">屏蔽国家</div>
                                                        <div class="form-check form-switch mb-2">
                                                            <input class="form-check-input" type="checkbox"
                                                                v-model="linkForm.country_filter_allow"
                                                                id="countryAllowSwitch">
                                                            <label class="form-check-label small text-muted"
                                                                for="countryAllowSwitch">仅允许（白名单）</label>
                                                        </div>
                                                        <div class="input-group input-group-sm mb-2">
                                                            <span class="input-group-text">搜索</span>
                                                            <input v-model="countryFilterSearch" class="form-control"
                                                                placeholder="输入中文或国家代码，例如：中国 / CN">
                                                        </div>
                                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="countryFilterSelectAll">全选</button>
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="countryFilterSelectNone">全不选</button>
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="countryFilterInvert">反选</button>
                                                            <div class="small text-muted ms-auto">已选 {{
                                                                (countryFilterSelected||[]).length }} 个</div>
                                                        </div>
                                                        <div class="border rounded-3 p-2"
                                                            style="max-height:180px;overflow:auto;background:rgba(0,0,0,.06);border-color:var(--border-color) !important;">
                                                            <div v-for="code in countryFilterShownCodes" :key="code"
                                                                class="form-check" style="margin-bottom:6px;">
                                                                <input class="form-check-input" type="checkbox"
                                                                    :id="'cf_'+code"
                                                                    :checked="(countryFilterSelected||[]).includes(code)"
                                                                    @change="countryFilterToggle(code)">
                                                                <label class="form-check-label" :for="'cf_'+code">{{
                                                                    (countryMap[code]||code) + ' (' + code + ')'
                                                                    }}</label>
                                                            </div>
                                                            <div v-if="(countryFilterShownCodes||[]).length===0"
                                                                class="small text-muted">无匹配结果</div>
                                                        </div>
                                                        <div class="small text-muted mt-2">保存后会以国家代码写入（例如：CN,JP,US）
                                                        </div>

                                                        <div class="small fw-bold mt-3 mb-2">屏蔽设备</div>
                                                        <div class="form-check form-switch mb-2">
                                                            <input class="form-check-input" type="checkbox"
                                                                v-model="linkForm.device_filter_allow"
                                                                id="deviceAllowSwitch">
                                                            <label class="form-check-label small text-muted"
                                                                for="deviceAllowSwitch">仅允许（白名单）</label>
                                                        </div>
                                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="deviceFilterSelectAll">全选</button>
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="deviceFilterSelectNone">全不选</button>
                                                            <button type="button"
                                                                class="btn btn-sm btn-outline-secondary"
                                                                @click="deviceFilterInvert">反选</button>
                                                            <div class="small text-muted ms-auto">已选 {{
                                                                (deviceFilterSelected||[]).length }} 个</div>
                                                        </div>
                                                        <div class="border rounded-3 p-2"
                                                            style="max-height:160px;overflow:auto;background:rgba(0,0,0,.06);border-color:var(--border-color) !important;">
                                                            <div v-for="dev in deviceFilterAllCodes" :key="dev"
                                                                class="form-check" style="margin-bottom:6px;">
                                                                <input class="form-check-input" type="checkbox"
                                                                    :id="'df_'+dev"
                                                                    :checked="(deviceFilterSelected||[]).includes(dev)"
                                                                    @change="deviceFilterToggle(dev)">
                                                                <label class="form-check-label" :for="'df_'+dev">{{ dev
                                                                    }}</label>
                                                            </div>
                                                        </div>
                                                        <div class="small text-muted mt-2">保存后会以设备名写入（例如：iOS,Android）
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12"
                                v-if="linkForm.use_jump_page && linkForm.landing_mode!=='media' && (!simpleMode || landingAdvancedOpen)">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="fw-bold mb-2">自定义问题</div>
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <button class="btn btn-sm btn-outline-primary" type="button"
                                                @click="addMarketingOption"
                                                :disabled="(marketingOptionItems||[]).length>=4"><i
                                                    class="bi bi-plus"></i> 添加问题</button>
                                            <div class="text-muted small">最多4项，访客可不选，仅用于页面引导</div>
                                        </div>
                                        <div v-if="(marketingOptionItems||[]).length===0" class="text-muted small">未配置
                                        </div>
                                        <details v-for="(it,idx) in marketingOptionItems" :key="it._id"
                                            class="border rounded-3 p-3 mb-2" :open="idx===0">
                                            <summary class="d-flex align-items-center justify-content-between gap-2"
                                                style="cursor:pointer;user-select:none">
                                                <div class="fw-bold text-truncate">Q{{idx+1}}：{{ (it && it.label) ||
                                                    '未命名' }}</div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge bg-secondary" style="opacity:.9">{{ (it &&
                                                        it.type) || '' }}</span>
                                                    <div class="btn-group btn-group-sm" @click.stop>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                            @click.stop="moveMarketingOption(idx,-1)"
                                                            :disabled="idx===0"><i class="bi bi-arrow-up"></i></button>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                            @click.stop="moveMarketingOption(idx,1)"
                                                            :disabled="idx===((marketingOptionItems||[]).length-1)"><i
                                                                class="bi bi-arrow-down"></i></button>
                                                        <button class="btn btn-outline-danger" type="button"
                                                            @click.stop="removeMarketingOption(idx)"><i
                                                                class="bi bi-trash"></i></button>
                                                    </div>
                                                </div>
                                            </summary>
                                            <div class="mt-2">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-6"><label
                                                            class="small text-muted">问题标题</label><input
                                                            v-model="it.label" class="form-control" placeholder="例如：套餐"
                                                            @blur="ensureMarketingKey(it)"></div>
                                                    <div class="col-12 col-md-6"><label
                                                            class="small text-muted">字段名</label><input v-model="it.key"
                                                            class="form-control" placeholder="例如：plan"></div>
                                                    <div class="col-12 col-md-6"><label
                                                            class="small text-muted">类型</label>
                                                        <select v-model="it.type" class="form-select">
                                                            <option value="select">下拉选择</option>
                                                            <option value="radio">单选</option>
                                                            <option value="checkbox">多选</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-12 col-md-6"><label
                                                            class="small text-muted">默认值（可选）</label><input
                                                            v-model="it.default" class="form-control"
                                                            placeholder="多选用逗号分隔"></div>
                                                    <div class="col-12">
                                                        <label class="small text-muted">答案</label>
                                                        <div v-for="(op,oi) in it.options" :key="oi"
                                                            class="d-flex align-items-center gap-2 mb-2">
                                                            <input v-model="it.options[oi]" class="form-control"
                                                                placeholder="输入您的答案"
                                                                @input="ensureOptionTrailingEmpty(it)">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                @click="removeMarketingOptionAnswer(it,oi)"
                                                                :disabled="(it.options||[]).length<=1"><span>-</span></button>
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                @click="addMarketingOptionAnswer(it,oi)"><span>+</span></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </details>
                                        <textarea v-model="linkForm.marketing_options" class="form-control d-none"
                                            rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12" v-if="linkForm.use_jump_page && (!simpleMode || landingAdvancedOpen)">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <details>
                                            <summary class="fw-bold mb-2" style="cursor:pointer;user-select:none">TikTok
                                                / Pixel / Events API</summary>
                                            <div class="row g-2 mt-1">
                                                <div class="col-12 col-md-6"><label class="small text-muted">Pixel
                                                        ID</label><input v-model="linkForm.pixel_id"
                                                        class="form-control" placeholder="C123..."></div>
                                                <div class="col-12 col-md-6"><label
                                                        class="small text-muted">像素事件（点击）</label><input
                                                        v-model="linkForm.pixel_event_click" class="form-control"
                                                        placeholder="Lead"></div>
                                                <div class="col-12 col-md-6"><label
                                                        class="small text-muted">像素事件（自动跳转）</label><input
                                                        v-model="linkForm.pixel_event_auto" class="form-control"
                                                        placeholder="ViewContent"></div>
                                                <div class="col-12 col-md-6"><label class="small text-muted">TikTok
                                                        Events API Token</label><input
                                                        v-model="linkForm.tiktok_access_token" class="form-control"
                                                        placeholder="Access Token"></div>
                                                <div class="col-12 col-md-6"><label class="small text-muted">Test Event
                                                        Code（可选）</label><input v-model="linkForm.tiktok_test_event_code"
                                                        class="form-control" placeholder="TESTxxxx"></div>
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 高级筛选面板 -->
                <div v-if="(currentTab==='links' || currentTab==='all_links') && advancedFilterOpen"
                    class="advanced-filter-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-funnel me-2"></i>高级筛选</h6>
                        <button class="btn btn-sm btn-link text-muted" @click="clearAdvancedFilters">清空筛选</button>
                    </div>
                    <div class="filter-row mb-3">
                        <div class="filter-col">
                            <label>创建时间</label>
                            <select v-model="advFilters.timeRange" class="form-select form-select-sm">
                                <option value="">全部</option>
                                <option value="today">今天</option>
                                <option value="week">本周</option>
                                <option value="month">本月</option>
                                <option value="custom">自定义</option>
                            </select>
                        </div>
                        <div class="filter-col" v-if="advFilters.timeRange==='custom'">
                            <label>开始日期</label>
                            <input type="date" v-model="advFilters.startDate" class="form-control form-control-sm">
                        </div>
                        <div class="filter-col" v-if="advFilters.timeRange==='custom'">
                            <label>结束日期</label>
                            <input type="date" v-model="advFilters.endDate" class="form-control form-control-sm">
                        </div>
                        <div class="filter-col">
                            <label>PV 范围</label>
                            <div class="input-group input-group-sm">
                                <input type="number" v-model.number="advFilters.pvMin" class="form-control"
                                    placeholder="最小" min="0">
                                <span class="input-group-text">-</span>
                                <input type="number" v-model.number="advFilters.pvMax" class="form-control"
                                    placeholder="最大" min="0">
                            </div>
                        </div>
                        <div class="filter-col">
                            <label>UV 范围</label>
                            <div class="input-group input-group-sm">
                                <input type="number" v-model.number="advFilters.uvMin" class="form-control"
                                    placeholder="最小" min="0">
                                <span class="input-group-text">-</span>
                                <input type="number" v-model.number="advFilters.uvMax" class="form-control"
                                    placeholder="最大" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="filter-row mb-3">
                        <div class="filter-col">
                            <label>域名</label>
                            <select v-model="advFilters.domain" class="form-select form-select-sm">
                                <option value="">全部域名</option>
                                <option :value="domain">{{ domain }} (主域名)</option>
                                <option v-for="d in domainList" :key="d.id" :value="d.domain">{{ d.domain }}</option>
                            </select>
                        </div>
                        <div class="filter-col">
                            <label>备注关键词</label>
                            <input type="text" v-model="advFilters.remarkKeyword" class="form-control form-control-sm"
                                placeholder="搜索备注...">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="small text-muted">快速预设：</span>
                            <div class="filter-preset-chip" @click="applyFilterPreset('high-traffic')">
                                <i class="bi bi-fire"></i>高流量 (PV>100)
                            </div>
                            <div class="filter-preset-chip" @click="applyFilterPreset('recent')">
                                <i class="bi bi-clock"></i>最近7天
                            </div>
                            <div class="filter-preset-chip" @click="applyFilterPreset('no-traffic')">
                                <i class="bi bi-exclamation-circle"></i>零流量
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary btn-icon-text" @click="applyAdvancedFilters">
                            <i class="bi bi-check2 me-1"></i>应用筛选
                        </button>
                    </div>
                </div>

                <!-- 链接列表 -->
                <div v-else-if="currentTab==='links' || currentTab==='all_links'">
                    <div v-if="loadingLinks && !isAutoRefreshing" class="py-3">
                        <div v-if="viewMode==='grid'" class="row g-3">
                            <div v-for="n in 6" :key="'skg_'+n" class="col-12 col-md-6 col-xl-4">
                                <div class="card h-100 border-0 shadow-sm glass-card">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div class="skeleton sk-line" style="width:68%;"></div>
                                            <div class="skeleton sk-pill" style="width:56px;"></div>
                                        </div>
                                        <div class="skeleton sk-line sm" style="width:40%;margin-bottom:10px;"></div>
                                        <div class="skeleton" style="height:40px;margin-bottom:12px;"></div>
                                        <div class="d-flex justify-content-between align-items-center pt-2"
                                            style="border-top:1px solid var(--border-color)">
                                            <div class="d-flex gap-2">
                                                <div class="skeleton sk-pill" style="width:68px;"></div>
                                                <div class="skeleton sk-pill" style="width:68px;"></div>
                                            </div>
                                            <div class="skeleton sk-pill" style="width:74px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else class="card border-0 shadow-sm glass-card">
                            <div class="card-body p-3">
                                <div v-for="n in 6" :key="'skt_'+n"
                                    class="d-flex align-items-center justify-content-between"
                                    style="padding:10px 4px;border-bottom:1px solid var(--border-color);">
                                    <div class="skeleton sk-line" style="width:55%;"></div>
                                    <div class="d-flex gap-2">
                                        <div class="skeleton sk-pill" style="width:56px;"></div>
                                        <div class="skeleton sk-pill" style="width:56px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="(selectedIds||[]).length>0"
                        class="bulk-bar mb-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-primary">已选 {{ (selectedIds||[]).length }}</span>
                            <button class="btn btn-sm btn-outline-secondary" @click="clearSelection">清空</button>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-info btn-icon-text" @click="openBulkEditRemark"><i
                                    class="bi bi-pencil me-1"></i>批量备注</button>
                            <button class="btn btn-sm btn-outline-primary btn-icon-text" @click="bulkCopyPrompt"><i
                                    class="bi bi-clipboard me-1"></i>批量复制</button>
                            <button class="btn btn-sm btn-outline-danger btn-icon-text" @click="bulkDeleteSelected"><i
                                    class="bi bi-trash me-1"></i>批量删除</button>
                        </div>
                    </div>

                    <template v-if="!loadingLinks && ((links && links.length) || 0)===0">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-5 text-center">
                                <div class="display-6 mb-2" style="opacity:.65"><i class="bi"
                                        :class="searchQuery ? 'bi-search' : 'bi-link-45deg'"></i></div>
                                <h5 class="fw-bold mb-2">{{ searchQuery ? '暂无搜索结果' : '暂无短链' }}</h5>
                                <div class="text-muted mb-4">{{ searchQuery ? '尝试修改关键词，或清空搜索查看全部。' : '点击下方按钮创建你的第一条短链。'
                                    }}</div>
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <button v-if="searchQuery" class="btn btn-outline-secondary"
                                        @click="searchQuery=''; loadLinks(1)">清空搜索</button>
                                    <button v-if="currentTab==='links'" class="btn btn-primary"
                                        @click="openLinkModal()"><i class="bi bi-plus-lg me-1"></i>新建短链</button>
                                </div>
                            </div>
                        </div>
                    </template>

                    <template v-else>
                        <!-- 网格视图 -->
                        <div v-if="viewMode==='grid'" class="row g-3">
                            <div v-for="l in displayedLinks" :key="l.id" class="col-12 col-md-6 col-xl-4">
                                <div class="swipe-container">
                                    <div class="swipe-actions">
                                        <button class="swipe-action-btn edit" @click="openLinkModal(l)"><i
                                                class="bi bi-pencil"></i></button>
                                        <button class="swipe-action-btn delete" @click="deleteLink(l.id)"><i
                                                class="bi bi-trash"></i></button>
                                    </div>
                                    <div class="card link-item h-100 border-0 shadow-sm position-relative swipe-content"
                                        @touchstart="handleTouchStart($event, l.id)"
                                        @touchmove="handleTouchMove($event, l.id)"
                                        @touchend="handleTouchEnd($event, l.id)">
                                        <div class="link-select-wrap">
                                            <input class="form-check-input link-select" type="checkbox" :value="l.id"
                                                v-model="selectedIds" :disabled="loadingLinks">
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div class="d-flex align-items-center text-truncate"
                                                    style="max-width: 80%;">
                                                    <a :href="buildUrl(l)" target="_blank"
                                                        class="fs-5 fw-bold text-decoration-none me-2 text-truncate"
                                                        style="color:var(--text-main)">{{ l.domain||domain }}/{{ l.slug
                                                        }}</a>
                                                    <i class="bi bi-clipboard copy-btn"
                                                        @click="copyLink(l.slug, l.domain)"></i>
                                                    <i class="bi bi-qr-code ms-2 copy-btn" title="二维码"
                                                        @click="openQr(l.slug, l.domain)"></i>
                                                </div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-link text-muted"
                                                        data-bs-toggle="dropdown"><i
                                                            class="bi bi-three-dots-vertical"></i></button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item" @click="openLinkModal(l)">编辑</a>
                                                        </li>
                                                        <li><a class="dropdown-item"
                                                                @click="openLandingSettings(l)">落地页设置</a></li>
                                                        <li><a class="dropdown-item"
                                                                @click="openQr(l.slug, l.domain)">二维码</a></li>
                                                        <li><a class="dropdown-item"
                                                                @click="clearStatsPrompt(l.id)">清理数据</a></li>
                                                        <li><a class="dropdown-item text-danger"
                                                                @click="deleteLink(l.id)">删除</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2 small flex-wrap gap-1">
                                                <span v-if="l.remark" class="text-muted text-truncate"
                                                    style="max-width: 150px;"><i
                                                        class="bi bi-tag me-1"></i>{{l.remark}}</span>
                                                <span v-if="currentTab==='all_links'"
                                                    class="badge bg-warning text-dark border border-warning fw-bold px-2 py-1"
                                                    style="letter-spacing:.2px;"><i
                                                        class="bi bi-person-circle me-1"></i>创建者：{{ l.username || '-'
                                                    }}</span>
                                                <span v-if="l.use_jump_page"
                                                    class="badge bg-primary bg-opacity-10 text-primary border border-primary"><i
                                                        class="bi bi-lightning-fill me-1"></i>营销页</span>
                                                <span v-if="l.use_jump_page"
                                                    class="badge bg-info bg-opacity-10 text-info border border-info">{{
                                                    modeLabel(l.landing_mode) }}</span>
                                            </div>
                                            <div class="mb-3 p-2 rounded small text-muted text-truncate"
                                                style="background:var(--hover-bg)">{{ (l.targets && l.targets[0]) || ''
                                                }} <span v-if="(l.targets ? l.targets.length : 0) > 1"
                                                    class="badge bg-secondary rounded-pill">+{{ (l.targets ?
                                                    l.targets.length : 0) - 1 }}</span></div>
                                            <div
                                                class="d-flex justify-content-between align-items-center pt-2 border-top">
                                                <div class="stat-group d-flex gap-2">
                                                    <span
                                                        class="stat-badge-pv px-2 py-1 rounded-pill d-flex align-items-center"
                                                        title="总点击量"><i class="bi bi-hand-index-thumb me-1"></i><span
                                                            class="fw-bold">{{ l.pv }}</span></span>
                                                    <span
                                                        class="stat-badge-uv px-2 py-1 rounded-pill d-flex align-items-center"
                                                        title="独立访客数"><i class="bi bi-person me-1"></i><span
                                                            class="fw-bold">{{ l.uv }}</span></span>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-light me-1 text-danger"
                                                        @click="clearStatsPrompt(l.id)" title="清理"
                                                        style="background:var(--hover-bg);border-color:var(--border-color)"><i
                                                            class="bi bi-eraser-fill"></i></button>
                                                    <button class="btn btn-sm btn-light text-primary fw-bold"
                                                        @click="showStats(l)"
                                                        style="background:var(--hover-bg);border-color:var(--border-color)">报表</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 列表视图 -->
                        <div v-else class="custom-table">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th style="width:44px" class="text-center"><input
                                                class="form-check-input link-select" type="checkbox"
                                                :checked="isAllSelected" @change="toggleSelectAll"
                                                :disabled="loadingLinks"></th>
                                        <th>短链接</th>
                                        <th v-if="currentTab==='all_links'">创建者</th>
                                        <th>备注</th>
                                        <th>类型</th>
                                        <th>目标网址</th>
                                        <th>数据统计</th>
                                        <th class="text-end">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="l in displayedLinks" :key="l.id">
                                        <td class="text-center" :data-label="'选择'">
                                            <input class="form-check-input link-select" type="checkbox" :value="l.id"
                                                v-model="selectedIds" :disabled="loadingLinks">
                                        </td>
                                        <td width="25%" :data-label="'短链接'">
                                            <div class="d-flex align-items-center flex-wrap">
                                                <a :href="buildUrl(l)" target="_blank"
                                                    class="fw-bold text-decoration-none me-2 text-break"
                                                    style="color:var(--text-main)">{{ l.domain||domain }}/{{ l.slug
                                                    }}</a>
                                                <i class="bi bi-clipboard copy-btn"
                                                    @click="copyLink(l.slug, l.domain)"></i>
                                                <i class="bi bi-qr-code ms-2 copy-btn" title="二维码"
                                                    @click="openQr(l.slug, l.domain)"></i>
                                            </div>
                                        </td>
                                        <td v-if="currentTab==='all_links'" :data-label="'创建者'"><span
                                                class="badge bg-warning text-dark border border-warning fw-bold">{{
                                                l.username || '-' }}</span></td>
                                        <td :data-label="'备注'"><small class="text-muted">{{l.remark||'-'}}</small></td>
                                        <td :data-label="'类型'">
                                            <span class="badge"
                                                :class="l.use_jump_page?'bg-primary':'bg-secondary'">{{l.use_jump_page?'营销页':'直连'}}</span>
                                            <span v-if="l.use_jump_page"
                                                class="badge bg-info bg-opacity-10 text-info border border-info ms-1">{{
                                                modeLabel(l.landing_mode) }}</span>
                                        </td>
                                        <td :data-label="'目标网址'">
                                            <div class="text-truncate-2 text-muted" style="max-width: 250px;">{{
                                                (l.targets && l.targets[0]) || '' }} <span
                                                    v-if="(l.targets ? l.targets.length : 0) > 1"
                                                    class="badge bg-secondary rounded-pill">+{{ (l.targets ?
                                                    l.targets.length : 0) - 1 }}</span></div>
                                        </td>
                                        <td :data-label="'数据统计'">
                                            <div class="stat-group">
                                                <span
                                                    class="badge bg-primary bg-opacity-10 text-primary px-2 py-1 me-1"><i
                                                        class="bi bi-hand-index-thumb me-1"></i>{{ l.pv }}</span>
                                                <span class="badge bg-success bg-opacity-10 text-success px-2 py-1"><i
                                                        class="bi bi-person me-1"></i>{{ l.uv }}</span>
                                            </div>
                                        </td>
                                        <td class="text-end" :data-label="'操作'">
                                            <div class="d-flex align-items-center table-actions">
                                                <a class="btn btn-sm btn-light btn-icon-only me-1" :href="buildUrl(l)"
                                                    target="_blank" title="打开"><i
                                                        class="bi bi-box-arrow-up-right"></i></a>
                                                <div class="btn-group me-1">
                                                    <button class="btn btn-sm btn-light btn-icon-only" title="复制"
                                                        data-bs-toggle="dropdown"><i
                                                            class="bi bi-clipboard"></i></button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item"
                                                                @click="copyByMode(l, 'full')">复制完整短链</a></li>
                                                        <li><a class="dropdown-item" @click="copyByMode(l, 'slug')">复制
                                                                slug</a></li>
                                                        <li><a class="dropdown-item"
                                                                @click="copyByMode(l, 'target')">复制目标URL</a></li>
                                                    </ul>
                                                </div>
                                                <button class="btn btn-sm btn-light btn-icon-only me-1"
                                                    @click="showStats(l)" title="报表"><i
                                                        class="bi bi-bar-chart-fill"></i></button>
                                                <button class="btn btn-sm btn-light btn-icon-only me-1"
                                                    @click="openLinkModal(l)" title="编辑"><i
                                                        class="bi bi-pencil-square"></i></button>
                                                <button class="btn btn-sm btn-light btn-icon-only me-1"
                                                    @click="openLandingSettings(l)" title="落地页设置"><i
                                                        class="bi bi-window"></i></button>
                                                <button class="btn btn-sm btn-light btn-icon-only me-1 text-danger"
                                                    @click="clearStatsPrompt(l.id)" title="清理数据"><i
                                                        class="bi bi-eraser-fill"></i></button>
                                                <button class="btn btn-sm btn-light btn-icon-only text-danger"
                                                    @click="deleteLink(l.id)" title="删除"><i
                                                        class="bi bi-trash"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div v-if="totalPages>1"
                            class="mt-4 d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="small text-muted">每页</span>
                                <select v-model="pageSize" class="form-select form-select-sm" style="width: 90px;">
                                    <option :value="10">10</option>
                                    <option :value="20">20</option>
                                    <option :value="50">50</option>
                                </select>
                                <span class="small text-muted">条</span>
                                <span v-if="totalCount" class="small text-muted ms-2">共 {{ totalCount }} 条</span>
                            </div>
                            <nav class="d-flex justify-content-center">
                                <ul class="pagination mb-0">
                                    <li class="page-item" :class="{disabled:page<=1}"><button class="page-link"
                                            @click="loadLinks(page-1)">Prev</button></li>
                                    <li class="page-item disabled"><span class="page-link">{{page}} /
                                            {{totalPages}}</span></li>
                                    <li class="page-item" :class="{disabled:page>=totalPages}"><button class="page-link"
                                            @click="loadLinks(page+1)">Next</button></li>
                                </ul>
                            </nav>
                        </div>
                    </template>
                </div>

                <!-- domains tab -->
                <div v-if="currentTab==='domains'">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h5 class="mb-3">添加新域名</h5>
                            <div class="input-group mb-3 flex-nowrap">
                                <input v-model="newDomain" type="text" class="form-control"
                                    placeholder="例如: newdomain.com" style="min-width: 150px;">
                                <div class="input-group-text">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" v-model="newDomainPublic">
                                        <label class="form-check-label small d-none d-sm-inline ms-1">公开</label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" @click="addDomain" :disabled="domainLoading">
                                    <span v-if="domainLoading"
                                        class="spinner-border spinner-border-sm me-2"></span><span
                                        class="d-none d-sm-inline">添加</span><i class="bi bi-plus d-sm-none"></i>
                                </button>
                            </div>
                            <div class="alert alert-info small"><i class="bi bi-info-circle me-2"></i>请先在 Cloudflare
                                解析域名A记录到本机IP。</div>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0 custom-table">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="p-3">域名</th>
                                        <th class="p-3">权限</th>
                                        <th class="p-3">状态</th>
                                        <th class="p-3 text-end">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="d in domainList" :key="d.id">
                                        <td class="p-3 fw-bold" :data-label="'域名'">{{ d.domain }}</td>
                                        <td class="p-3" :data-label="'权限'">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" :checked="d.is_public"
                                                    @change="toggleDomainPublic(d)">
                                                <span class="small text-muted">{{d.is_public?'公开':'私有'}}</span>
                                            </div>
                                        </td>
                                        <td class="p-3" :data-label="'状态'"><span class="badge bg-success">正常</span></td>
                                        <td class="p-3 text-end" :data-label="'操作'">
                                            <button class="btn btn-sm btn-outline-danger btn-icon-only" type="button"
                                                @click="deleteDomain(d.id)" title="删除" aria-label="删除">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- invites tab -->
                <div v-if="currentTab==='invites'">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                        <ul class="nav nav-pills">
                            <li class="nav-item"><button class="nav-link" type="button"
                                    :class="{active: inviteSubTab==='codes'}" @click="inviteSubTab='codes'">邀请码</button>
                            </li>
                            <li class="nav-item"><button class="nav-link" type="button"
                                    :class="{active: inviteSubTab==='biz'}" @click="inviteSubTab='biz'">套餐&收款</button>
                            </li>
                        </ul>
                        <div class="text-muted small">{{ inviteSubTab==='codes' ? '生成与管理邀请码' : '配置套餐与收款说明' }}</div>
                    </div>

                    <div v-if="inviteSubTab==='biz'">
                        <div class="row g-3">
                            <div class="col-12 col-lg-8">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body p-4">
                                        <div
                                            class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                                            <div class="fw-bold">套餐列表</div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary btn-icon-text"
                                                    type="button" @click="loadProducts" :disabled="productLoading"><i
                                                        class="bi bi-arrow-clockwise me-1"></i>刷新</button>
                                                <button class="btn btn-sm btn-primary btn-icon-text" type="button"
                                                    @click="resetProductForm" :disabled="productLoading"><i
                                                        class="bi bi-plus-lg me-1"></i>新增套餐</button>
                                            </div>
                                        </div>
                                        <div class="custom-table">
                                            <table class="table table-hover mb-0">
                                                <thead>
                                                    <tr>
                                                        <th class="p-3">名称</th>
                                                        <th class="p-3">额度</th>
                                                        <th class="p-3">天数</th>
                                                        <th class="p-3">价格</th>
                                                        <th class="p-3">状态</th>
                                                        <th class="p-3 text-end">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="p in productList" :key="p.id">
                                                        <td class="p-3 fw-bold" :data-label="'名称'">{{ p.name }}</td>
                                                        <td class="p-3" :data-label="'额度'">+{{ p.add_links || 0 }}</td>
                                                        <td class="p-3" :data-label="'天数'">+{{ p.add_days || 0 }}</td>
                                                        <td class="p-3" :data-label="'价格'">{{ p.price || '-' }}</td>
                                                        <td class="p-3" :data-label="'状态'">
                                                            <div class="form-check form-switch mb-0">
                                                                <input class="form-check-input" type="checkbox"
                                                                    :checked="!!p.enabled"
                                                                    @change="toggleProductEnabled(p,$event)"
                                                                    :disabled="productLoading">
                                                                <span class="small text-muted">{{ p.enabled ? '启用' :
                                                                    '停用' }}</span>
                                                            </div>
                                                        </td>
                                                        <td class="p-3 text-end" :data-label="'操作'">
                                                            <div class="d-flex justify-content-end gap-2">
                                                                <button
                                                                    class="btn btn-sm btn-outline-primary btn-icon-only"
                                                                    type="button" @click="editProduct(p)" title="编辑"
                                                                    aria-label="编辑">
                                                                    <i class="bi bi-pencil-square"></i>
                                                                </button>
                                                                <button
                                                                    class="btn btn-sm btn-outline-danger btn-icon-only"
                                                                    type="button" @click="deleteProduct(p.id)"
                                                                    title="删除" aria-label="删除">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr v-if="!(productList && productList.length)">
                                                        <td class="p-0" colspan="6">
                                                            <div class="ui-state">
                                                                <div class="ui-state-icon"><i class="bi bi-bag"></i>
                                                                </div>
                                                                <div class="ui-state-title">暂无套餐</div>
                                                                <div class="ui-state-desc">可点击右上角「新增套餐」创建。</div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body p-4">
                                        <div class="fw-bold mb-3">{{ productForm.id ? '编辑套餐' : '新增套餐' }}</div>
                                        <div class="mb-3"><label class="form-label small text-muted">名称</label><input
                                                v-model="productForm.name" type="text" class="form-control"
                                                placeholder="例如：加500条 / 加30天"></div>
                                        <div class="row g-2">
                                            <div class="col-6"><label
                                                    class="form-label small text-muted">增加额度</label><input
                                                    v-model="productForm.add_links" type="number" class="form-control">
                                            </div>
                                            <div class="col-6"><label
                                                    class="form-label small text-muted">增加天数</label><input
                                                    v-model="productForm.add_days" type="number" class="form-control">
                                            </div>
                                        </div>
                                        <div class="mt-2 mb-3"><label
                                                class="form-label small text-muted">价格展示</label><input
                                                v-model="productForm.price" type="text" class="form-control"
                                                placeholder="例如：￥29 / USDT 5"></div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox"
                                                v-model="productForm.enabled" id="prodEnabledSwitch">
                                            <label class="form-check-label small text-muted"
                                                for="prodEnabledSwitch">启用</label>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary" type="button" @click="saveProduct"
                                                :disabled="productLoading">保存</button>
                                            <button class="btn btn-outline-secondary" type="button"
                                                @click="resetProductForm" :disabled="productLoading">清空</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-0 shadow-sm mt-3">
                                    <div class="card-body p-4">
                                        <div
                                            class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
                                            <div class="fw-bold">收款说明</div>
                                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                                @click="loadPaymentSettings" :disabled="paymentLoading"><i
                                                    class="bi bi-arrow-clockwise me-1"></i>刷新</button>
                                        </div>
                                        <div class="text-muted small mb-2">这里的内容用于展示给用户（例如二维码链接、USDT 地址、备注）。</div>
                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                                @click="applyPaymentTemplate('wechat')">微信</button>
                                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                                @click="applyPaymentTemplate('alipay')">支付宝</button>
                                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                                @click="applyPaymentTemplate('usdt')">USDT</button>
                                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                                @click="applyPaymentTemplate('custom')">自定义</button>
                                        </div>
                                        <div class="mb-2">
                                            <label class="small text-muted">二维码图片 URL（可选）</label>
                                            <input v-model="paymentQrUrl" class="form-control"
                                                placeholder="https://.../qrcode.png">
                                            <div v-if="paymentQrUrl" class="mt-2">
                                                <img :src="paymentQrUrl" alt="QR"
                                                    style="max-width:220px;max-height:220px;border-radius:10px;border:1px solid var(--border-color);background:#fff;">
                                            </div>
                                        </div>
                                        <textarea v-model="paymentForm.payment_text" class="form-control" rows="6"
                                            placeholder="可填写收款方式、二维码链接、备注等"></textarea>
                                        <button class="btn btn-primary mt-3 w-100" type="button"
                                            @click="savePaymentSettings" :disabled="paymentLoading">保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="inviteSubTab==='codes'">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-12 col-md-4"><label class="form-label fw-bold">选择套餐</label>
                                        <select v-model="invForm.product_id" class="form-select">
                                            <option :value="0">自定义</option>
                                            <option v-for="p in productList" :key="p.id" :value="p.id">{{ p.name }} ({{
                                                p.price || '-' }})</option>
                                        </select>
                                    </div>
                                    <div class="col-6 col-md-2"><label class="form-label fw-bold">数量</label><input
                                            v-model="invForm.count" type="number" class="form-control"></div>
                                    <div class="col-6 col-md-3"><label class="form-label fw-bold">卡密有效期(天)</label><input
                                            v-model="invForm.valid_days" type="number" class="form-control"></div>
                                    <div v-if="!invForm.product_id" class="col-6 col-md-1"><label
                                            class="form-label fw-bold">+额度</label><input v-model="invForm.limit"
                                            type="number" class="form-control"></div>
                                    <div v-if="!invForm.product_id" class="col-6 col-md-2"><label
                                            class="form-label fw-bold">+天数</label><input v-model="invForm.pack_days"
                                            type="number" class="form-control"></div>
                                </div>
                                <button class="btn btn-primary w-100 mt-4" @click="generateInvites"
                                    :disabled="invLoading">生成</button>
                            </div>
                        </div>
                        <div v-if="newCodes && newCodes.length"
                            class="card border-0 shadow-sm bg-success bg-opacity-10 p-4 mb-4">
                            <h5 class="mb-3 text-success">生成成功</h5>
                            <div class="d-flex flex-wrap gap-3">
                                <code v-for="c in newCodes"
                                    class="bg-white px-3 py-2 rounded shadow-sm fs-5 user-select-all text-dark"
                                    style="cursor: pointer;" @click="copyCode(c)">{{c}}</code>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0 custom-table">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th class="p-3">邀请码</th>
                                            <th class="p-3">套餐</th>
                                            <th class="p-3">额度</th>
                                            <th class="p-3">天数</th>
                                            <th class="p-3">价格</th>
                                            <th class="p-3">状态</th>
                                            <th class="p-3">使用者</th>
                                            <th class="p-3">过期时间</th>
                                            <th class="p-3 text-end">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(i,idx) in safeInviteList" :key="(i && i.code) || ('inv_'+idx)">
                                            <td class="p-3 font-monospace" :data-label="'邀请码'">{{ (i && i.code) || '' }}
                                            </td>
                                            <td class="p-3" :data-label="'套餐'">{{ (i && i.product_name) || '-' }}</td>
                                            <td class="p-3" :data-label="'额度'">{{ (i && (i.pack_links || i.max_links ||
                                                0)) || 0 }}</td>
                                            <td class="p-3" :data-label="'天数'">{{ (i && (i.pack_days || 0)) || 0 }}</td>
                                            <td class="p-3" :data-label="'价格'">{{ (i && i.price) || '-' }}</td>
                                            <td class="p-3" :data-label="'状态'"><span class="badge"
                                                    :class="inviteStatus(i).cls">{{ inviteStatus(i).text }}</span></td>
                                            <td class="p-3 text-muted" :data-label="'使用者'">{{ inviteUsedByText(i) }}
                                            </td>
                                            <td class="p-3 text-muted" :data-label="'过期时间'">{{ (i && i.expires_at) || ''
                                                }}</td>
                                            <td class="p-3 text-end" :data-label="'操作'">
                                                <button class="btn btn-sm btn-outline-danger btn-icon-only"
                                                    type="button" @click="deleteInvite(i.code)" title="删除"
                                                    aria-label="删除">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- users tab -->
                <div v-if="currentTab==='users'">
                    <div class="card border-0 shadow-sm position-relative user-card">
                        <div v-if="usersLoading" class="user-loading-overlay">
                            <div>
                                <div class="glow-dot mb-3"></div>
                                <div class="fw-bold mb-1">同步用户列表</div>
                                <div class="text-muted small">请稍候，正在拉取数据...</div>
                            </div>
                        </div>
                        <div class="card-body p-0 custom-table">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="p-3">用户</th>
                                        <th class="p-3">角色</th>
                                        <th class="p-3">额度</th>
                                        <th class="p-3">过期时间</th>
                                        <th class="p-3">注册时间</th>
                                        <th class="p-3 text-end">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="usersLoading">
                                        <td class="p-0" colspan="6">
                                            <div class="table-skeleton glass-card">
                                                <div v-for="n in 3" :key="'usk_'+n" class="table-skeleton-row">
                                                    <div class="skeleton sk-line" style="height:14px;"></div>
                                                    <div class="skeleton sk-pill" style="height:22px;"></div>
                                                    <div class="skeleton sk-line sm" style="width:80%;"></div>
                                                    <div class="skeleton sk-line sm" style="width:70%;"></div>
                                                    <div class="skeleton sk-line sm" style="width:60%;"></div>
                                                    <div class="d-flex justify-content-end gap-2">
                                                        <div class="skeleton sk-pill" style="width:42px;height:22px;">
                                                        </div>
                                                        <div class="skeleton sk-pill" style="width:42px;height:22px;">
                                                        </div>
                                                        <div class="skeleton sk-pill" style="width:42px;height:22px;">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-else-if="safeUserList.length===0">
                                        <td class="p-0" colspan="6">
                                            <div class="ui-state">
                                                <div class="ui-state-icon"><i class="bi bi-people"></i></div>
                                                <div class="ui-state-title">暂无用户</div>
                                                <div class="ui-state-desc">目前没有可管理的用户数据。</div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr v-for="(u,idx) in safeUserList" :key="u.id || ('u_'+idx)">
                                        <td class="p-3 fw-bold" :data-label="'用户'">{{ u?.username || '' }}</td>
                                        <td class="p-3" :data-label="'角色'"><span class="badge"
                                                :class="(u && u.role)==='admin'?'bg-warning text-dark':'bg-secondary'">{{
                                                (u && u.role) || '' }}</span></td>
                                        <td class="p-3" :data-label="'额度'">{{ (u && (u.used || 0)) || 0 }} / {{ (u &&
                                            u.link_limit) || 0 }}</td>
                                        <td class="p-3 text-muted" :data-label="'过期时间'">{{ (u && u.expire_time) || '永久'
                                            }}</td>
                                        <td class="p-3 small text-muted" :data-label="'注册时间'">{{ (u && u.created_at) ||
                                            '' }}</td>
                                        <td class="p-3 text-end" v-if="u && u.id !== safeUser.id" :data-label="'操作'">
                                            <div class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-sm btn-outline-info btn-icon-only" type="button"
                                                    @click="openUserDomainModal(u)" title="域名" aria-label="域名">
                                                    <i class="bi bi-globe"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary btn-icon-only"
                                                    type="button" @click="editUser(u)" title="修改" aria-label="修改">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger btn-icon-only"
                                                    type="button" @click="deleteUser(u.id)" title="删除" aria-label="删除">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- profile tab -->
                <div v-if="currentTab==='profile'">
                    <div class="d-flex flex-column gap-3" style="max-width: 900px; margin: 0 auto;">
                        <div class="card border-0 shadow-sm p-4 w-100" style="max-width: 520px; margin: 0 auto;">
                            <h5 class="mb-4">修改个人资料</h5>
                            <form @submit.prevent="updateProfile">
                                <div class="mb-3"><label class="form-label">新用户名</label><input
                                        v-model="profileForm.username" type="text" class="form-control"
                                        autocomplete="username" :placeholder="(safeUser && safeUser.username) || ''">
                                </div>
                                <div class="mb-3"><label class="form-label">新密码</label><input
                                        v-model="profileForm.new_password" type="password" class="form-control"
                                        autocomplete="new-password"></div>
                                <hr>
                                <div class="mb-4"><label class="form-label text-danger">当前密码 *</label><input
                                        v-model="profileForm.current_password" type="password" class="form-control"
                                        autocomplete="current-password" required placeholder="请输入当前密码以确认"></div>
                                <button class="btn btn-primary w-100" type="submit"
                                    :disabled="saveLoading">保存修改</button>
                            </form>
                        </div>

                        <div v-if="user && safeUser.role!=='admin'" class="card border-0 shadow-sm p-4 w-100"
                            style="max-width: 520px; margin: 0 auto;">
                            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                                <div>
                                    <h5 class="mb-1">套餐/购买</h5>
                                    <div class="text-muted small">当前额度：{{ (safeUser && safeUser.link_limit) || 0
                                        }}，到期：{{ (safeUser && safeUser.expire_time) || '永久' }}</div>
                                </div>
                                <button class="btn btn-outline-primary" @click="openRedeemModal">兑换卡密</button>
                            </div>
                            <div class="mt-3">
                                <div v-if="purchaseLoading" class="text-muted small">加载套餐中...</div>
                                <div v-else>
                                    <div v-if="purchaseInfo && purchaseInfo.products && purchaseInfo.products.length">
                                        <div class="fw-bold mb-2">额度套餐</div>
                                        <div class="d-flex flex-column gap-2">
                                            <div v-for="p in quotaProducts" :key="'q'+p.id"
                                                class="d-flex align-items-center justify-content-between border rounded px-3 py-2">
                                                <div>
                                                    <div class="fw-bold">{{ p.name }}</div>
                                                    <div class="text-muted small">+{{ p.add_links }} 条</div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold">{{ p.price || '-' }}</div>
                                                </div>
                                            </div>
                                            <div v-if="!(quotaProducts && quotaProducts.length)"
                                                class="text-muted small">暂无额度套餐</div>
                                        </div>

                                        <div class="fw-bold mt-3 mb-2">时长套餐</div>
                                        <div class="d-flex flex-column gap-2">
                                            <div v-for="p in daysProducts" :key="'d'+p.id"
                                                class="d-flex align-items-center justify-content-between border rounded px-3 py-2">
                                                <div>
                                                    <div class="fw-bold">{{ p.name }}</div>
                                                    <div class="text-muted small">+{{ p.add_days }} 天</div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold">{{ p.price || '-' }}</div>
                                                </div>
                                            </div>
                                            <div v-if="!(daysProducts && daysProducts.length)" class="text-muted small">
                                                暂无时长套餐</div>
                                        </div>
                                    </div>
                                    <div v-else class="text-muted small">暂无可购买套餐</div>

                                    <div v-if="purchaseInfo && purchaseInfo.payment_text" class="mt-3">
                                        <div class="fw-bold mb-2">收款方式</div>
                                        <div v-if="purchasePaymentQr" class="mb-2">
                                            <img :src="purchasePaymentQr" alt="QR"
                                                style="max-width:240px;max-height:240px;border-radius:12px;border:1px solid var(--border-color);background:#fff;">
                                        </div>
                                        <div class="text-muted small" style="white-space: pre-wrap;">{{
                                            purchasePaymentText }}</div>
                                    </div>

                                    <div class="text-muted small mt-3">购买后在上方点击「兑换卡密」输入兑换码即可生效（额度/时长独立计算）。</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- system tab -->
                <div v-if="currentTab==='system'">
                    <div class="row g-4">
                        <div class="col-12 col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <h5 class="mb-3">数据备份</h5>
                                <p class="text-muted small">下载当前数据库的完整备份。</p>
                                <a href="/api/admin/backup" target="_blank" class="btn btn-dark w-100 mt-auto"><i
                                        class="bi bi-download me-2"></i>下载数据库</a>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="card border-0 shadow-sm p-4 h-100">
                                <h5 class="mb-3">系统更新</h5>
                                <p class="text-muted small">从云端同步最新代码。更新过程会自动重启服务。</p>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="updateBackendSwitch"
                                        v-model="updateBackend">
                                    <label class="form-check-label"
                                        for="updateBackendSwitch">同时更新后端（main_v2.py，中间页/落地页改动需要勾选）</label>
                                </div>
                                <div v-if="updateStatus" class="alert"
                                    :class="updateStatus.type === 'success' ? 'alert-success' : 'alert-danger'">{{
                                    updateStatus.msg }}</div>
                                <button class="btn btn-warning w-100 mt-auto btn-icon-text" @click="performUpdate"
                                    :disabled="isUpdating">
                                    <i class="bi me-2"
                                        :class="isUpdating ? 'bi-hourglass-split' : 'bi-cloud-arrow-down-fill'"></i>
                                    {{ isUpdating ? '更新中...' : '在线更新系统' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- 批量备注弹窗 -->
        <div class="modal fade" id="bulkRemarkModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>批量修改备注</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small mb-3">将为 <strong>{{ selectedIds.length }}</strong> 条短链设置相同的备注</p>
                        <label class="form-label">新备注</label>
                        <input v-model="bulkRemarkText" class="form-control" placeholder="输入备注内容..." maxlength="100">
                        <div class="form-text">留空则清除所有选中短链的备注</div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                        <button class="btn btn-primary" @click="saveBulkRemark" :disabled="bulkRemarkSaving">
                            <span v-if="bulkRemarkSaving" class="spinner-border spinner-border-sm me-1"></span>
                            {{ bulkRemarkSaving ? '保存中...' : '保存' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 链接编辑弹窗 -->
        <div class="modal fade link-modal" id="linkModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>{{editMode?'编辑短链':'新建短链'}}</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="section-title">基础信息</div>
                                <div class="row g-3">
                                    <div class="col-12 col-md-6">
                                        <label class="form-label">选择域名</label>
                                        <select v-model="linkForm.domain_id" class="form-select">
                                            <option :value="null">{{ domain }} (主域名)</option>
                                            <option v-for="d in domainList" :value="d.id">{{ d.domain }}</option>
                                        </select>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label class="form-label">短链 Slug</label>
                                        <div class="input-group">
                                            <input v-model="linkForm.slug" class="form-control" :disabled="editMode">
                                            <button class="btn btn-outline-secondary" type="button"
                                                @click="genRandomSlug" v-if="!editMode"><i
                                                    class="bi bi-shuffle"></i></button>
                                            <button class="btn btn-outline-info" type="button" @click="smartGenSlug"
                                                v-if="!editMode" :disabled="saveLoading"><i class="bi bi-magic"></i>
                                                AI</button>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">备注</label>
                                        <input v-model="linkForm.remark" class="form-control"
                                            placeholder="可选，用于区分不同投放/渠道">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <div class="section-title">跳转目标</div>
                                <label class="form-label">目标网址（一行一个）</label>
                                <textarea v-model="linkForm.targets" class="form-control" rows="3"
                                    placeholder="https://example.com\nhttps://example2.com"></textarea>
                            </div>
                        </div>

                        <div v-if="simpleMode" class="alert alert-info">
                            <div class="fw-bold mb-1">新手操作：1) 填目标网址 2) 点保存 3) 在列表复制/二维码</div>
                            <div class="small">复杂功能（落地页内容、问卷、Pixel/TikTok）建议到「落地页设置」里配置。</div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <details
                                    :open="!!(linkForm.safe_url || linkForm.country_filter_list || linkForm.device_filter_list)">
                                    <summary class="d-flex align-items-center gap-2 fw-bold link-details-summary">
                                        <span class="chev"><i class="bi bi-caret-right-fill"
                                                style="font-size:12px;"></i></span>
                                        <span>安全与屏蔽（直连也生效）</span>
                                        <span
                                            v-if="!!(linkForm.safe_url || linkForm.country_filter_list || linkForm.device_filter_list)"
                                            class="ms-auto badge bg-success bg-opacity-10 text-success border border-success fw-normal">已配置</span>
                                        <span v-else
                                            class="ms-auto badge bg-secondary bg-opacity-10 text-muted border border-secondary fw-normal">未配置</span>
                                    </summary>
                                    <div class="text-muted small mt-1">用于屏蔽国家/设备，命中后可跳到安全页（不设置则返回 403）。</div>
                                    <div class="mt-3">
                                        <label class="small text-muted">安全页 URL（Cloaking）</label>
                                        <input v-model="linkForm.safe_url" class="form-control"
                                            placeholder="https://wikipedia.org/wiki/Travel">
                                    </div>

                                    <div class="mt-3">
                                        <div class="small fw-bold mb-2">屏蔽国家</div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                v-model="linkForm.country_filter_allow" id="countryAllowSwitchModal">
                                            <label class="form-check-label small text-muted"
                                                for="countryAllowSwitchModal">仅允许（白名单）</label>
                                        </div>
                                        <div class="input-group input-group-sm mb-2">
                                            <span class="input-group-text">搜索</span>
                                            <input v-model="countryFilterSearch" class="form-control"
                                                placeholder="输入中文或国家代码，例如：中国 / CN">
                                        </div>
                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="countryFilterSelectAll">全选</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="countryFilterSelectNone">全不选</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="countryFilterInvert">反选</button>
                                            <div class="small text-muted ms-auto">已选 {{
                                                (countryFilterSelected||[]).length }} 个</div>
                                        </div>
                                        <div class="border rounded-3 p-2"
                                            style="max-height:180px;overflow:auto;background:rgba(0,0,0,.06);border-color:var(--border-color) !important;">
                                            <div v-for="code in countryFilterShownCodes" :key="code" class="form-check"
                                                style="margin-bottom:6px;">
                                                <input class="form-check-input" type="checkbox" :id="'cfm_'+code"
                                                    :checked="(countryFilterSelected||[]).includes(code)"
                                                    @change="countryFilterToggle(code)">
                                                <label class="form-check-label" :for="'cfm_'+code">{{
                                                    (countryMap[code]||code) + ' (' + code + ')' }}</label>
                                            </div>
                                            <div v-if="countryFilterShownCodes.length===0" class="small text-muted">
                                                无匹配结果</div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <div class="small fw-bold mb-2">屏蔽设备</div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox"
                                                v-model="linkForm.device_filter_allow" id="deviceAllowSwitchModal">
                                            <label class="form-check-label small text-muted"
                                                for="deviceAllowSwitchModal">仅允许（白名单）</label>
                                        </div>
                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="deviceFilterSelectAll">全选</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="deviceFilterSelectNone">全不选</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                @click="deviceFilterInvert">反选</button>
                                            <div class="small text-muted ms-auto">已选 {{
                                                (deviceFilterSelected||[]).length }} 个</div>
                                        </div>
                                        <div class="border rounded-3 p-2"
                                            style="max-height:160px;overflow:auto;background:rgba(0,0,0,.06);border-color:var(--border-color) !important;">
                                            <div v-for="dev in deviceFilterAllCodes" :key="dev" class="form-check"
                                                style="margin-bottom:6px;">
                                                <input class="form-check-input" type="checkbox" :id="'dfm_'+dev"
                                                    :checked="(deviceFilterSelected||[]).includes(dev)"
                                                    @change="deviceFilterToggle(dev)">
                                                <label class="form-check-label" :for="'dfm_'+dev">{{ dev }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- 高级设置 -->
                        <div class="card jump-settings border-0">
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" v-model="linkForm.use_jump_page"
                                        id="jumpSwitch">
                                    <label class="form-check-label fw-bold" for="jumpSwitch">启用营销中间页 (Jump Page)</label>
                                </div>
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                                    <div class="text-muted small">{{ simpleMode ? '高级项（问卷/媒体/像素/TikTok）默认隐藏' :
                                        '高级项（像素/TikTok/素材）可收起' }}</div>
                                    <button class="btn btn-sm btn-outline-secondary" type="button"
                                        @click="linkAdvancedOpen=!linkAdvancedOpen">
                                        {{ linkAdvancedOpen ? '收起高级设置' : '展开高级设置' }}
                                    </button>
                                </div>
                                <div v-if="editMode" class="mb-3">
                                    <button class="btn btn-sm btn-outline-primary" type="button"
                                        @click="openLandingFromModal"><i class="bi bi-window"></i> 去落地页设置</button>
                                    <div class="text-muted small mt-1">落地页内容/自定义问题/TikTok 配置建议在「落地页设置」页面统一完成。</div>
                                </div>
                                <div v-if="linkForm.use_jump_page" class="row g-3">
                                    <div class="col-12 col-md-6"><label>自动跳转 (秒)</label>
                                        <select v-model="linkForm.auto_jump" class="form-select">
                                            <option :value="0">关闭</option>
                                            <option :value="3">3秒</option>
                                            <option :value="5">5秒 (推荐)</option>
                                            <option :value="7">7秒</option>
                                            <option :value="10">10秒</option>
                                        </select>
                                    </div>
                                    <div class="col-12" v-if="linkAdvancedOpen">
                                        <details>
                                            <summary
                                                class="d-flex align-items-center gap-2 fw-bold link-details-summary">
                                                <span class="chev"><i class="bi bi-caret-right-fill"
                                                        style="font-size:12px;"></i></span>
                                                <span>追踪 / Pixel / TikTok</span>
                                            </summary>
                                            <div class="row g-3 mt-1">
                                                <div class="col-12 col-md-6"><label>Pixel ID (TikTok/FB)</label><input
                                                        v-model="linkForm.pixel_id" class="form-control"
                                                        placeholder="C123456789... "></div>
                                                <div class="col-12 col-md-6"><label>像素事件（点击）</label><input
                                                        v-model="linkForm.pixel_event_click" class="form-control"
                                                        placeholder="Lead"></div>
                                                <div class="col-12 col-md-6"><label>像素事件（自动跳转）</label><input
                                                        v-model="linkForm.pixel_event_auto" class="form-control"
                                                        placeholder="ViewContent"></div>
                                                <div class="col-12"><label>TikTok Events API Access Token</label><input
                                                        v-model="linkForm.tiktok_access_token" class="form-control"
                                                        placeholder="复制 TikTok 后台生成的 Access Token"></div>
                                                <div class="col-12"><label>TikTok Test Event Code (可选)</label><input
                                                        v-model="linkForm.tiktok_test_event_code" class="form-control"
                                                        placeholder="TESTxxxx"></div>
                                            </div>
                                        </details>
                                    </div>
                                    <div class="col-12" v-if="linkAdvancedOpen">
                                        <details>
                                            <summary
                                                class="d-flex align-items-center gap-2 fw-bold link-details-summary">
                                                <span class="chev"><i class="bi bi-caret-right-fill"
                                                        style="font-size:12px;"></i></span>
                                                <span>媒体素材</span>
                                            </summary>
                                            <div class="mt-2">
                                                <label class="small text-muted">媒体素材 URL</label>
                                                <input v-model="linkForm.media_url" class="form-control"
                                                    placeholder="https://...jpg/mp4">
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal"
                            :disabled="saveLoading">取消</button>
                        <button @click="saveLink" class="btn btn-primary" :disabled="saveLoading">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="userModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>编辑用户</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3"><label>链接额度</label><input v-model="userForm.link_limit" type="number"
                                class="form-control"></div>
                        <div class="mb-3"><label>过期时间</label><input v-model="userForm.expire_time" type="date"
                                class="form-control"></div>
                        <div class="mb-3"><label>重置密码</label><input v-model="userForm.password" type="text"
                                class="form-control"></div>
                    </div>
                    <div class="modal-footer"><button @click="saveUser" class="btn btn-primary">保存</button></div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="redeemModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>兑换卡密</h5>
                        <button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2 text-muted small">输入购买获得的卡密/邀请码，兑换后将提升额度并延长有效期。</div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">兑换码</label>
                            <input v-model="redeemForm.code" class="form-control font-monospace"
                                placeholder="XXXX-XXXX / 8位码" />
                        </div>
                        <div v-if="redeemResult" class="alert"
                            :class="redeemResult.type==='success'?'alert-success':'alert-danger'">{{ redeemResult.msg }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                        <button class="btn btn-primary" @click="redeemCode" :disabled="redeemLoading">确认兑换</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="domainPermModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5>分配域名 (私有)</h5><button class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div v-if="allPrivateDomains.length===0" class="text-muted text-center py-3">暂无私有域名</div>
                        <div v-else class="list-group"><label class="list-group-item" v-for="d in allPrivateDomains"
                                :key="d.id"><input class="form-check-input me-2" type="checkbox" :value="d.id"
                                    v-model="selectedDomains"> {{ d.domain }}</label></div>
                    </div>
                    <div class="modal-footer"><button @click="saveUserDomains" class="btn btn-primary">保存分配</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据报表弹窗 -->
        <div class="modal fade" id="statsModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0 flex-wrap gap-2">
                        <div>
                            <h5 class="fw-bold mb-0">数据报表</h5><small class="text-muted text-truncate d-block"
                                style="max-width: 200px;">/{{ currentStatsSlug }}</small>
                        </div>
                        <div class="ms-auto btn-group btn-group-sm me-2">
                            <button class="btn btn-outline-primary" :class="{active: statsRange==='8h'}"
                                @click="changeStatsRange('8h')">8小时</button>
                            <button class="btn btn-outline-primary" :class="{active: statsRange==='24h'}"
                                @click="changeStatsRange('24h')">24小时</button>
                            <button class="btn btn-outline-primary" :class="{active: statsRange==='7d'}"
                                @click="changeStatsRange('7d')">7天</button>
                            <button class="btn btn-outline-primary" :class="{active: statsRange==='30d'}"
                                @click="changeStatsRange('30d')">30天</button>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="row text-center mb-4 g-0 stats-card-bg rounded py-3 mx-2">
                            <div class="col border-end">
                                <h2 class="text-primary mb-0 fw-bold">{{statsData.pv}}</h2><small
                                    class="text-muted fw-bold">总点击量 (PV)</small>
                            </div>
                            <div class="col">
                                <h2 class="text-success mb-0 fw-bold">{{statsData.uv}}</h2><small
                                    class="text-muted fw-bold">独立访客 (UV)</small>
                            </div>
                        </div>
                        <div class="card border shadow-none mb-4">
                            <div class="card-header fw-bold">访问趋势</div>
                            <div class="card-body">
                                <div id="trendChart" class="chart-container-lg" style="height:300px; width:100%"></div>
                            </div>
                        </div>
                        <div class="row g-4">
                            <div class="col-lg-8">
                                <div class="card h-100 border shadow-none">
                                    <div class="card-header fw-bold">访客区域</div>
                                    <div class="card-body">
                                        <div id="mapChart" class="chart-container-lg"
                                            style="height: 500px; width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 d-flex flex-column gap-4">
                                <div class="card border shadow-none flex-grow-1">
                                    <div class="card-header fw-bold">设备系统</div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        <div id="osChart" class="chart-container-sm" style="height:250px; width:100%">
                                        </div>
                                    </div>
                                </div>
                                <div class="card border shadow-none flex-grow-1">
                                    <div class="card-header fw-bold">流量来源</div>
                                    <div class="card-body d-flex align-items-center justify-content-center">
                                        <div id="sourceChart" class="chart-container-sm"
                                            style="height:250px; width:100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.__BOOT_APP__ = function () {
            // JS 部分保持原样逻辑，仅做少量自适应事件处理
            const { createApp, ref, reactive, onMounted, computed, onUnmounted, watch } = Vue;
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
            const toastSuccess = (title) => { try { Toast.fire({ icon: 'success', title: String(title || '成功') }); } catch (e) { } };
            const toastError = (title) => { try { Toast.fire({ icon: 'error', title: String(title || '失败') }); } catch (e) { } };
            const toastWarn = (title) => { try { Toast.fire({ icon: 'warning', title: String(title || '提示') }); } catch (e) { } };

            const confirmDanger = async (title, text, confirmText) => {
                try {
                    const r = await Swal.fire({
                        title: String(title || '确认删除?'),
                        text: String(text || ''),
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: String(confirmText || '删除'),
                        cancelButtonText: '取消',
                        confirmButtonColor: '#ef4444',
                    });
                    return !!r.isConfirmed;
                } catch (e) {
                    return false;
                }
            };
            const confirmInfo = async (title, text, confirmText) => {
                try {
                    const r = await Swal.fire({
                        title: String(title || '确认操作?'),
                        text: String(text || ''),
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: String(confirmText || '确认'),
                        cancelButtonText: '取消',
                    });
                    return !!r.isConfirmed;
                } catch (e) {
                    return false;
                }
            };
            const countryMap = { 'CN': '中国', 'US': '美国', 'JP': '日本', 'KR': '韩国', 'GB': '英国', 'DE': '德国', 'FR': '法国', 'RU': '俄罗斯', 'CA': '加拿大', 'AU': '澳大利亚', 'BR': '巴西', 'IN': '印度', 'ID': '印尼', 'SG': '新加坡', 'TH': '泰国', 'VN': '越南', 'TW': '台湾', 'HK': '香港', 'MX': '墨西哥', 'AR': '阿根廷', 'CL': '智利', 'CO': '哥伦比亚', 'PE': '秘鲁', 'NZ': '新西兰', 'CZ': '捷克', 'PT': '葡萄牙', 'ES': '西班牙', 'IT': '意大利', 'NL': '荷兰', 'PL': '波兰', 'TR': '土耳其', 'AE': '阿联酋', 'MY': '马来西亚', 'PH': '菲律宾' };
            const echartsMapName = { 'CN': 'China', 'US': 'United States', 'JP': 'Japan', 'KR': 'Korea', 'GB': 'United Kingdom', 'DE': 'Germany', 'FR': 'France', 'RU': 'Russia', 'CA': 'Canada', 'AU': 'Australia', 'BR': 'Brazil', 'IN': 'India', 'ID': 'Indonesia', 'SG': 'Singapore', 'TH': 'Thailand', 'VN': 'Vietnam', 'TW': 'Taiwan', 'HK': 'China', 'MX': 'Mexico', 'AR': 'Argentina', 'CL': 'Chile', 'CO': 'Colombia', 'PE': 'Peru', 'NZ': 'New Zealand', 'CZ': 'Czech Rep.', 'PT': 'Portugal', 'ES': 'Spain', 'IT': 'Italy', 'NL': 'Netherlands', 'PL': 'Poland', 'TR': 'Turkey', 'AE': 'United Arab Emirates', 'MY': 'Malaysia', 'PH': 'Philippines' };

            let __worldIso2ToName = null;
            const __buildWorldIso2ToName = () => {
                try {
                    __worldIso2ToName = {};
                    if (!window.echarts || !window.echarts.getMap) return;
                    const m = window.echarts.getMap('world');
                    const gj = m && (m.geoJSON || m.geoJson);
                    const feats = gj && gj.features;
                    if (!Array.isArray(feats)) return;
                    feats.forEach(f => {
                        const p = (f && f.properties) ? f.properties : {};
                        const iso2 = String(p.iso_a2 || p.ISO_A2 || p.iso2 || p.ISO2 || '').toUpperCase();
                        const name = String(p.name || p.NAME || '');
                        if (iso2 && iso2 !== '-99' && name) __worldIso2ToName[iso2] = name;
                    });
                } catch (e) {
                    __worldIso2ToName = {};
                }
            };
            const __worldNameByCode = (code) => {
                const c = String(code || '').toUpperCase();
                if (!c) return '';
                if (!__worldIso2ToName) __buildWorldIso2ToName();
                return (__worldIso2ToName && __worldIso2ToName[c]) || echartsMapName[c] || c;
            };

            axios.defaults.timeout = 20000;
            axios.defaults.withCredentials = true;

            const hideStaticLoader = () => {
                const loader = document.getElementById('static-loader');
                if (loader) loader.style.display = 'none';
            };

            const showFatalOverlay = (title, detail) => {
                try {
                    let el = document.getElementById('fatal-overlay');
                    if (!el) {
                        el = document.createElement('div');
                        el.id = 'fatal-overlay';
                        el.style.cssText = 'position:fixed;z-index:99999;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.85);color:#fff;padding:16px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;';
                        el.innerHTML = '<div style="max-width:980px;margin:0 auto;"><div style="font-size:18px;font-weight:700;margin-bottom:8px;">页面发生错误</div><div id="fatal-title" style="margin-bottom:10px;opacity:.9;"></div><pre id="fatal-detail" style="white-space:pre;word-break:break-word;background:rgba(255,255,255,.06);padding:12px;border-radius:8px;max-height:60vh;overflow:auto;"></pre><div style="margin-top:10px;opacity:.85;font-size:12px;">请把这段错误截图发给我，我会继续修复。</div></div>';
                        document.body.appendChild(el);
                    }
                    const t = document.getElementById('fatal-title');
                    const d = document.getElementById('fatal-detail');
                    if (t) t.textContent = String(title || '');
                    if (d) d.textContent = String(detail || '');
                    try { console.error('FATAL_OVERLAY_TITLE\n' + String(title || '')); } catch (e) { }
                    try { console.error('FATAL_OVERLAY_DETAIL\n' + String(detail || '')); } catch (e) { }
                    el.style.display = 'block';
                } catch (e) { }
            };

            window.addEventListener('error', function (ev) {
                try { hideStaticLoader(); } catch (e) { }
                const msg = ev && (ev.message || (ev.error && ev.error.message)) || 'Unknown error';
                const stack = (ev && ev.error && ev.error.stack) ? ev.error.stack : '';
                const loc = ev && (ev.filename || ev.sourceURL) ? (`${ev.filename || ev.sourceURL}:${ev.lineno || 0}:${ev.colno || 0}`) : '';
                showFatalOverlay(loc ? (msg + '\n' + loc) : msg, stack);
            });

            window.addEventListener('unhandledrejection', function (ev) {
                try { hideStaticLoader(); } catch (e) { }
                const reason = ev && ev.reason;
                const msg = reason && reason.message ? reason.message : String(reason || 'Unhandled Promise Rejection');
                const stack = reason && reason.stack ? reason.stack : '';
                showFatalOverlay(msg, stack);
            });

            axios.interceptors.request.use(function (config) {
                const token = localStorage.getItem('site_token');
                if (token) config.headers['x-token'] = token;
                return config;
            });

            axios.interceptors.response.use(
                function (r) {
                    try { clearTimeout(globalLoaderWatchdog); } catch (e) { }
                    try { hideStaticLoader(); } catch (e) { }
                    return r;
                },
                function (e) {
                    try { clearTimeout(globalLoaderWatchdog); } catch (err) { }
                    try { hideStaticLoader(); } catch (err) { }
                    if (e && e.response && e.response.status === 401) {
                        localStorage.removeItem('site_token');
                        window.location.reload();
                    } else {
                        const isSilent = !!(e && e.config && (e.config.silent || e.config.__silent));
                        if (!isSilent) {
                            const msg = ((e && e.response && e.response.data && (e.response.data.detail || e.response.data.error)) || '请求失败');
                            toastError(msg);
                        }
                    }
                    return Promise.reject(e);
                }
            );

            const globalLoaderWatchdog = setTimeout(function () {
                hideStaticLoader();
                try { toastError('连接超时，请检查后端是否启动/网络是否可达'); } catch (e) { }
            }, 20000);

            axios.get('/api/auth/check', { silent: true, __silent: true, timeout: 8000 }).catch(function () {
                try { toastError('连接超时，请检查后端是否启动/网络是否可达'); } catch (e) { }
            });

            const app = createApp({
                setup() {
                    const user = ref(null), initLoading = ref(true), authMode = ref('login'), authForm = reactive({ username: '', password: '', captcha: '', invite: '' }), captchaQ = ref('点刷新获取验证码'), authLoading = ref(false);
                    const capId = ref('');
                    const safeUser = reactive({ username: '', role: '', link_limit: 0, expire_time: '', id: 0 });
                    const syncSafeUser = (src) => {
                        try {
                            const u = (src && typeof src === 'object') ? src : {};
                            safeUser.username = String(u.username || '');
                            safeUser.role = String(u.role || '');
                            safeUser.link_limit = Number(u.link_limit || 0);
                            safeUser.expire_time = String(u.expire_time || '');
                            safeUser.id = Number(u.id || 0);
                        } catch (e) {
                            safeUser.username = '';
                            safeUser.role = '';
                            safeUser.link_limit = 0;
                            safeUser.expire_time = '';
                            safeUser.id = 0;
                        }
                    };
                    watch(user, (nv) => syncSafeUser(nv), { immediate: true, deep: true });

                    const setAuthMode = (m) => {
                        authMode.value = (m === 'register') ? 'register' : 'login';
                    };

                    const refreshCaptcha = async () => {
                        try {
                            const r = await axios.get('/api/captcha', { timeout: 8000, params: { _ts: Date.now() } });
                            captchaQ.value = (r && r.data && r.data.q) ? String(r.data.q) : '点刷新获取验证码';
                            capId.value = (r && r.data && (r.data.cap_id || r.data.capId)) ? String(r.data.cap_id || r.data.capId) : '';
                        } catch (e) {
                            captchaQ.value = '点刷新获取验证码';
                            capId.value = '';
                        }
                    };

                    let __authRetryCount = 0;
                    const checkAuth = async () => {
                        try {
                            const r = await axios.get('/api/auth/check', { timeout: 8000, silent: true, __silent: true });
                            if (r && r.data && r.data.status === 'authenticated' && r.data.user) {
                                user.value = r.data.user;
                            } else {
                                user.value = null;
                            }
                        } catch (e) {
                            user.value = null;
                            try {
                                const hasToken = !!localStorage.getItem('site_token');
                                if (hasToken && __authRetryCount < 6) {
                                    __authRetryCount += 1;
                                    setTimeout(() => { try { checkAuth(); } catch (e2) { } }, 1200 * __authRetryCount);
                                }
                            } catch (e2) { }
                        } finally {
                            initLoading.value = false;
                        }
                    };

                    const logout = async () => {
                        try { await axios.post('/api/auth/logout'); } catch (e) { }
                        try { localStorage.removeItem('site_token'); } catch (e) { }
                        user.value = null;
                        setAuthMode('login');
                        await refreshCaptcha();
                    };

                    const handleAuth = async () => {
                        if (authLoading.value) return;
                        authLoading.value = true;
                        try {
                            const payload = {
                                username: String(authForm.username || '').trim(),
                                password: String(authForm.password || ''),
                                captcha: String(authForm.captcha || '').trim(),
                                invite: String(authForm.invite || '').trim(),
                                cap_id: String(capId.value || ''),
                            };
                            const url = authMode.value === 'register' ? '/api/auth/register' : '/api/auth/login';
                            const r = await axios.post(url, payload, { timeout: 20000 });
                            if (r && r.data && r.data.token) {
                                try { localStorage.setItem('site_token', String(r.data.token)); } catch (e) { }
                            }
                            if (authMode.value === 'register') {
                                toastSuccess('注册成功，请登录');
                                setAuthMode('login');
                                authForm.password = '';
                            } else {
                                toastSuccess('登录成功');
                            }
                            await checkAuth();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '操作失败';
                                toastError(String(msg));
                            } catch (e2) { }
                            await refreshCaptcha();
                        } finally {
                            authLoading.value = false;
                        }
                    };
                    const currentTab = ref('links'), links = ref([]), loadingLinks = ref(false), page = ref(1), totalPages = ref(1), searchQuery = ref('');
                    const totalCount = ref(0);
                    const pageSize = ref((() => {
                        try {
                            const v = Number(localStorage.getItem('pageSize') || 10) || 10;
                            return [10, 20, 50].includes(v) ? v : 10;
                        } catch (e) {
                            return 10;
                        }
                    })());
                    const isAutoRefreshing = ref(false);
                    const filterType = ref('all');
                    const sortBy = ref('created_desc');
                    const advancedFilterOpen = ref(false);
                    const advFilters = reactive({
                        timeRange: '',
                        startDate: '',
                        endDate: '',
                        pvMin: null,
                        pvMax: null,
                        uvMin: null,
                        uvMax: null,
                        domain: '',
                        remarkKeyword: '',
                    });
                    const hasActiveAdvancedFilters = computed(() => {
                        try {
                            return !!(advFilters.timeRange || advFilters.pvMin || advFilters.pvMax || advFilters.uvMin || advFilters.uvMax || advFilters.domain || advFilters.remarkKeyword);
                        } catch (e) { return false; }
                    });
                    const activeFilterCount = computed(() => {
                        try {
                            let count = 0;
                            if (advFilters.timeRange) count++;
                            if (advFilters.pvMin || advFilters.pvMax) count++;
                            if (advFilters.uvMin || advFilters.uvMax) count++;
                            if (advFilters.domain) count++;
                            if (advFilters.remarkKeyword) count++;
                            return count;
                        } catch (e) { return 0; }
                    });
                    const clearAdvancedFilters = () => {
                        try {
                            advFilters.timeRange = '';
                            advFilters.startDate = '';
                            advFilters.endDate = '';
                            advFilters.pvMin = null;
                            advFilters.pvMax = null;
                            advFilters.uvMin = null;
                            advFilters.uvMax = null;
                            advFilters.domain = '';
                            advFilters.remarkKeyword = '';
                        } catch (e) { }
                    };
                    const applyFilterPreset = (preset) => {
                        try {
                            clearAdvancedFilters();
                            if (preset === 'high-traffic') {
                                advFilters.pvMin = 100;
                            } else if (preset === 'recent') {
                                advFilters.timeRange = 'week';
                            } else if (preset === 'no-traffic') {
                                advFilters.pvMax = 0;
                            }
                            applyAdvancedFilters();
                        } catch (e) { }
                    };
                    const applyAdvancedFilters = () => {
                        try {
                            page.value = 1;
                            loadLinks(1);
                        } catch (e) { }
                    };
                    const __normalizeListFilters = () => {
                        try {
                            const allowedType = new Set(['all', 'jump', 'direct']);
                            const allowedSort = new Set(['created_desc', 'created_asc', 'pv_desc', 'uv_desc', 'slug_asc']);
                            if (!allowedType.has(String(filterType.value || ''))) filterType.value = 'all';
                            if (!allowedSort.has(String(sortBy.value || ''))) sortBy.value = 'created_desc';
                        } catch (e) {
                            filterType.value = 'all';
                            sortBy.value = 'created_desc';
                        }
                    };
                    let __listFilterSyncing = false;
                    watch([filterType, sortBy], (nv, ov) => {
                        if (__listFilterSyncing) return;
                        __listFilterSyncing = true;
                        const beforeType = String(filterType.value || '');
                        const beforeSort = String(sortBy.value || '');
                        __normalizeListFilters();
                        const afterType = String(filterType.value || '');
                        const afterSort = String(sortBy.value || '');
                        __listFilterSyncing = false;

                        if (!Array.isArray(ov)) return;
                        if (beforeType !== afterType || beforeSort !== afterSort) return;
                        if (!user.value) return;
                        if (!(currentTab.value === 'links' || currentTab.value === 'all_links')) return;
                        page.value = 1;
                        try { loadLinks(1); } catch (e) { }
                    }, { immediate: true });

                    let __lastLoadLinksKey = '';
                    let __lastLoadLinksAt = 0;
                    const loadLinks = async (p, opts) => {
                        const nextPage = Number(p || 1) || 1;
                        const silent = !!(opts && opts.silent);
                        if (!user.value) {
                            links.value = [];
                            page.value = 1;
                            totalPages.value = 1;
                            return;
                        }
                        const endpoint = (currentTab.value === 'all_links') ? '/api/admin/all_links' : '/api/links';
                        const params = {
                            page: nextPage,
                            limit: Number(pageSize.value || 10) || 10,
                            search: String(searchQuery.value || ''),
                            link_type: String(filterType.value || 'all'),
                            sort: String(sortBy.value || 'created_desc'),
                        };
                        try {
                            const key = endpoint + '::' + JSON.stringify(params);
                            const now = Date.now();
                            if (key === __lastLoadLinksKey && (now - __lastLoadLinksAt) < 250) return;
                            __lastLoadLinksKey = key;
                            __lastLoadLinksAt = now;
                        } catch (e) { }

                        if (silent) isAutoRefreshing.value = true;
                        else loadingLinks.value = true;
                        try {
                            const r = await axios.get(endpoint, { params, timeout: 20000 });
                            const data = (r && r.data && Array.isArray(r.data.data)) ? r.data.data : [];
                            links.value = data;
                            page.value = Number((r && r.data && r.data.page) || nextPage) || nextPage;
                            totalPages.value = Number((r && r.data && r.data.pages) || 1) || 1;
                            totalCount.value = Number((r && r.data && r.data.total) || 0) || 0;
                        } catch (e) {
                            if (!silent) {
                                try {
                                    const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '加载失败';
                                    toastError(String(msg));
                                } catch (e2) { }
                            }
                        } finally {
                            if (silent) isAutoRefreshing.value = false;
                            else loadingLinks.value = false;

                            try { setTimeout(initTooltips, 0); } catch (e) { }
                        }
                    };

                    const initTooltips = () => {
                        try {
                            if (!window.bootstrap || !window.bootstrap.Tooltip) return;
                            if (window.innerWidth < 992) return;
                            document.querySelectorAll('.btn-icon-only[title]').forEach(el => {
                                try {
                                    if (window.bootstrap.Tooltip.getInstance && window.bootstrap.Tooltip.getInstance(el)) return;
                                } catch (e) { }
                                try { new window.bootstrap.Tooltip(el); } catch (e) { }
                            });
                        } catch (e) { }
                    };

                    watch(pageSize, (v) => {
                        try { localStorage.setItem('pageSize', String(Number(v || 10) || 10)); } catch (e) { }
                        try {
                            if (user.value && (currentTab.value === 'links' || currentTab.value === 'all_links')) {
                                page.value = 1;
                                loadLinks(1);
                            }
                        } catch (e) { }
                    });
                    watch(filterType, (v) => { try { localStorage.setItem('filterType', String(v || 'all')); } catch (e) { } });
                    watch(sortBy, (v) => { try { localStorage.setItem('sortBy', String(v || 'created_desc')); } catch (e) { } });

                    let __didInitialLoad = false;
                    watch(user, (nv) => {
                        if (!nv || __didInitialLoad) return;
                        __didInitialLoad = true;
                        try { filterType.value = String(localStorage.getItem('filterType') || filterType.value || 'all'); } catch (e) { }
                        try { sortBy.value = String(localStorage.getItem('sortBy') || sortBy.value || 'created_desc'); } catch (e) { }
                        try { loadDomains(); } catch (e) { }
                        try { loadLinks(1, { silent: true }); } catch (e) { }
                    }, { immediate: true });

                    let __searchDebounceTimer = null;
                    const debounceSearch = () => {
                        try { if (__searchDebounceTimer) clearTimeout(__searchDebounceTimer); } catch (e) { }
                        __searchDebounceTimer = setTimeout(() => {
                            try { loadLinks(1); } catch (e) { }
                        }, 300);
                    };
                    const viewMode = ref(localStorage.getItem('viewMode') || 'grid'), statsRange = ref('8h'), currentStatsSlug = ref(''), currentStatsId = ref(0), isDark = ref(localStorage.getItem('theme') === 'dark');
                    const sidebarOpen = ref(false);
                    const autoTheme = ref(false);
                    try { document.documentElement.setAttribute('data-theme', isDark.value ? 'dark' : 'light'); } catch (e) { }
                    let __autoThemeTimer = null;
                    let __autoThemeMql = null;
                    let __autoThemeMqlHandler = null;
                    const applyAutoTheme = () => {
                        try {
                            if (!autoTheme.value) return;
                            let shouldBeDark = false;
                            try {
                                if (window.matchMedia) {
                                    shouldBeDark = !!window.matchMedia('(prefers-color-scheme: dark)').matches;
                                } else {
                                    const hour = new Date().getHours();
                                    shouldBeDark = hour < 6 || hour >= 18;
                                }
                            } catch (e) {
                                const hour = new Date().getHours();
                                shouldBeDark = hour < 6 || hour >= 18;
                            }
                            isDark.value = shouldBeDark;
                            document.documentElement.setAttribute('data-theme', isDark.value ? 'dark' : 'light');
                            localStorage.setItem('theme', isDark.value ? 'dark' : 'light');
                        } catch (e) { }
                    };
                    const __detachAutoTheme = () => {
                        try { if (__autoThemeTimer) { clearInterval(__autoThemeTimer); __autoThemeTimer = null; } } catch (e) { }
                        try {
                            if (__autoThemeMql && __autoThemeMqlHandler) {
                                if (__autoThemeMql.removeEventListener) __autoThemeMql.removeEventListener('change', __autoThemeMqlHandler);
                                else if (__autoThemeMql.removeListener) __autoThemeMql.removeListener(__autoThemeMqlHandler);
                            }
                        } catch (e) { }
                        __autoThemeMql = null;
                        __autoThemeMqlHandler = null;
                    };
                    const toggleTheme = () => {
                        __detachAutoTheme();
                        autoTheme.value = false;
                        isDark.value = !isDark.value;
                        try { document.documentElement.setAttribute('data-theme', isDark.value ? 'dark' : 'light'); localStorage.setItem('theme', isDark.value ? 'dark' : 'light'); localStorage.setItem('autoTheme', 'false'); } catch (e) { }
                    };
                    const enableAutoTheme = () => {
                        try {
                            __detachAutoTheme();
                            autoTheme.value = true;
                            localStorage.setItem('autoTheme', 'true');
                            applyAutoTheme();
                            try {
                                if (window.matchMedia) {
                                    __autoThemeMql = window.matchMedia('(prefers-color-scheme: dark)');
                                    __autoThemeMqlHandler = () => { try { applyAutoTheme(); } catch (e) { } };
                                    if (__autoThemeMql.addEventListener) __autoThemeMql.addEventListener('change', __autoThemeMqlHandler);
                                    else if (__autoThemeMql.addListener) __autoThemeMql.addListener(__autoThemeMqlHandler);
                                } else {
                                    __autoThemeTimer = setInterval(applyAutoTheme, 60000);
                                }
                            } catch (e) {
                                try { __autoThemeTimer = setInterval(applyAutoTheme, 60000); } catch (e2) { }
                            }
                        } catch (e) { }
                    };

                    const simpleMode = ref(localStorage.getItem('simpleMode') !== '0');
                    const linkAdvancedOpen = ref(!simpleMode.value);
                    const landingAdvancedOpen = ref(!simpleMode.value);
                    const adminMenuOpen = ref(false);

                    try { refreshCaptcha(); } catch (e) { }
                    try { checkAuth(); } catch (e) { }

                    const selectedIds = ref([]);

                    const editMode = ref(false), saveLoading = ref(false);
                    const linkForm = reactive({
                        slug: '',
                        targets: '',
                        domain_id: null,
                        remark: '',
                        use_jump_page: false,
                        landing_mode: 'both',
                        pixel_id: '',
                        pixel_event_click: 'Lead',
                        pixel_event_auto: 'ViewContent',
                        tiktok_access_token: '',
                        tiktok_test_event_code: '',
                        marketing_options: '',
                        media_url: '',
                        btn_text: '',
                        page_title: '',
                        page_desc: '',
                        safe_url: '',
                        auto_jump: 0,
                        country_filter_list: '',
                        country_filter_allow: false,
                        device_filter_list: '',
                        device_filter_allow: false,
                    });

                    const __splitSimpleList = (raw) => {
                        return String(raw || '')
                            .split(/[\s,;\n\r\t]+/)
                            .map(x => String(x || '').trim().toUpperCase())
                            .filter(Boolean);
                    };
                    const countryFilterSelected = computed({
                        get() {
                            return __splitSimpleList(linkForm.country_filter_list);
                        },
                        set(v) {
                            const arr = Array.isArray(v) ? v : [];
                            linkForm.country_filter_list = arr.map(x => String(x || '').trim().toUpperCase()).filter(Boolean).join(',');
                        }
                    });

                    const countryFilterSearch = ref('');
                    const countryFilterAllCodes = computed(() => {
                        try {
                            return Object.keys(countryMap || {}).map(x => String(x || '').toUpperCase()).filter(Boolean).sort();
                        } catch (e) {
                            return [];
                        }
                    });
                    const countryFilterShownCodes = computed(() => {
                        const q = String(countryFilterSearch.value || '').trim().toLowerCase();
                        const all = Array.isArray(countryFilterAllCodes.value) ? countryFilterAllCodes.value : [];
                        if (!q) return all;
                        return all.filter(code => {
                            const name = String((countryMap && countryMap[code]) || '').toLowerCase();
                            return String(code || '').toLowerCase().includes(q) || name.includes(q);
                        });
                    });
                    const countryFilterToggle = (code) => {
                        const c = String(code || '').trim().toUpperCase();
                        if (!c) return;
                        const cur = Array.isArray(countryFilterSelected.value) ? countryFilterSelected.value.slice() : [];
                        const idx = cur.indexOf(c);
                        if (idx >= 0) cur.splice(idx, 1);
                        else cur.push(c);
                        countryFilterSelected.value = cur;
                    };
                    const countryFilterSelectAll = () => {
                        countryFilterSelected.value = (Array.isArray(countryFilterAllCodes.value) ? countryFilterAllCodes.value.slice() : []);
                    };
                    const countryFilterSelectNone = () => {
                        countryFilterSelected.value = [];
                    };
                    const countryFilterInvert = () => {
                        const all = new Set(Array.isArray(countryFilterAllCodes.value) ? countryFilterAllCodes.value : []);
                        const cur = new Set(Array.isArray(countryFilterSelected.value) ? countryFilterSelected.value : []);
                        const out = [];
                        for (const c of all) {
                            if (!cur.has(c)) out.push(c);
                        }
                        countryFilterSelected.value = out;
                    };

                    const deviceFilterAllCodes = ['iOS', 'Android', 'Windows', 'MacOS', 'Linux', 'Other'];
                    const __normalizeDeviceToken = (raw) => {
                        const t = String(raw || '').trim();
                        if (!t) return '';
                        const u = t.toUpperCase();
                        if (u === 'IOS') return 'iOS';
                        if (u === 'ANDROID') return 'Android';
                        if (u === 'WINDOWS') return 'Windows';
                        if (u === 'MACOS' || u === 'MAC') return 'MacOS';
                        if (u === 'LINUX') return 'Linux';
                        if (u === 'OTHER') return 'Other';
                        return '';
                    };
                    const deviceFilterSelected = computed({
                        get() {
                            const arr = __splitSimpleList(linkForm.device_filter_list);
                            const out = [];
                            for (const x of arr) {
                                const n = __normalizeDeviceToken(x);
                                if (n && !out.includes(n)) out.push(n);
                            }
                            return out;
                        },
                        set(v) {
                            const arr = Array.isArray(v) ? v : [];
                            const out = [];
                            for (const x of arr) {
                                const n = __normalizeDeviceToken(x);
                                if (n && !out.includes(n)) out.push(n);
                            }
                            linkForm.device_filter_list = out.join(',');
                        }
                    });
                    const deviceFilterToggle = (dev) => {
                        const d = __normalizeDeviceToken(dev);
                        if (!d) return;
                        const cur = Array.isArray(deviceFilterSelected.value) ? deviceFilterSelected.value.slice() : [];
                        const idx = cur.indexOf(d);
                        if (idx >= 0) cur.splice(idx, 1);
                        else cur.push(d);
                        deviceFilterSelected.value = cur;
                    };
                    const deviceFilterSelectAll = () => {
                        deviceFilterSelected.value = deviceFilterAllCodes.slice();
                    };
                    const deviceFilterSelectNone = () => {
                        deviceFilterSelected.value = [];
                    };
                    const deviceFilterInvert = () => {
                        const all = new Set(deviceFilterAllCodes);
                        const cur = new Set(Array.isArray(deviceFilterSelected.value) ? deviceFilterSelected.value : []);
                        const out = [];
                        for (const d of all) {
                            if (!cur.has(d)) out.push(d);
                        }
                        deviceFilterSelected.value = out;
                    };

                    const marketingOptionItems = ref([]);
                    const normalizeKey = (s) => {
                        return String(s || '')
                            .trim()
                            .replace(/\s+/g, '_')
                            .replace(/[^A-Za-z0-9_]/g, '')
                            .slice(0, 32);
                    };
                    const normalizeMode = (m) => {
                        const v = String(m || 'both').trim().toLowerCase();
                        return (v === 'media' || v === 'questions' || v === 'both') ? v : 'both';
                    };
                    const ensureMarketingKey = (it) => {
                        if (!it) return;
                        if (!String(it.key || '').trim() && String(it.label || '').trim()) {
                            it.key = normalizeKey(it.label);
                        } else {
                            it.key = normalizeKey(it.key);
                        }
                    };
                    const serializeMarketingOptions = () => {
                        const items = (Array.isArray(marketingOptionItems.value) ? marketingOptionItems.value : []).slice(0, 4);
                        const out = [];
                        for (const it of items) {
                            if (!it) continue;
                            const options = (Array.isArray(it.options) ? it.options : []).map(x => String(x || '').trim()).filter(Boolean).slice(0, 60);
                            const labelRaw = String(it.label || '').trim();
                            const label = labelRaw || (options.length ? ('Q' + String(out.length + 1)) : '');
                            const key = normalizeKey(it.key || label);
                            const type = String(it.type || 'select').trim().toLowerCase();
                            if (!key || !label) continue;
                            const obj = { key, label, type, options };
                            const def = String(it.default || '').trim();
                            if (def) {
                                if (type === 'checkbox') {
                                    obj.default = def.split(',').map(x => String(x || '').trim()).filter(Boolean);
                                } else {
                                    obj.default = def;
                                }
                            }
                            out.push(obj);
                        }
                        linkForm.marketing_options = out.length ? JSON.stringify(out) : '';
                    };
                    const loadMarketingOptionsFromJson = (raw) => {
                        const txt = String(raw || '').trim();
                        if (!txt) {
                            marketingOptionItems.value = [];
                            return;
                        }
                        try {
                            const cfg = JSON.parse(txt);
                            const arr = Array.isArray(cfg) ? cfg : (cfg && Array.isArray(cfg.items) ? cfg.items : []);
                            const items = [];
                            for (const x of (arr || []).slice(0, 4)) {
                                if (!x || typeof x !== 'object') continue;
                                const key = normalizeKey(x.key);
                                const label = String(x.label || '').trim();
                                const type = String(x.type || 'select').trim().toLowerCase();
                                let options = [];
                                if (Array.isArray(x.options)) {
                                    options = x.options.map(o => {
                                        if (o && typeof o === 'object') {
                                            return String(o.label || o.value || '').trim();
                                        }
                                        return String(o || '').trim();
                                    }).filter(Boolean);
                                }
                                let def = '';
                                if (Array.isArray(x.default)) def = x.default.map(z => String(z || '').trim()).filter(Boolean).join(',');
                                else if (x.default != null) def = String(x.default).trim();
                                if (!options.length) options = [''];
                                else options = options.concat(['']);
                                items.push({ _id: `${Date.now()}_${Math.random().toString(16).slice(2)}`, key: key || normalizeKey(label), label, type, options, default: def });
                            }
                            marketingOptionItems.value = items;
                        } catch {
                            marketingOptionItems.value = [];
                        }
                    };
                    const addMarketingOption = () => {
                        if (marketingOptionItems.value.length >= 4) return;
                        marketingOptionItems.value.push({ _id: `${Date.now()}_${Math.random().toString(16).slice(2)}`, key: '', label: '', type: 'select', options: [''], default: '' });
                    };
                    const removeMarketingOption = (idx) => {
                        marketingOptionItems.value.splice(idx, 1);
                    };
                    const moveMarketingOption = (idx, dir) => {
                        const to = idx + dir;
                        if (to < 0 || to >= marketingOptionItems.value.length) return;
                        const arr = marketingOptionItems.value;
                        const t = arr[idx];
                        arr[idx] = arr[to];
                        arr[to] = t;
                    };

                    const ensureOptionTrailingEmpty = (it) => {
                        if (!it) return;
                        if (!Array.isArray(it.options)) it.options = [''];
                        if (it.options.length === 0) it.options.push('');
                        const last = String(it.options[it.options.length - 1] || '').trim();
                        if (last) it.options.push('');
                        if (it.options.length > 20) it.options = it.options.slice(0, 20);
                    };
                    const addMarketingOptionAnswer = (it, idx) => {
                        if (!it) return;
                        if (!Array.isArray(it.options)) it.options = [''];
                        const pos = (typeof idx === 'number' ? idx + 1 : it.options.length);
                        it.options.splice(pos, 0, '');
                    };
                    const removeMarketingOptionAnswer = (it, idx) => {
                        if (!it || !Array.isArray(it.options)) return;
                        if (it.options.length <= 1) { it.options[0] = ''; return; }
                        it.options.splice(idx, 1);
                        if (it.options.length === 0) it.options.push('');
                    };

                    watch(marketingOptionItems, () => {
                        serializeMarketingOptions();
                    }, { deep: true });
                    const invForm = reactive({ product_id: 0, limit: 10, pack_days: 0, count: 1, valid_days: 30 }), invLoading = ref(false), newCodes = ref([]), inviteList = ref([]);
                    const inviteSubTab = ref((() => {
                        try {
                            const v = String(localStorage.getItem('inviteSubTab') || '').trim();
                            if (v === 'biz' || v === 'codes') return v;
                        } catch (e) { }
                        return 'codes';
                    })());
                    const productList = ref([]);
                    const productLoading = ref(false);
                    const productForm = reactive({ id: 0, name: '', add_links: 0, add_days: 0, price: '', enabled: true });
                    const paymentLoading = ref(false);
                    const paymentForm = reactive({ payment_text: '' });
                    const purchaseLoading = ref(false);
                    const purchaseInfo = ref(null);
                    const quotaProducts = computed(() => {
                        const ps = purchaseInfo.value && purchaseInfo.value.products;
                        const arr = Array.isArray(ps) ? ps : [];
                        return arr.filter(p => p && typeof p === 'object' && Number(p.add_links || 0) > 0);
                    });
                    const daysProducts = computed(() => {
                        const ps = purchaseInfo.value && purchaseInfo.value.products;
                        const arr = Array.isArray(ps) ? ps : [];
                        return arr.filter(p => p && typeof p === 'object' && Number(p.add_days || 0) > 0);
                    });

                    const resetProductForm = () => {
                        productForm.id = 0;
                        productForm.name = '';
                        productForm.add_links = 0;
                        productForm.add_days = 0;
                        productForm.price = '';
                        productForm.enabled = true;
                    };

                    const loadProducts = async () => {
                        productLoading.value = true;
                        try {
                            const r = await axios.get('/api/admin/products');
                            productList.value = (r && r.data && Array.isArray(r.data)) ? r.data : [];
                        } catch (e) {
                            productList.value = [];
                        } finally {
                            productLoading.value = false;
                        }
                    };

                    const editProduct = (p) => {
                        if (!p) return;
                        productForm.id = Number(p.id || 0) || 0;
                        productForm.name = String(p.name || '');
                        productForm.add_links = Number(p.add_links || 0) || 0;
                        productForm.add_days = Number(p.add_days || 0) || 0;
                        productForm.price = String(p.price || '');
                        productForm.enabled = !!p.enabled;
                    };

                    const saveProduct = async () => {
                        if (productLoading.value) return;
                        productLoading.value = true;
                        try {
                            await axios.post('/api/admin/product/save', {
                                id: Number(productForm.id || 0) || 0,
                                name: String(productForm.name || '').trim(),
                                add_links: Number(productForm.add_links || 0) || 0,
                                add_days: Number(productForm.add_days || 0) || 0,
                                price: String(productForm.price || ''),
                                enabled: !!productForm.enabled,
                            });
                            toastSuccess('保存成功');
                            resetProductForm();
                            await loadProducts();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '保存失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            productLoading.value = false;
                        }
                    };

                    const deleteProduct = async (id) => {
                        const pid = Number(id || 0);
                        if (pid <= 0) return;
                        if (!(await confirmDanger('删除套餐?', '删除后无法恢复', '删除'))) return;
                        productLoading.value = true;
                        try {
                            await axios.post('/api/admin/product/delete', { id: pid });
                            toastSuccess('已删除');
                            await loadProducts();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '删除失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            productLoading.value = false;
                        }
                    };

                    const toggleProductEnabled = async (p, ev) => {
                        try {
                            if (!p || productLoading.value) return;

                            productLoading.value = true;
                            try {
                                await axios.post('/api/admin/product/save', {
                                    id: Number(p.id || 0) || 0,
                                    name: String(p.name || '').trim(),
                                    add_links: Number(p.add_links || 0) || 0,
                                    add_days: Number(p.add_days || 0) || 0,
                                    price: String(p.price || ''),
                                    enabled: nextEnabled,
                                });
                                p.enabled = nextEnabled;
                                toastSuccess(nextEnabled ? '已启用' : '已停用');
                            } catch (e2) {
                                try { if (target) target.checked = prevEnabled; } catch (e3) { }
                                try { p.enabled = prevEnabled; } catch (e4) { }
                                __toastAxiosError(e2, '操作失败');
                            } finally {
                                productLoading.value = false;
                            }
                        } catch (e) {
                            try {
                                const target = ev && ev.target;
                                if (target) target.checked = !!(p && p.enabled);
                            } catch (e2) { }
                        }
                    };

                    const __parsePaymentText = (raw) => {
                        const txt = String(raw || '');
                        let qr = '';
                        try {
                            const lines = txt.split('\n');
                            const kept = [];
                            for (const ln of lines) {
                                const s = String(ln || '').trim();
                                const m1 = s.match(/^(QR_IMAGE|QR|QRCODE|二维码图片|二维码|收款码)\s*[:：]\s*(https?:\/\/\S+)\s*$/i);
                                if (m1 && m1[2]) {
                                    if (!qr) qr = String(m1[2] || '').trim();
                                    continue;
                                }
                                const m2 = s.match(/^!\[[^\]]*\]\((https?:\/\/[^\s\)]+)\)\s*$/i);
                                if (m2 && m2[1]) {
                                    if (!qr) qr = String(m2[1] || '').trim();
                                    continue;
                                }
                                kept.push(ln);
                            }
                            return { qrUrl: qr, text: kept.join('\n').trim() };
                        } catch (e) {
                            return { qrUrl: '', text: txt };
                        }
                    };

                    const __composePaymentText = (qrUrl, text) => {
                        const qr = String(qrUrl || '').trim();
                        const t = String(text || '').trim();
                        if (!qr) return t;
                        return `QR_IMAGE: ${qr}\n` + t;
                    };

                    const paymentQrUrl = ref('');
                    const applyPaymentTemplate = (type) => {
                        const t = String(type || '').trim();
                        if (t === 'wechat') {
                            paymentForm.payment_text = '收款方式：微信\n请备注：用户名/订单号\n如需卡密请联系管理员';
                            if (!paymentQrUrl.value) paymentQrUrl.value = '';
                            return;
                        }
                        if (t === 'alipay') {
                            paymentForm.payment_text = '收款方式：支付宝\n请备注：用户名/订单号\n如需卡密请联系管理员';
                            if (!paymentQrUrl.value) paymentQrUrl.value = '';
                            return;
                        }
                        if (t === 'usdt') {
                            paymentForm.payment_text = '收款方式：USDT(TRC20)\n地址：\n请备注：用户名/订单号';
                            if (!paymentQrUrl.value) paymentQrUrl.value = '';
                            return;
                        }
                        paymentForm.payment_text = '收款方式：\n收款账号/地址：\n备注说明：';
                        if (!paymentQrUrl.value) paymentQrUrl.value = '';
                    };

                    const loadPaymentSettings = async () => {
                        paymentLoading.value = true;
                        try {
                            const r = await axios.get('/api/admin/payment_settings');
                            const raw = (r && r.data && typeof r.data.payment_text === 'string') ? r.data.payment_text : '';
                            const parsed = __parsePaymentText(raw);
                            paymentQrUrl.value = String(parsed.qrUrl || '');
                            paymentForm.payment_text = String(parsed.text || '');
                        } catch (e) {
                            paymentForm.payment_text = '';
                            paymentQrUrl.value = '';
                        } finally {
                            paymentLoading.value = false;
                        }
                    };

                    const __ensureInviteProductsLoaded = async () => {
                        try {
                            if (!user.value) return;
                            if (currentTab.value !== 'invites') return;
                            if (productList.value && productList.value.length) return;
                            await loadProducts();
                        } catch (e) { }
                    };

                    const __ensureInviteBizLoaded = async () => {
                        try {
                            if (!user.value) return;
                            if (currentTab.value !== 'invites') return;
                            if (inviteSubTab.value !== 'biz') return;
                            await __ensureInviteProductsLoaded();
                            await loadPaymentSettings();
                        } catch (e) { }
                    };

                    watch(inviteSubTab, (v) => {
                        try { localStorage.setItem('inviteSubTab', String(v || 'codes')); } catch (e) { }
                        try {
                            if (v === 'biz') __ensureInviteBizLoaded();
                            else __ensureInviteProductsLoaded();
                        } catch (e) { }
                    }, { immediate: true });

                    const savePaymentSettings = async () => {
                        paymentLoading.value = true;
                        try {
                            const composed = __composePaymentText(paymentQrUrl.value, paymentForm.payment_text);
                            await axios.post('/api/admin/payment_settings', { payment_text: String(composed || '') });
                            toastSuccess('已保存');
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '保存失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            paymentLoading.value = false;
                        }
                    };

                    const purchasePaymentParsed = computed(() => {
                        try {
                            const raw = (purchaseInfo.value && typeof purchaseInfo.value.payment_text === 'string') ? purchaseInfo.value.payment_text : '';
                            return __parsePaymentText(raw);
                        } catch (e) {
                            return { qrUrl: '', text: '' };
                        }
                    });
                    const purchasePaymentQr = computed(() => String((purchasePaymentParsed.value && purchasePaymentParsed.value.qrUrl) || '').trim());
                    const purchasePaymentText = computed(() => String((purchasePaymentParsed.value && purchasePaymentParsed.value.text) || '').trim());

                    const loadPurchaseInfo = async () => {
                        purchaseLoading.value = true;
                        try {
                            const r = await axios.get('/api/user/purchase_info');
                            purchaseInfo.value = (r && r.data && typeof r.data === 'object') ? r.data : null;
                        } catch (e) {
                            purchaseInfo.value = null;
                        } finally {
                            purchaseLoading.value = false;
                        }
                    };
                    const statsData = reactive({ pv: 0, uv: 0, geo: {}, os: {}, source: {} }), profileForm = reactive({ username: '', new_password: '', current_password: '' });
                    const redeemForm = reactive({ code: '' });
                    const redeemLoading = ref(false);
                    const redeemResult = ref(null);
                    const qrUrl = ref('');
                    const qrImgSrc = ref('');
                    const qrLoading = ref(false);
                    const qrError = ref('');
                    const bulkRemarkText = ref('');
                    const bulkRemarkSaving = ref(false);
                    const swipeState = reactive({
                        startX: 0,
                        startY: 0,
                        currentX: 0,
                        isSwiping: false,
                        swipingId: null,
                    });
                    let pollTimer = null, linkModal = null, statsModal = null, userModal = null, domainPermModal = null, redeemModal = null, qrModal = null, bulkRemarkModal = null, chartInstances = {}, mapChart = null, trendChart = null;
                    const domain = window.location.host;
                    const newDomain = ref(''), newDomainPublic = ref(true), domainLoading = ref(false), domainList = ref([]), allPrivateDomains = ref([]);
                    const userList = ref([]), usersLoading = ref(false), userForm = reactive({ id: 0, link_limit: 10, expire_time: '', password: '' }), selectedDomains = ref([]);

                    const __selectedDomainUserId = ref(0);
                    const __getModal = (id) => {
                        try {
                            const el = document.getElementById(id);
                            if (!el || !window.bootstrap || !window.bootstrap.Modal) return null;
                            if (window.bootstrap.Modal.getOrCreateInstance) return window.bootstrap.Modal.getOrCreateInstance(el);
                            return new window.bootstrap.Modal(el);
                        } catch (e) {
                            return null;
                        }
                    };

                    const __disposeStatsCharts = () => {
                        try { if (trendChart) trendChart.dispose(); } catch (e) { }
                        try {
                            if (chartInstances && typeof chartInstances === 'object') {
                                Object.keys(chartInstances).forEach(k => {
                                    try { chartInstances[k] && chartInstances[k].dispose && chartInstances[k].dispose(); } catch (e) { }
                                });
                            }
                        } catch (e) { }
                        try { if (mapChart) mapChart.dispose(); } catch (e) { }
                        trendChart = null;
                        mapChart = null;
                        chartInstances = {};
                    };

                    const __stopLinkPoll = () => {
                        try { if (pollTimer) clearInterval(pollTimer); } catch (e) { }
                        pollTimer = null;
                    };
                    const __startLinkPoll = () => {
                        __stopLinkPoll();
                        pollTimer = setInterval(() => {
                            try {
                                if (!user.value) return;
                                if (!(currentTab.value === 'links' || currentTab.value === 'all_links')) return;
                                if (loadingLinks.value || isAutoRefreshing.value) return;
                                loadLinks(page.value || 1, { silent: true });
                            } catch (e) { }
                        }, 3000);
                    };

                    watch([currentTab, user], () => {
                        try {
                            if (user.value && (currentTab.value === 'links' || currentTab.value === 'all_links')) __startLinkPoll();
                            else __stopLinkPoll();
                        } catch (e) { }
                    }, { immediate: true });

                    watch([currentTab, user], () => {
                        try {
                            if (!user.value) return;
                            if (currentTab.value === 'links' || currentTab.value === 'all_links') {
                                try { selectedIds.value = []; } catch (e) { }
                                loadLinks(1);
                            }
                            if (currentTab.value === 'users') {
                                loadUsers();
                            }
                            if (currentTab.value === 'invites') {
                                loadInvites();
                                __ensureInviteProductsLoaded();
                                __ensureInviteBizLoaded();
                            }
                        } catch (e) { }
                    }, { immediate: true });

                    onUnmounted(() => {
                        __stopLinkPoll();
                        __disposeStatsCharts();
                    });

                    const handleGlobalKeydown = (e) => {
                        try {
                            const target = e.target;
                            const isInput = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT' || target.isContentEditable);
                            if (e.key === 'Escape') {
                                try {
                                    if (linkModal && linkModal._element && linkModal._element.classList.contains('show')) {
                                        linkModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (statsModal && statsModal._element && statsModal._element.classList.contains('show')) {
                                        statsModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (userModal && userModal._element && userModal._element.classList.contains('show')) {
                                        userModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (domainPermModal && domainPermModal._element && domainPermModal._element.classList.contains('show')) {
                                        domainPermModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (redeemModal && redeemModal._element && redeemModal._element.classList.contains('show')) {
                                        redeemModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (qrModal && qrModal._element && qrModal._element.classList.contains('show')) {
                                        qrModal.hide();
                                        e.preventDefault();
                                        return;
                                    }
                                    if (advancedFilterOpen.value) {
                                        advancedFilterOpen.value = false;
                                        e.preventDefault();
                                        return;
                                    }
                                } catch (e) { }
                            }
                            if (isInput) return;
                            if (e.key === 'n' || e.key === 'N') {
                                if ((currentTab.value === 'links' || currentTab.value === 'all_links') && currentTab.value === 'links') {
                                    openLinkModal();
                                    e.preventDefault();
                                }
                            } else if (e.key === 's' || e.key === 'S') {
                                if (currentTab.value === 'links' || currentTab.value === 'all_links') {
                                    try {
                                        const searchInput = document.querySelector('.toolbar-search input');
                                        if (searchInput) {
                                            searchInput.focus();
                                            searchInput.select();
                                            e.preventDefault();
                                        }
                                    } catch (e) { }
                                }
                            } else if (e.key === 'f' || e.key === 'F') {
                                if (currentTab.value === 'links' || currentTab.value === 'all_links') {
                                    advancedFilterOpen.value = !advancedFilterOpen.value;
                                    e.preventDefault();
                                }
                            }
                        } catch (e) { }
                    };

                    const openBulkEditRemark = () => {
                        try {
                            if (selectedIds.value.length === 0) return;
                            bulkRemarkText.value = '';
                            if (!bulkRemarkModal) bulkRemarkModal = __getModal('bulkRemarkModal');
                            if (bulkRemarkModal) bulkRemarkModal.show();
                        } catch (e) { }
                    };
                    const saveBulkRemark = async () => {
                        try {
                            if (selectedIds.value.length === 0) return;
                            bulkRemarkSaving.value = true;
                            const ids = [...selectedIds.value];
                            const remark = String(bulkRemarkText.value || '').trim();
                            let successCount = 0;
                            for (const id of ids) {
                                try {
                                    const link = links.value.find(l => l.id === id);
                                    if (!link) continue;
                                    const payload = {
                                        id: link.id,
                                        slug: link.slug,
                                        targets: Array.isArray(link.targets) ? link.targets.join('\n') : '',
                                        remark: remark,
                                        use_jump_page: !!link.use_jump_page,
                                        domain_id: link.domain_id || null,
                                    };
                                    await axios.post('/api/link', payload);
                                    successCount++;
                                } catch (e) { }
                            }
                            if (bulkRemarkModal) bulkRemarkModal.hide();
                            toastSuccess(`已更新 ${successCount} 条短链的备注`);
                            clearSelection();
                            await loadLinks(page.value || 1);
                        } catch (e) {
                            toastError('批量修改失败');
                        } finally {
                            bulkRemarkSaving.value = false;
                        }
                    };

                    const handleTouchStart = (e, id) => {
                        try {
                            if (window.innerWidth >= 992) return;
                            const touch = e.touches[0];
                            swipeState.startX = touch.clientX;
                            swipeState.startY = touch.clientY;
                            swipeState.currentX = 0;
                            swipeState.isSwiping = false;
                            swipeState.swipingId = id;
                        } catch (e) { }
                    };
                    const handleTouchMove = (e, id) => {
                        try {
                            if (window.innerWidth >= 992 || swipeState.swipingId !== id) return;
                            const touch = e.touches[0];
                            const deltaX = touch.clientX - swipeState.startX;
                            const deltaY = touch.clientY - swipeState.startY;
                            if (!swipeState.isSwiping && Math.abs(deltaX) > 10) {
                                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                                    swipeState.isSwiping = true;
                                }
                            }
                            if (swipeState.isSwiping && deltaX < 0) {
                                swipeState.currentX = Math.max(deltaX, -120);
                                const el = e.currentTarget;
                                if (el) {
                                    el.style.transform = `translateX(${swipeState.currentX}px)`;
                                    el.classList.add('swiping');
                                }
                                e.preventDefault();
                            }
                        } catch (e) { }
                    };
                    const handleTouchEnd = (e, id) => {
                        try {
                            if (window.innerWidth >= 992 || swipeState.swipingId !== id) return;
                            const el = e.currentTarget;
                            if (el) {
                                el.classList.remove('swiping');
                                if (swipeState.currentX < -60) {
                                    el.style.transform = 'translateX(-120px)';
                                } else {
                                    el.style.transform = 'translateX(0)';
                                }
                            }
                            swipeState.isSwiping = false;
                            swipeState.swipingId = null;
                        } catch (e) { }
                    };

                    onMounted(() => {
                        try {
                            linkModal = __getModal('linkModal');
                            statsModal = __getModal('statsModal');
                            userModal = __getModal('userModal');
                            domainPermModal = __getModal('domainPermModal');
                            redeemModal = __getModal('redeemModal');
                            qrModal = __getModal('qrModal');
                            bulkRemarkModal = __getModal('bulkRemarkModal');
                        } catch (e) { }

                        try {
                            window.addEventListener('keydown', handleGlobalKeydown);
                        } catch (e) { }

                        try {
                            const savedAutoTheme = localStorage.getItem('autoTheme');
                            if (savedAutoTheme === 'true') {
                                enableAutoTheme();
                            }
                        } catch (e) { }

                        try {
                            const el = document.getElementById('statsModal');
                            if (el) {
                                el.addEventListener('hidden.bs.modal', () => {
                                    try { __disposeStatsCharts(); } catch (e) { }
                                });
                            }
                        } catch (e) { }
                    });

                    const loadDomains = async () => {
                        domainLoading.value = true;
                        try {
                            const r = await axios.get('/api/domains');
                            const arr = (r && r.data && Array.isArray(r.data)) ? r.data : [];
                            domainList.value = arr;
                            allPrivateDomains.value = arr.filter(d => d && typeof d === 'object' && !d.is_public);
                        } catch (e) {
                            domainList.value = [];
                            allPrivateDomains.value = [];
                        } finally {
                            domainLoading.value = false;
                        }
                    };

                    const addDomain = async () => {
                        const dom = String(newDomain.value || '').trim();
                        if (!dom) return toastWarn('请输入域名');
                        domainLoading.value = true;
                        try {
                            await axios.post('/api/domain/add', { domain: dom, is_public: !!newDomainPublic.value });
                            toastSuccess('已添加');
                            newDomain.value = '';
                            await loadDomains();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '添加失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            domainLoading.value = false;
                        }
                    };

                    const toggleDomainPublic = async (d) => {
                        if (!d || !d.id) return;
                        domainLoading.value = true;
                        try {
                            await axios.post('/api/domain/update', { id: Number(d.id), is_public: !d.is_public });
                            await loadDomains();
                        } catch (e) {
                        } finally {
                            domainLoading.value = false;
                        }
                    };

                    const deleteDomain = async (id) => {
                        const did = Number(id || 0);
                        if (did <= 0) return;
                        if (!(await confirmDanger('删除域名?', '删除后无法恢复', '删除'))) return;
                        domainLoading.value = true;
                        try {
                            await axios.post('/api/domain/delete', { id: did });
                            toastSuccess('已删除');
                            await loadDomains();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '删除失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            domainLoading.value = false;
                        }
                    };

                    const openUserDomainModal = async (u) => {
                        if (!u || !u.id) return;
                        __selectedDomainUserId.value = Number(u.id) || 0;
                        try { await loadDomains(); } catch (e) { }
                        try {
                            const r = await axios.get('/api/admin/user/domains', { params: { user_id: __selectedDomainUserId.value } });
                            selectedDomains.value = (r && r.data && Array.isArray(r.data)) ? r.data.map(x => Number(x)) : [];
                        } catch (e) {
                            selectedDomains.value = [];
                        }
                        try {
                            domainPermModal = __getModal('domainPermModal');
                            domainPermModal && domainPermModal.show();
                        } catch (e) { }
                    };

                    const saveUserDomains = async () => {
                        if (!__selectedDomainUserId.value) return;
                        try {
                            await axios.post('/api/admin/user/domains/update', {
                                user_id: __selectedDomainUserId.value,
                                domain_ids: Array.isArray(selectedDomains.value) ? selectedDomains.value.map(x => Number(x)) : [],
                            });
                            toastSuccess('已保存');
                            try { domainPermModal && domainPermModal.hide(); } catch (e) { }
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '保存失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        }
                    };

                    const safeUserList = computed(() => {
                        const arr = Array.isArray(userList.value) ? userList.value : [];
                        return arr.filter(u => u && typeof u === 'object');
                    });
                    const safeInviteList = computed(() => {
                        const arr = Array.isArray(inviteList.value) ? inviteList.value : [];
                        return arr.filter(i => i && typeof i === 'object');
                    });
                    const inviteUsedByText = (i) => {
                        try {
                            const inv = (i && typeof i === 'object') ? i : {};
                            const usedBy = inv.used_by;
                            const name = inv.used_by_name || (usedBy && (usedBy.username || usedBy.name)) || '';
                            return name ? String(name) : '-';
                        } catch (e) {
                            return '-';
                        }
                    };
                    const isUpdating = ref(false), updateStatus = ref(null);
                    const inviteStatus = (i) => {
                        try {
                            const inv = (i && typeof i === 'object') ? i : {};
                            const expiresRaw = inv.expires_at || inv.expire_time || '';
                            const expiresAt = expiresRaw ? new Date(String(expiresRaw).replace(/-/g, '/')) : null;
                            const now = new Date();
                            const isExpired = !!(expiresAt && !isNaN(expiresAt.getTime()) && expiresAt.getTime() < now.getTime());

                            const usedBy = inv.used_by;
                            const usedByName = inv.used_by_name || usedBy?.username || usedBy?.name || '';
                            const isUsed = !!(inv.used_by_id || usedByName || inv.used_at);

                            if (isUsed) return { cls: 'bg-success', text: '已使用' };
                            if (isExpired) return { cls: 'bg-secondary', text: '已过期' };
                            return { cls: 'bg-warning text-dark', text: '未使用' };
                        } catch (e) {
                            return { cls: 'bg-secondary', text: '-' };
                        }
                    };

                    const loadUsers = async () => {
                        usersLoading.value = true;
                        try {
                            const r = await axios.get('/api/admin/users');
                            userList.value = r.data || [];
                        } catch (e) {
                            userList.value = [];
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '加载用户失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        } finally {
                            usersLoading.value = false;
                        }
                    };
                    const loadInvites = async () => { try { const r = await axios.get('/api/admin/invites'); inviteList.value = r.data || []; } catch { } };
                    const editUser = (u) => { if (!u) return; userForm.id = u.id; userForm.link_limit = u.link_limit || 10; userForm.expire_time = u.expire_time || ''; userForm.password = ''; userModal && userModal.show(); };
                    const saveUser = async () => {
                        try {
                            await axios.post('/api/admin/user/update', userForm);
                            toastSuccess('保存成功');
                            userModal && userModal.hide();
                            await loadUsers();
                        } catch (e) {
                            try {
                                const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '保存失败';
                                toastError(String(msg));
                            } catch (e2) { }
                        }
                    };
                    const deleteUser = async (id) => {
                        if (!(await confirmDanger('删除用户?', '删除后无法恢复', '删除'))) return;
                        try { await axios.post('/api/admin/user/delete', { id }); toastSuccess('已删除'); await loadUsers(); }
                        catch (e) { try { const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '删除失败'; toastError(String(msg)); } catch (e2) { } }
                    };
                    const deleteInvite = async (code) => {
                        if (!(await confirmDanger('删除邀请码?', '删除后无法恢复', '删除'))) return;
                        try { await axios.post('/api/admin/invite/delete', { code }); toastSuccess('已删除'); await loadInvites(); }
                        catch (e) { try { const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || '删除失败'; toastError(String(msg)); } catch (e2) { } }
                    };

                    const switchView = (mode) => { viewMode.value = mode; localStorage.setItem('viewMode', mode); };

                    const displayedLinks = computed(() => {
                        try {
                            const arr = Array.isArray(links.value) ? links.value : [];
                            const q = String(searchQuery.value || '').trim().toLowerCase();
                            const fType = String(filterType.value || 'all');
                            const sBy = String(sortBy.value || 'created_desc');
                            let filtered = arr;
                            if (q) {
                                filtered = filtered.filter(x => {
                                    try {
                                        const slug = String(x.slug || '').toLowerCase();
                                        const remark = String(x.remark || '').toLowerCase();
                                        const targets = (x.targets && Array.isArray(x.targets)) ? x.targets.map(t => String(t || '').toLowerCase()).join(' ') : '';
                                        return slug.includes(q) || remark.includes(q) || targets.includes(q);
                                    } catch (e) { return false; }
                                });
                            }
                            if (fType === 'jump') filtered = filtered.filter(x => !!x.use_jump_page);
                            else if (fType === 'direct') filtered = filtered.filter(x => !x.use_jump_page);
                            if (hasActiveAdvancedFilters.value) {
                                if (advFilters.timeRange) {
                                    const now = new Date();
                                    let startTime = null;
                                    if (advFilters.timeRange === 'today') {
                                        startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    } else if (advFilters.timeRange === 'week') {
                                        startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                    } else if (advFilters.timeRange === 'month') {
                                        startTime = new Date(now.getFullYear(), now.getMonth(), 1);
                                    } else if (advFilters.timeRange === 'custom' && advFilters.startDate) {
                                        startTime = new Date(advFilters.startDate);
                                    }
                                    if (startTime) {
                                        filtered = filtered.filter(x => {
                                            try {
                                                const created = new Date(x.created_at || '');
                                                if (advFilters.timeRange === 'custom' && advFilters.endDate) {
                                                    const endTime = new Date(advFilters.endDate);
                                                    return created >= startTime && created <= endTime;
                                                }
                                                return created >= startTime;
                                            } catch (e) { return false; }
                                        });
                                    }
                                }
                                if (advFilters.pvMin !== null || advFilters.pvMax !== null) {
                                    filtered = filtered.filter(x => {
                                        try {
                                            const pv = Number(x.pv || 0) || 0;
                                            if (advFilters.pvMin !== null && pv < advFilters.pvMin) return false;
                                            if (advFilters.pvMax !== null && pv > advFilters.pvMax) return false;
                                            return true;
                                        } catch (e) { return false; }
                                    });
                                }
                                if (advFilters.uvMin !== null || advFilters.uvMax !== null) {
                                    filtered = filtered.filter(x => {
                                        try {
                                            const uv = Number(x.uv || 0) || 0;
                                            if (advFilters.uvMin !== null && uv < advFilters.uvMin) return false;
                                            if (advFilters.uvMax !== null && uv > advFilters.uvMax) return false;
                                            return true;
                                        } catch (e) { return false; }
                                    });
                                }
                                if (advFilters.domain) {
                                    filtered = filtered.filter(x => {
                                        try {
                                            const linkDomain = String(x.domain || window.location.host).toLowerCase();
                                            return linkDomain === String(advFilters.domain).toLowerCase();
                                        } catch (e) { return false; }
                                    });
                                }
                                if (advFilters.remarkKeyword) {
                                    const kw = String(advFilters.remarkKeyword).toLowerCase();
                                    filtered = filtered.filter(x => {
                                        try {
                                            const remark = String(x.remark || '').toLowerCase();
                                            return remark.includes(kw);
                                        } catch (e) { return false; }
                                    });
                                }
                            }
                            if (sBy === 'created_asc') filtered.sort((a, b) => String(a.created_at || '').localeCompare(String(b.created_at || '')));
                            else if (sBy === 'created_desc') filtered.sort((a, b) => String(b.created_at || '').localeCompare(String(a.created_at || '')));
                            else if (sBy === 'pv_desc') filtered.sort((a, b) => (Number(b.pv || 0) || 0) - (Number(a.pv || 0) || 0));
                            else if (sBy === 'uv_desc') filtered.sort((a, b) => (Number(b.uv || 0) || 0) - (Number(a.uv || 0) || 0));
                            else if (sBy === 'slug_asc') filtered.sort((a, b) => String(a.slug || '').localeCompare(String(b.slug || '')));
                            return filtered;
                        } catch (e) {
                            return Array.isArray(links.value) ? links.value : [];
                        }
                    });

                    const isAllSelected = computed(() => displayedLinks.value.length > 0 && displayedLinks.value.every(x => selectedIds.value.includes(x.id)));
                    const toggleSelectAll = () => {
                        if (isAllSelected.value) {
                            selectedIds.value = [];
                        } else {
                            selectedIds.value = displayedLinks.value.map(x => x.id);
                        }
                    };
                    const clearSelection = () => { selectedIds.value = []; };

                    const writeClipboard = async (text) => {
                        try {
                            await navigator.clipboard.writeText(text);
                            toastSuccess('复制成功');
                        } catch {
                            toastError('复制失败（浏览器不支持剪贴板）');
                        }
                    };
                    const buildUrl = (l) => {
                        const host = (l.domain || window.location.host);
                        return window.location.protocol + '//' + host + '/' + l.slug;
                    };
                    const modeLabel = (m) => {
                        const v = String(m || 'both').trim().toLowerCase();
                        if (v === 'media') return '仅媒体';
                        if (v === 'questions') return '仅问卷';
                        return '合并';
                    };
                    const copyByMode = async (l, mode) => {
                        if (!l) return;
                        if (mode === 'slug') return writeClipboard(String(l.slug || ''));
                        if (mode === 'target') return writeClipboard(String((l.targets && l.targets[0]) || ''));
                        return writeClipboard(buildUrl(l));
                    };

                    const bulkCopyPrompt = async () => {
                        if (selectedIds.value.length === 0) return;
                        const { value: mode } = await Swal.fire({
                            title: '选择复制模式',
                            input: 'select',
                            inputOptions: { full: '复制完整短链', slug: '复制 slug', target: '复制目标URL' },
                            inputValue: 'full',
                            showCancelButton: true,
                            confirmButtonText: '复制',
                        });
                        if (!mode) return;
                        const chosen = displayedLinks.value.filter(x => selectedIds.value.includes(x.id));
                        const lines = chosen.map(l => mode === 'slug' ? String(l.slug || '') : mode === 'target' ? String((l.targets && l.targets[0]) || '') : buildUrl(l));
                        await writeClipboard(lines.join('\n'));
                    };

                    const bulkDeleteSelected = async () => {
                        if (selectedIds.value.length === 0) return;
                        if (!(await confirmDanger('批量删除?', `将删除 ${selectedIds.value.length} 条短链`, '删除'))) return;
                        const ids = [...selectedIds.value];
                        for (const id of ids) {
                            try { await axios.post('/api/delete', { id }); } catch { }
                        }
                        clearSelection();
                        toastSuccess('批量删除完成');
                        await loadLinks(page.value);
                    };

                    const currentTabName = computed(() => ({ links: '短链管理', invites: '邀请码管理', system: '系统维护', profile: '账号设置', domains: '域名管理', users: '用户管理', all_links: '全站短链', landing: '落地页设置' }[currentTab.value]));

                    watch(sidebarOpen, v => {
                        if (window.innerWidth < 992) {
                            if (v) document.body.classList.add('sidebar-locked');
                            else document.body.classList.remove('sidebar-locked');
                        }
                    });

                    watch(simpleMode, v => {
                        try { localStorage.setItem('simpleMode', v ? '1' : '0'); } catch (e) { }
                        if (!v) {
                            linkAdvancedOpen.value = true;
                            landingAdvancedOpen.value = true;
                            adminMenuOpen.value = true;
                        } else {
                            linkAdvancedOpen.value = false;
                            landingAdvancedOpen.value = false;
                            adminMenuOpen.value = false;
                        }
                    });

                    const updateBackend = ref(false);
                    const performUpdate = async () => {
                        if (await confirmInfo('确认更新?', '系统将重启以应用新功能。', '立即更新')) {
                            isUpdating.value = true; updateStatus.value = null;
                            try {
                                await axios.post('/api/admin/system/update_files', { confirm: true, update_backend: !!updateBackend.value });
                                updateStatus.value = { type: 'success', msg: '更新成功！正在重启...' };
                                setTimeout(() => { location.reload(); }, 10000);
                            } catch (e) { isUpdating.value = false; updateStatus.value = { type: 'error', msg: ((e && e.response && e.response.data && e.response.data.error) || '更新失败') }; }
                        }
                    };

                    const landingLink = ref(null);
                    const landingBackTab = ref('links');
                    const openLandingSettings = (l) => {
                        if (!l) return;
                        landingBackTab.value = currentTab.value;
                        currentTab.value = 'landing';
                        landingLink.value = l;
                        landingAdvancedOpen.value = !simpleMode.value;
                        linkForm.slug = l.slug;
                        linkForm.targets = (l.targets || []).join('\n');
                        linkForm.domain_id = l.domain_id;
                        linkForm.remark = l.remark;
                        linkForm.use_jump_page = l.use_jump_page || false;
                        linkForm.landing_mode = normalizeMode(l.landing_mode || 'both');
                        linkForm.pixel_id = l.pixel_id || '';
                        linkForm.pixel_event_click = l.pixel_event_click || 'Lead';
                        linkForm.pixel_event_auto = l.pixel_event_auto || 'ViewContent';
                        linkForm.tiktok_access_token = l.tiktok_access_token || '';
                        linkForm.tiktok_test_event_code = l.tiktok_test_event_code || '';
                        linkForm.marketing_options = l.marketing_options || '';
                        loadMarketingOptionsFromJson(linkForm.marketing_options);
                        linkForm.media_url = l.media_url || '';
                        linkForm.btn_text = l.btn_text || '';
                        linkForm.safe_url = l.safe_url || '';
                        linkForm.auto_jump = l.auto_jump || 0;
                        linkForm.country_filter_list = l.country_filter_list || '';
                        linkForm.country_filter_allow = !!l.country_filter_allow;
                        linkForm.device_filter_list = l.device_filter_list || '';
                        linkForm.device_filter_allow = !!l.device_filter_allow;
                    };

                    const __landingBuildLink = () => {
                        const slug = String(linkForm.slug || '').trim();
                        const domObj = (Array.isArray(domainList.value) ? domainList.value : []).find(x => x && Number(x.id) === Number(linkForm.domain_id));
                        return {
                            slug,
                            domain: domObj ? String(domObj.domain || '') : '',
                        };
                    };

                    const openLandingFromModal = () => {
                        try { landingBackTab.value = currentTab.value; } catch (e) { }
                        try { currentTab.value = 'landing'; } catch (e) { }
                        try {
                            landingLink.value = {
                                slug: String(linkForm.slug || '').trim(),
                                targets: String(linkForm.targets || '').split('\n').map(x => String(x || '').trim()).filter(Boolean),
                                domain_id: linkForm.domain_id,
                                remark: linkForm.remark,
                                use_jump_page: !!linkForm.use_jump_page,
                                landing_mode: linkForm.landing_mode,
                                pixel_id: linkForm.pixel_id,
                                pixel_event_click: linkForm.pixel_event_click,
                                pixel_event_auto: linkForm.pixel_event_auto,
                                tiktok_access_token: linkForm.tiktok_access_token,
                                tiktok_test_event_code: linkForm.tiktok_test_event_code,
                                marketing_options: linkForm.marketing_options,
                                media_url: linkForm.media_url,
                                btn_text: linkForm.btn_text,
                                safe_url: linkForm.safe_url,
                                auto_jump: linkForm.auto_jump,
                                country_filter_list: linkForm.country_filter_list,
                                country_filter_allow: !!linkForm.country_filter_allow,
                                device_filter_list: linkForm.device_filter_list,
                                device_filter_allow: !!linkForm.device_filter_allow,
                            };
                        } catch (e) {
                            landingLink.value = null;
                        }
                        try { linkModal && linkModal.hide(); } catch (e) { }
                    };

                    const backFromLanding = () => {
                        try { currentTab.value = landingBackTab.value || 'links'; } catch (e) { }
                        try { landingLink.value = null; } catch (e) { }
                        try { loadLinks(page.value || 1); } catch (e) { }
                    };

                    const previewLanding = () => {
                        try {
                            const l = __landingBuildLink();
                            if (!l.slug) return;
                            window.open(buildUrl(l), '_blank');
                        } catch (e) { }
                    };

                    const __normalizeLinkPayload = () => {
                        const slug = String(linkForm.slug || '').trim();
                        const targets = String(linkForm.targets || '').trim();
                        if (!slug) {
                            try { toastWarn('请填写 Slug'); } catch (e) { }
                            return null;
                        }
                        if (!/^[a-zA-Z0-9_-]+$/.test(slug)) {
                            try { toastWarn('Slug 仅支持字母/数字/_/-'); } catch (e) { }
                            return null;
                        }
                        if (!targets) {
                            try { toastWarn('请填写目标网址'); } catch (e) { }
                            return null;
                        }
                        const didRaw = linkForm.domain_id;
                        const did = (didRaw === null || didRaw === undefined || didRaw === '') ? null : (Number(didRaw) || 0);
                        return {
                            slug,
                            targets,
                            domain_id: did ? did : null,
                            remark: String(linkForm.remark || ''),
                            use_jump_page: !!linkForm.use_jump_page,
                            landing_mode: String(linkForm.landing_mode || 'both'),
                            pixel_id: String(linkForm.pixel_id || ''),
                            pixel_event_click: String(linkForm.pixel_event_click || 'Lead'),
                            pixel_event_auto: String(linkForm.pixel_event_auto || 'ViewContent'),
                            media_url: String(linkForm.media_url || ''),
                            btn_text: String(linkForm.btn_text || ''),
                            page_title: String(linkForm.page_title || ''),
                            page_desc: String(linkForm.page_desc || ''),
                            safe_url: String(linkForm.safe_url || ''),
                            auto_jump: Number(linkForm.auto_jump || 0) || 0,
                            tiktok_access_token: String(linkForm.tiktok_access_token || ''),
                            tiktok_test_event_code: String(linkForm.tiktok_test_event_code || ''),
                            marketing_options: String(linkForm.marketing_options || ''),
                            country_filter_list: String(linkForm.country_filter_list || ''),
                            country_filter_allow: !!linkForm.country_filter_allow,
                            device_filter_list: String(linkForm.device_filter_list || ''),
                            device_filter_allow: !!linkForm.device_filter_allow,
                        };
                    };

                    const __toastAxiosError = (e, fallbackTitle = '操作失败') => {
                        try {
                            const status = e && e.response && e.response.status;
                            if (status === 422) {
                                const detail = e.response && e.response.data && e.response.data.detail;
                                if (Array.isArray(detail)) {
                                    const msg = detail.slice(0, 3).map(d => {
                                        const loc = Array.isArray(d.loc) ? d.loc.join('.') : '';
                                        const m = d.msg || d.message || '';
                                        return (loc ? (loc + ': ') : '') + m;
                                    }).filter(Boolean).join('；');
                                    if (msg) return toastError(msg);
                                }
                            }
                            const msg = (e && e.response && e.response.data && (e.response.data.error || e.response.data.detail)) || (e && e.message) || fallbackTitle;
                            return toastError(String(msg));
                        } catch (e2) { }
                    };

                    const saveLandingSettings = async () => {
                        saveLoading.value = true;
                        try {
                            serializeMarketingOptions();
                            const payload = __normalizeLinkPayload();
                            if (!payload) return;
                            await axios.post('/api/link', payload);
                            toastSuccess('保存成功');
                            try {
                                if (landingLink.value && typeof landingLink.value === 'object') {
                                    landingLink.value.slug = String(linkForm.slug || '');
                                    landingLink.value.domain_id = linkForm.domain_id;
                                    landingLink.value.targets = String(linkForm.targets || '').split('\n').map(x => String(x || '').trim()).filter(Boolean);
                                }
                            } catch (e) { }
                            try { await loadLinks(page.value || 1); } catch (e) { }
                        } catch (e) {
                            __toastAxiosError(e, '保存失败');
                        } finally {
                            saveLoading.value = false;
                        }
                    };

                    const saveAndPreviewLanding = async () => {
                        await saveLandingSettings();
                        previewLanding();
                    };

                    const openLinkModal = (l = null) => {
                        editMode.value = !!l;
                        linkAdvancedOpen.value = !simpleMode.value;
                        if (l) {
                            linkForm.slug = l.slug; linkForm.targets = l.targets.join('\n'); linkForm.domain_id = l.domain_id; linkForm.remark = l.remark;
                            linkForm.use_jump_page = l.use_jump_page || false;
                            linkForm.landing_mode = normalizeMode(l.landing_mode || 'both');
                            linkForm.pixel_id = l.pixel_id || '';
                            linkForm.pixel_event_click = l.pixel_event_click || 'Lead';
                            linkForm.pixel_event_auto = l.pixel_event_auto || 'ViewContent';
                            linkForm.tiktok_access_token = l.tiktok_access_token || '';
                            linkForm.tiktok_test_event_code = l.tiktok_test_event_code || '';
                            linkForm.marketing_options = l.marketing_options || '';
                            loadMarketingOptionsFromJson(linkForm.marketing_options);
                            linkForm.media_url = l.media_url || '';
                            linkForm.btn_text = l.btn_text || '';
                            linkForm.safe_url = l.safe_url || '';
                            linkForm.auto_jump = l.auto_jump || 0;
                            linkForm.country_filter_list = l.country_filter_list || '';
                            linkForm.country_filter_allow = !!l.country_filter_allow;
                            linkForm.device_filter_list = l.device_filter_list || '';
                            linkForm.device_filter_allow = !!l.device_filter_allow;
                        } else {
                            linkForm.slug = ''; linkForm.targets = ''; linkForm.domain_id = null; linkForm.remark = '';
                            linkForm.use_jump_page = false; linkForm.landing_mode = 'both'; linkForm.pixel_id = ''; linkForm.pixel_event_click = 'Lead'; linkForm.pixel_event_auto = 'ViewContent'; linkForm.tiktok_access_token = ''; linkForm.tiktok_test_event_code = ''; linkForm.marketing_options = ''; linkForm.media_url = ''; linkForm.btn_text = ''; linkForm.safe_url = ''; linkForm.auto_jump = 0; linkForm.country_filter_list = ''; linkForm.country_filter_allow = false; linkForm.device_filter_list = ''; linkForm.device_filter_allow = false;
                            loadMarketingOptionsFromJson('');
                        }
                        const m = linkModal || __getModal('linkModal');
                        if (!m) {
                            try { toastError('弹窗未初始化（Bootstrap 未加载或 DOM 未就绪）'); } catch (e) { }
                            return;
                        }
                        linkModal = m;
                        m.show();
                    };
                    const genRandomSlug = () => { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'; let result = ''; for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); linkForm.slug = result; };
                    const smartGenSlug = async () => { if (!linkForm.targets) return toastWarn('请先输入目标网址'); const firstTarget = linkForm.targets.split('\n')[0]; saveLoading.value = true; try { const res = await axios.post('/api/link/smart_gen', { url: firstTarget }); linkForm.slug = res.data.slug; toastSuccess('已生成智能后缀'); } catch { genRandomSlug(); } finally { saveLoading.value = false; } };
                    const saveLink = async () => { saveLoading.value = true; try { serializeMarketingOptions(); const payload = __normalizeLinkPayload(); if (!payload) return; await axios.post('/api/link', payload); linkModal.hide(); toastSuccess('保存成功'); await loadLinks(page.value || 1); } catch (e) { __toastAxiosError(e, '保存失败'); } finally { saveLoading.value = false; } };
                    const deleteLink = async (id) => {
                        if (!(await confirmDanger('删除短链?', '删除后无法恢复', '删除'))) return;
                        try {
                            await axios.post('/api/delete', { id: id });
                            toastSuccess('已删除');
                            await loadLinks(page.value || 1);
                        } catch (e) {
                            __toastAxiosError(e, '删除失败');
                        }
                    };
                    const copyLink = (slug, dom) => { const host = dom || window.location.host; const url = window.location.protocol + '//' + host + '/' + slug; writeClipboard(url); };
                    const copyText = (txt) => writeClipboard(String(txt || ''));
                    let __qrSeq = 0;
                    let __qrTimeoutTimer = null;
                    let __qrRetryTimer = null;
                    let __qrObjectUrl = '';
                    const __revokeQrObjectUrl = () => {
                        try {
                            if (__qrObjectUrl) {
                                URL.revokeObjectURL(__qrObjectUrl);
                                __qrObjectUrl = '';
                            }
                        } catch (e) { }
                    };
                    const __qrBuildUrl = (url, bust) => {
                        const u = '/api/qr?data=' + encodeURIComponent(String(url || ''));
                        return bust ? (u + '&_ts=' + Date.now()) : u;
                    };
                    const openQr = async (slug, dom) => {
                        const s = String(slug || '').trim();
                        if (!s) return;
                        const host = (dom || window.location.host);
                        const url = window.location.protocol + '//' + host + '/' + s;
                        qrUrl.value = url;
                        qrLoading.value = true;
                        qrError.value = '';
                        const seq = ++__qrSeq;
                        try { if (__qrTimeoutTimer) { clearTimeout(__qrTimeoutTimer); __qrTimeoutTimer = null; } } catch (e) { }
                        try { if (__qrRetryTimer) { clearTimeout(__qrRetryTimer); __qrRetryTimer = null; } } catch (e) { }
                        try { __revokeQrObjectUrl(); } catch (e) { }
                        qrImgSrc.value = '';

                        const m = qrModal || __getModal('qrModal');
                        if (!m) {
                            qrLoading.value = false;
                            try { toastError('二维码弹窗未初始化（Bootstrap 未加载或 DOM 未就绪）'); } catch (e) { }
                            return;
                        }
                        qrModal = m;
                        try { qrModal.show(); } catch (e) { }

                        const __fetchQrBlob = async (apiUrl, timeoutMs) => {
                            const controller = (window.AbortController ? new AbortController() : null);
                            const tid = setTimeout(() => { try { controller && controller.abort(); } catch (e) { } }, Number(timeoutMs || 10000) || 10000);
                            try {
                                const r = await fetch(apiUrl, { method: 'GET', cache: 'no-store', signal: controller ? controller.signal : undefined });
                                if (!(r && r.ok)) {
                                    const st = r ? r.status : 0;
                                    throw new Error('HTTP ' + String(st || 0));
                                }
                                return await r.blob();
                            } finally {
                                try { clearTimeout(tid); } catch (e) { }
                            }
                        };

                        try {
                            const apiUrl1 = __qrBuildUrl(url, false);
                            const blob1 = await __fetchQrBlob(apiUrl1, 10000);
                            if (seq !== __qrSeq) return;
                            __qrObjectUrl = URL.createObjectURL(blob1);
                            qrImgSrc.value = __qrObjectUrl;
                            qrLoading.value = false;
                            qrError.value = '';
                        } catch (e) {
                            if (seq !== __qrSeq) return;
                            qrError.value = '二维码生成较慢，正在重试...';
                            try {
                                const apiUrl2 = __qrBuildUrl(url, true);
                                const blob2 = await __fetchQrBlob(apiUrl2, 12000);
                                if (seq !== __qrSeq) return;
                                __qrObjectUrl = URL.createObjectURL(blob2);
                                qrImgSrc.value = __qrObjectUrl;
                                qrLoading.value = false;
                                qrError.value = '';
                            } catch (e2) {
                                if (seq !== __qrSeq) return;
                                qrLoading.value = false;
                                qrError.value = '二维码生成失败：' + String((e2 && e2.message) || (e && e.message) || '请检查后端 /api/qr');
                            }
                        }
                    };
                    const onQrLoad = () => {
                        try { if (__qrTimeoutTimer) { clearTimeout(__qrTimeoutTimer); __qrTimeoutTimer = null; } } catch (e) { }
                        try { if (__qrRetryTimer) { clearTimeout(__qrRetryTimer); __qrRetryTimer = null; } } catch (e) { }
                        qrLoading.value = false;
                        qrError.value = '';
                    };
                    const onQrError = () => {
                        try { if (__qrTimeoutTimer) { clearTimeout(__qrTimeoutTimer); __qrTimeoutTimer = null; } } catch (e) { }
                        try { if (__qrRetryTimer) { clearTimeout(__qrRetryTimer); __qrRetryTimer = null; } } catch (e) { }
                        qrLoading.value = false;
                        qrError.value = '二维码生成失败：请确认后端已安装 qrcode 依赖并已重启。';
                    };
                    const copyCode = (c) => writeClipboard(String(c || ''));
                    const generateInvites = async () => {
                        invLoading.value = true;
                        try {
                            const params = {
                                limit: Number(invForm.limit || 0),
                                count: Number(invForm.count || 1),
                                days: Number(invForm.valid_days || 30),
                                product_id: Number(invForm.product_id || 0),
                                pack_days: Number(invForm.pack_days || 0),
                            };
                            const res = await axios.post('/api/admin/gen_invite', null, { params });
                            newCodes.value = res.data.codes;
                            toastSuccess('生成成功');
                            await loadInvites();
                        } finally { invLoading.value = false; }
                    };
                    const updateProfile = async () => { saveLoading.value = true; try { const payload = { username: profileForm.username, new_password: profileForm.new_password, current_password: profileForm.current_password }; const res = await axios.post('/api/auth/profile', payload); if (res.data.status === 'ok') { toastSuccess('修改成功'); if (res.data.relogin) { setTimeout(() => logout(), 1500); } else { if (profileForm.username && user.value && typeof user.value === 'object') user.value.username = profileForm.username; profileForm.current_password = ''; profileForm.new_password = ''; } } } catch (e) { try { const msg = (e && e.response && e.response.data && e.response.data.error) || (e && e.message) || '修改失败'; toastError(msg); } catch (_) { } } finally { saveLoading.value = false; } };

                    const openRedeemModal = () => {
                        redeemForm.code = '';
                        redeemResult.value = null;
                        redeemModal && redeemModal.show();
                    };
                    const redeemCode = async () => {
                        const code = String(redeemForm.code || '').trim();
                        if (!code) return toastWarn('请输入兑换码');
                        redeemLoading.value = true;
                        redeemResult.value = null;
                        try {
                            const r = await axios.post('/api/user/redeem', { code });
                            if (r.data && r.data.status === 'ok' && r.data.user) {
                                user.value = r.data.user;
                            } else {
                                await checkAuth();
                            }
                            redeemResult.value = { type: 'success', msg: '兑换成功' };
                            toastSuccess('兑换成功');
                            setTimeout(() => { redeemModal && redeemModal.hide(); }, 900);
                        } catch (e) {
                            redeemResult.value = { type: 'error', msg: (e.response && e.response.data && e.response.data.error) || '兑换失败' };
                            try { toastError(redeemResult.value.msg); } catch (e2) { }
                        } finally {
                            redeemLoading.value = false;
                        }
                    };
                    const showStats = (l) => { currentStatsSlug.value = l.slug; currentStatsId.value = l.id; statsRange.value = '24h'; loadStatsData(); statsModal.show(); };
                    const changeStatsRange = (range) => { statsRange.value = range; loadStatsData(); };
                    const clearStatsPrompt = async (id_or_null) => {
                        const lid = Number(id_or_null || currentStatsId.value || 0);
                        if (!lid) return;

                        let refItems = [];
                        try {
                            const rr = await axios.get('/api/link/referrers_v2', { params: { link_id: lid, range: 'all' }, timeout: 20000, silent: true, __silent: true });
                            refItems = (rr && rr.data && Array.isArray(rr.data.items)) ? rr.data.items : [];
                        } catch (e) {
                            refItems = [];
                        }
                        if (!refItems.length) {
                            refItems = [
                                { key: '__all__', label: '全部来源', count: 0 },
                                { key: 'Direct', label: 'Direct（直接访问）', count: 0 },
                            ];
                        }

                        const makeRefOptionsHtml = () => {
                            try {
                                const parts = [];
                                for (const it of refItems) {
                                    const key = String(it.key || '');
                                    const label = String(it.label || key);
                                    const count = Number(it.count || 0) || 0;
                                    const tag = count > 0 ? `<span class="badge rounded-pill text-bg-light border ms-auto">${count}</span>` : `<span class="badge rounded-pill text-bg-light border ms-auto">0</span>`;
                                    parts.push(`<option value="${key.replace(/"/g, '&quot;')}">${label} (${count})</option>`);
                                }
                                return parts.join('');
                            } catch (e) {
                                return '<option value="__all__">全部来源</option>';
                            }
                        };

                        const html = `
                <div style="text-align:left">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                    <div style="width:38px;height:38px;border-radius:12px;background:rgba(59,130,246,.12);display:flex;align-items:center;justify-content:center;">
                      <i class="bi bi-eraser" style="font-size:18px;color:#3b82f6"></i>
                    </div>
                    <div>
                      <div style="font-weight:800;font-size:15px;line-height:1.2;">选择要删除的数据范围</div>
                      <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">支持按时间 + 按来源网站精准删除</div>
                    </div>
                  </div>

                  <div style="background:var(--hover-bg);border:1px solid var(--border-color);border-radius:14px;padding:12px;">
                    <div style="font-weight:700;font-size:13px;margin-bottom:6px;">时间范围</div>
                    <select id="clr_range" class="form-select" style="border-radius:12px;">
                      <option value="1h">最近1小时</option>
                      <option value="24h" selected>最近24小时</option>
                      <option value="all">所有数据</option>
                    </select>
                    <div style="height:10px"></div>
                    <div style="font-weight:700;font-size:13px;margin-bottom:6px;">来源网站（Referrer）</div>
                    <select id="clr_ref" class="form-select" style="border-radius:12px;">
                      ${makeRefOptionsHtml()}
                    </select>
                    <div style="margin-top:10px;font-size:12px;color:var(--text-muted);line-height:1.35;">
                      提示：选择“全部来源”会按所选时间范围清理；选择某个网站只会删除该网站带来的访问记录。
                    </div>
                  </div>
                </div>
            `;

                        const result = await Swal.fire({
                            title: '清理数据',
                            html,
                            focusConfirm: false,
                            showCancelButton: true,
                            confirmButtonText: '确认删除',
                            cancelButtonText: '取消',
                            confirmButtonColor: '#ef4444',
                            customClass: {
                                popup: 'shadow-lg',
                                confirmButton: 'px-4',
                                cancelButton: 'px-4'
                            },
                            preConfirm: () => {
                                const r = document.getElementById('clr_range');
                                const f = document.getElementById('clr_ref');
                                return {
                                    range: r ? String(r.value || '') : '24h',
                                    referrer: f ? String(f.value || '') : '__all__',
                                };
                            }
                        });

                        if (!result.isConfirmed) return;
                        const sel = (result && result.value) ? result.value : null;
                        const range = sel ? String(sel.range || '24h') : '24h';
                        const referrer = sel ? String(sel.referrer || '__all__') : '__all__';

                        try {
                            if (referrer && referrer !== '__all__') {
                                await axios.post('/api/link/clear_stats_by_referrer_v2', { link_id: lid, range, referrer });
                            } else {
                                await axios.post('/api/link/clear_stats_v2', { link_id: lid, range });
                            }
                            toastSuccess('清理完成');
                            try {
                                if (!id_or_null) loadStatsData();
                                else loadLinks(page.value || 1);
                            } catch (e) { }
                        } catch (e) {
                            __toastAxiosError(e, '清理失败');
                        }
                    };
                    let __statsReqSeq = 0;
                    const loadStatsData = async () => {
                        const seq = ++__statsReqSeq;
                        const range = String(statsRange.value || '24h');
                        const id = Number(currentStatsId.value || 0);
                        const slug = String(currentStatsSlug.value || '');
                        const apply = (d) => {
                            if (seq !== __statsReqSeq) return;
                            const obj = (d && typeof d === 'object') ? d : {};
                            statsData.pv = Number(obj.pv || 0);
                            statsData.uv = Number(obj.uv || 0);
                            statsData.geo = (obj.geo && typeof obj.geo === 'object') ? obj.geo : {};
                            statsData.os = (obj.os && typeof obj.os === 'object') ? obj.os : {};
                            statsData.source = (obj.source && typeof obj.source === 'object') ? obj.source : {};
                            try { renderCharts(obj); } catch (e) { }
                        };

                        let d = null;
                        try {
                            if (id > 0) {
                                d = (await axios.get(`/api/stats_id/${id}?range=${encodeURIComponent(range)}`)).data;
                            }
                        } catch (e) {
                            d = null;
                        }

                        if (!d) {
                            try {
                                d = (await axios.get(`/api/stats/${encodeURIComponent(slug)}?range=${encodeURIComponent(range)}`)).data;
                            } catch (e2) {
                                d = null;
                            }
                        }

                        if (!d) {
                            apply({ pv: 0, uv: 0, trend: {}, geo: {}, os: {}, source: {} });
                            return;
                        }
                        apply(d);
                    };
                    const renderCharts = (d) => {
                        if (!window.echarts || !d) return;
                        const trendMap = (d.trend && typeof d.trend === 'object') ? d.trend : {};
                        const geoMap = (d.geo && typeof d.geo === 'object') ? d.geo : {};
                        const osMap = (d.os && typeof d.os === 'object') ? d.os : {};
                        const sourceMap = (d.source && typeof d.source === 'object') ? d.source : {};
                        const textColor = isDark.value ? '#e0e0e0' : '#212529';
                        const pieColors = isDark.value ? ['#60a5fa', '#34d399', '#fbbf24', '#f87171', '#a78bfa', '#22c55e', '#38bdf8', '#fb7185'] : ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#22c55e', '#0ea5e9', '#f97316'];
                        const createPie = (id, title, dataMap) => {
                            try {
                                const el = document.getElementById(id);
                                if (!el) return;
                                if (chartInstances[id]) chartInstances[id].dispose();
                                const chart = echarts.init(el, isDark.value ? 'dark' : null);
                                chartInstances[id] = chart;
                                const safeMap = (dataMap && typeof dataMap === 'object') ? dataMap : {};
                                const data = Object.keys(safeMap).map(k => ({ value: safeMap[k], name: k }));
                                chart.setOption({
                                    backgroundColor: 'transparent',
                                    tooltip: { trigger: 'item' },
                                    color: pieColors,
                                    legend: { bottom: '0%', left: 'center', itemWidth: 10, itemHeight: 10, textStyle: { color: textColor } },
                                    series: [{
                                        name: title, type: 'pie', radius: ['40%', '70%'], center: ['50%', '45%'], avoidLabelOverlap: false,
                                        itemStyle: { borderRadius: 10, borderColor: isDark.value ? '#111827' : '#ffffff', borderWidth: 3, shadowBlur: 14, shadowOffsetY: 6, shadowColor: isDark.value ? 'rgba(0,0,0,0.55)' : 'rgba(0,0,0,0.20)' },
                                        label: { show: false, position: 'center' },
                                        emphasis: { scale: true, scaleSize: 8, label: { show: true, fontSize: 16, fontWeight: 'bold', color: textColor }, itemStyle: { shadowBlur: 24, shadowOffsetY: 10, shadowColor: isDark.value ? 'rgba(0,0,0,0.70)' : 'rgba(0,0,0,0.28)' } },
                                        data: data
                                    }]
                                });
                            } catch (e) { }
                        };
                        try {
                            const trendEl = document.getElementById('trendChart');
                            if (trendEl) {
                                if (trendChart) trendChart.dispose();
                                trendChart = echarts.init(trendEl, isDark.value ? 'dark' : null);
                                const __trendEntries = Object.entries(trendMap || {}).map(([k, v]) => ({
                                    k: String(k || ''),
                                    v: Number(v || 0) || 0,
                                }));
                                __trendEntries.sort((a, b) => {
                                    const ta = Date.parse(a.k.replace(' ', 'T')) || 0;
                                    const tb = Date.parse(b.k.replace(' ', 'T')) || 0;
                                    if (ta && tb) return ta - tb;
                                    return a.k.localeCompare(b.k);
                                });
                                const __trendXAxis = __trendEntries.map(x => x.k);
                                const __trendSeries = __trendEntries.map(x => x.v);
                                trendChart.setOption({
                                    backgroundColor: 'transparent',
                                    tooltip: {
                                        trigger: 'axis',
                                        formatter: (params) => {
                                            const p = (Array.isArray(params) && params.length) ? params[0] : null;
                                            const b = p ? String(p.name || '') : '';
                                            const c = p ? (Number(p.data || 0) || 0) : 0;
                                            return `${b}<br />访问: ${c}`;
                                        }
                                    },
                                    grid: { left: '3%', right: '4%', bottom: '15%', top: '10%', containLabel: true },
                                    xAxis: {
                                        type: 'category',
                                        data: __trendXAxis,
                                        axisLine: { lineStyle: { color: textColor } },
                                        axisLabel: {
                                            color: textColor,
                                            formatter: (v) => {
                                                const s = String(v || '');
                                                if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}$/.test(s)) return s.slice(5);
                                                if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s.slice(5);
                                                return s;
                                            }
                                        }
                                    },
                                    yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: isDark.value ? '#444' : '#e5e5e5' } }, axisLabel: { color: textColor } },
                                    dataZoom: [{ type: 'slider', show: true, bottom: 5, start: 0, end: 100, height: 20 }, { type: 'inside', start: 0, end: 100 }],
                                    series: [{
                                        data: __trendSeries, type: 'bar',
                                        itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: '#3b82f6' }, { offset: 1, color: '#60a5fa' }]) },
                                        barMaxWidth: 40,
                                        showBackground: true,
                                        backgroundStyle: { color: isDark.value ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
                                    }]
                                });
                            }
                        } catch (e) { }
                        createPie('osChart', '操作系统', osMap);
                        createPie('sourceChart', '流量来源', sourceMap);
                        try {
                            const mapEl = document.getElementById('mapChart');
                            if (!mapEl) return;
                            if (!window.echarts || !window.echarts.getMap || !window.echarts.getMap('world')) return;
                            if (mapChart) mapChart.dispose();
                            mapChart = echarts.init(mapEl, isDark.value ? 'dark' : null);
                            const mapData = Object.keys(geoMap).map(code => ({ name: __worldNameByCode(code), value: geoMap[code], labelName: countryMap[code] || code }));
                            const maxV = Math.max(10, ...Object.values(geoMap).map(v => Number(v || 0) || 0));
                            const mapPalette = isDark.value
                                ? ['#0f172a', '#0ea5e9', '#22d3ee', '#38bdf8', '#60a5fa', '#a855f7']
                                : ['#e0f2fe', '#bae6fd', '#7dd3fc', '#38bdf8', '#22d3ee', '#7c3aed'];
                            const areaColor = isDark.value ? '#0b1220' : '#f8fafc';
                            const borderColor = isDark.value ? 'rgba(255,255,255,.16)' : 'rgba(0,0,0,.12)';
                            const hoverArea = isDark.value ? '#22d3ee' : '#22c55e';
                            mapChart.setOption({
                                backgroundColor: 'transparent',
                                tooltip: {
                                    trigger: 'item',
                                    backgroundColor: isDark.value ? 'rgba(15,23,42,.92)' : 'rgba(255,255,255,.96)',
                                    borderColor: isDark.value ? 'rgba(255,255,255,.14)' : 'rgba(0,0,0,.10)',
                                    borderWidth: 1,
                                    textStyle: { color: isDark.value ? '#e5e7eb' : '#111827' },
                                    formatter: (p) => p.data ? `${p.data.labelName || p.name}: ${p.value || 0} ?` : (p.name ? `${p.name}: 0 ?` : '')
                                },
                                visualMap: {
                                    min: 0,
                                    max: maxV,
                                    left: 14,
                                    bottom: 14,
                                    text: ['?', '?'],
                                    calculable: true,
                                    itemWidth: 12,
                                    itemHeight: 90,
                                    orient: 'vertical',
                                    inRange: { color: mapPalette },
                                    textStyle: { color: textColor },
                                    backgroundColor: 'transparent'
                                },
                                geo: {
                                    map: 'world',
                                    roam: true,
                                    zoom: 1.12,
                                    scaleLimit: { min: 0.9, max: 6 },
                                    itemStyle: {
                                        areaColor: areaColor,
                                        borderColor: borderColor,
                                        borderWidth: 0.8,
                                        shadowColor: isDark.value ? 'rgba(34,211,238,.25)' : 'rgba(59,130,246,.25)',
                                        shadowBlur: 22
                                    },
                                    emphasis: {
                                        label: { show: false },
                                        itemStyle: {
                                            areaColor: hoverArea,
                                            shadowColor: hoverArea,
                                            shadowBlur: 28
                                        }
                                    }
                                },
                                series: [{
                                    type: 'map',
                                    geoIndex: 0,
                                    data: mapData
                                }]
                            });
                        } catch (e) { }
                    };

                    // 窗口大小改变时重绘图表
                    window.addEventListener('resize', () => {
                        trendChart && trendChart.resize();
                        chartInstances['osChart'] && chartInstances['osChart'].resize();
                        chartInstances['sourceChart'] && chartInstances['sourceChart'].resize();
                        mapChart && mapChart.resize();
                    });

                    return { user, safeUser, initLoading, authMode, setAuthMode, authForm, captchaQ, authLoading, handleAuth, logout, currentTab, currentTabName, links, displayedLinks, loadingLinks, isAutoRefreshing, page, totalPages, totalCount, pageSize, searchQuery, debounceSearch, filterType, sortBy, loadLinks, linkForm, editMode, openLinkModal, saveLink, saveLoading, deleteLink, copyLink, copyByMode, buildUrl, modeLabel, selectedIds, isAllSelected, toggleSelectAll, clearSelection, bulkCopyPrompt, bulkDeleteSelected, inviteSubTab, invForm, invLoading, generateInvites, newCodes, statsData, showStats, domain, viewMode, switchView, statsRange, changeStatsRange, profileForm, updateProfile, domainList, newDomain, newDomainPublic, domainLoading, addDomain, deleteDomain, toggleDomainPublic, loadDomains, userList, usersLoading, safeUserList, userForm, editUser, saveUser, deleteUser, genRandomSlug, smartGenSlug, inviteList, safeInviteList, inviteUsedByText, copyCode, loadInvites, loadUsers, openUserDomainModal, selectedDomains, allPrivateDomains, saveUserDomains, clearStatsPrompt, currentStatsSlug, currentStatsId, isDark, autoTheme, toggleTheme, enableAutoTheme, performUpdate, updateBackend, isUpdating, updateStatus, sidebarOpen, inviteStatus, deleteInvite, redeemForm, redeemLoading, redeemResult, openRedeemModal, redeemCode, productList, productForm, productLoading, editProduct, saveProduct, deleteProduct, toggleProductEnabled, resetProductForm, paymentForm, paymentQrUrl, applyPaymentTemplate, paymentLoading, loadProducts, loadPaymentSettings, savePaymentSettings, purchaseLoading, purchaseInfo, purchasePaymentQr, purchasePaymentText, loadPurchaseInfo, quotaProducts, daysProducts, refreshCaptcha, countryMap, countryFilterSelected, countryFilterSearch, countryFilterAllCodes, countryFilterShownCodes, countryFilterToggle, countryFilterSelectAll, countryFilterSelectNone, countryFilterInvert, deviceFilterAllCodes, deviceFilterSelected, deviceFilterToggle, deviceFilterSelectAll, deviceFilterSelectNone, deviceFilterInvert, marketingOptionItems, addMarketingOption, removeMarketingOption, moveMarketingOption, ensureMarketingKey, ensureOptionTrailingEmpty, addMarketingOptionAnswer, removeMarketingOptionAnswer, landingLink, openLandingSettings, openLandingFromModal, backFromLanding, previewLanding, saveLandingSettings, saveAndPreviewLanding, qrUrl, qrImgSrc, qrLoading, qrError, openQr, renderCharts, linkAdvancedOpen, landingAdvancedOpen, simpleMode, adminMenuOpen, advancedFilterOpen, advFilters, hasActiveAdvancedFilters, activeFilterCount, clearAdvancedFilters, applyFilterPreset, applyAdvancedFilters, bulkRemarkText, bulkRemarkSaving, openBulkEditRemark, saveBulkRemark, handleTouchStart, handleTouchMove, handleTouchEnd };
                }
            });

            app.config.errorHandler = function (err, instance, info) {
                try { hideStaticLoader(); } catch (e) { }
                try {
                    const msg = (err && err.message) ? err.message : String(err || 'Unknown error');
                    const stack = (err && err.stack) ? err.stack : '';
                    let loc = '';
                    let locLine = 0;
                    let locCol = 0;
                    try {
                        const s = String(stack || '');
                        const m = s.match(/<anonymous>:\d+:\d+|admin:\d+:\d+|app_v2\.html:\d+:\d+/);
                        loc = m ? m[0] : '';
                        const m2 = s.match(/<anonymous>:(\d+):(\d+)/);
                        if (m2) {
                            locLine = parseInt(m2[1] || '0', 10) || 0;
                            locCol = parseInt(m2[2] || '0', 10) || 0;
                        }
                    } catch (e) { }

                    let renderHint = '';
                    let renderAtLoc = '';
                    let usernameSites = '';
                    try {
                        const internal = (instance && instance.$) ? instance.$ : instance;
                        const renderFn = (internal && internal.type && internal.type.render) ? internal.type.render : null;
                        const src = renderFn ? String(renderFn) : '';
                        const idx = src.indexOf('username');
                        if (idx >= 0) {
                            const start = Math.max(0, idx - 200);
                            const end = Math.min(src.length, idx + 300);
                            renderHint = src.slice(start, end);
                        }

                        if (locLine > 0 && src) {
                            const lines = src.split('\n');
                            if (lines.length > 1 && locLine <= lines.length) {
                                const startL = Math.max(1, locLine - 3);
                                const endL = Math.min(lines.length, locLine + 3);
                                const out = [];
                                for (let ln = startL; ln <= endL; ln++) {
                                    const prefix = (ln === locLine) ? '>> ' : '   ';
                                    out.push(prefix + String(ln).padStart(5, ' ') + ': ' + lines[ln - 1]);
                                }
                                renderAtLoc = out.join('\n');
                            }
                        }

                        if (src) {
                            const snippets = [];
                            const re = /\.username\b/g;
                            let m3;
                            let guard = 0;
                            while ((m3 = re.exec(src)) && guard < 20) {
                                guard++;
                                const pos = m3.index;
                                const start = Math.max(0, pos - 80);
                                const end = Math.min(src.length, pos + 80);
                                snippets.push(`[${guard}] ...${src.slice(start, end)}...`);
                            }
                            if (snippets.length) {
                                usernameSites = snippets.join('\n\n');
                            }
                        }
                    } catch (e) { }

                    const title = (msg + (loc ? ('\n' + loc) : '') + (info ? ('\n' + info) : ''));
                    const detail = (stack || '')
                        + (renderAtLoc ? ('\n\nRENDER_AT_LOC:\n' + renderAtLoc + (locCol ? ('\n(col=' + String(locCol) + ')') : '')) : '')
                        + (renderHint ? ('\n\nRENDER_SNIPPET:\n' + renderHint) : '');
                    const detail2 = detail + (usernameSites ? ('\n\nUSERNAME_SITES_IN_RENDER:\n' + usernameSites) : '');
                    showFatalOverlay(title, detail2);
                } catch (e) { }
            };

            app.mount('#app');
        };

        if (window.__LIBS_READY__ && !window.__APP_BOOTED__) {
            window.__APP_BOOTED__ = true;
            try { window.__BOOT_APP__(); } catch (e) { console.error(e); }
        } else {
            window.addEventListener('libs-ready', function () {
                if (window.__APP_BOOTED__) return;
                window.__APP_BOOTED__ = true;
                try { window.__BOOT_APP__(); } catch (e) { console.error(e); }
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        onerror="this.onerror=null;this.src='https://cdn.staticfile.org/bootstrap/5.3.0/js/bootstrap.bundle.min.js'"></script>
</body>

</html>